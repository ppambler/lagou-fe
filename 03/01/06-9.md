### âœï¸ Tangxt â³ 2021-09-04 ğŸ·ï¸ Vue

# 06-9-èº«ä»½è®¤è¯-å¤„ç† Token è¿‡æœŸ-å®ç°åŸºæœ¬æµç¨‹é€»è¾‘ã€å…³äºå¤šæ¬¡è¯·æ±‚çš„é—®é¢˜ã€è§£å†³å¤šæ¬¡è¯·æ±‚åˆ·æ–° Token é—®é¢˜ã€è§£å†³å¤šæ¬¡è¯·æ±‚å…¶å®ƒæ¥å£é‡è¯•çš„é—®é¢˜

## â˜…å®ç°åŸºæœ¬æµç¨‹é€»è¾‘

å•ç‹¬é’ˆå¯¹è¿™ä¸ª`401`æäº‹æƒ…

`401` -> æˆæƒå¤±è´¥ -> é‡æ–°ç™»å½•è·å–æ–°çš„`token`

æäº‹æƒ…çš„åŸºæœ¬æµç¨‹ï¼ˆä¼ªä»£ç ï¼‰ï¼š

1. æ²¡æœ‰`refresh_token`ï¼ˆæ„å‘³ç€æ²¡æœ‰ç™»å½•ç”¨æˆ·ï¼‰ -> ç›´æ¥è·³åˆ°ç™»å½•é¡µé‡æ–°ç™»å½•
2. æœ‰`refresh_token`
   1. å‘è¯·æ±‚è·å–æ–°`token`å¤±è´¥äº† -> é‡æ–°ç™»å½•
   2. æˆåŠŸäº† -> å¸¦ç€æ–°çš„`token`é‡æ–°å‘è¯·æ±‚

ğŸ’¡ï¼šåœ¨`request.ts`é‡Œè¾¹è¿™æ ·ï¼š`import router from '@/router'`ï¼Œæ˜¯åœ¨å¹²å˜›å‘¢ï¼Ÿ

æˆ‘ä»¬éœ€è¦ä½¿ç”¨è·¯ç”±é‡æ–°è·³è½¬åˆ°ç™»å½•é¡µï¼Œè€Œè¯¥æ–‡ä»¶æ˜¯æ²¡æœ‰ç»„ä»¶å®ä¾‹çš„ï¼Œæ‰€æœ‰æˆ‘ä»¬éœ€è¦å•ç‹¬åŠ è½½ä¸€ä¸ªè·¯ç”±å®ä¾‹

è¿™ä¸ª`router`è·Ÿæˆ‘ä»¬åœ¨ç»„ä»¶ä¸­æ‰€ä½¿ç”¨çš„`this.$router`å®é™…ä¸Šæ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼Œéƒ½æ˜¯è¿™ä¸ª`router`æ–‡ä»¶é‡Œè¾¹åˆ›å»ºçš„è·¯ç”±å®ä¾‹`new VueRouter({})`

![router è·³è½¬](assets/img/2021-09-05-14-32-31.png)

ğŸ’¡ï¼šè¯·æ±‚`/front/user/refresh_token`è¿™ä¸ªæ¥å£ï¼Ÿ

æ•°æ®æ€ä¹ˆä¼ ï¼Ÿ -> `x-www-form-urlencoded` -> åœ¨è¯·æ±‚ä½“é‡Œè¾¹ -> éœ€è¦ç”¨åˆ°`qs`

`refresh_token`å¯èƒ½ä¼šè¿‡æœŸæˆ–æ— æ•ˆï¼Œæ„å‘³ç€è¯¥è¯·æ±‚ä¹Ÿæœ‰å¯èƒ½è¿”å›`401`

![è¯·æ±‚æ¥å£](assets/img/2021-09-05-14-39-31.png)

æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„`axios`å®ä¾‹ï¼Œè¯¥å®ä¾‹ä¸æ˜¯ä¹‹å‰ç»‘å®šäº†å“åº”æ‹¦æˆªå™¨çš„`request`å®ä¾‹ï¼Œæ‰€ä»¥ä½ ç”¨æ–°çš„`axios`å®ä¾‹å»å‘æ˜¯ä¸ä¼šèµ°å“åº”æ‹¦æˆªå™¨çš„

å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä¸ç”¨è¿™æ ·æï¼Œå¯ä»¥è‡ªå·±åœ¨`401`è¿™ä¸ªé€»è¾‘åšä¸ªåˆ¤æ–­â€¦â€¦

æ³¨æ„ï¼šå“åº”è¶…å‡º `2xx`ï¼Œ`axios`å®ä¾‹é»˜è®¤ä¼šæŠ¥é”™ï¼Œå½“ç„¶ï¼Œä½ å¯ä»¥é…ç½®ä¸€ä¸‹`validateStatus`

![é”™è¯¯å¤„ç†](assets/img/2021-09-05-15-13-34.png)

â¹ï¼š[javascript - Axios handling errors - Stack Overflow](https://stackoverflow.com/questions/49967779/axios-handling-errors)

ğŸ’¡ï¼šè¯·æ±‚`/front/user/refresh_token`è¿™ä¸ªæ¥å£æ‰€æ‹¿åˆ°çš„æ•°æ®ï¼Ÿ

![æ•°æ®](assets/img/2021-09-05-15-48-29.png)

ğŸ’¡ï¼š`axios.create()()`ï¼Ÿ

ç¬¬ä¸€ä¸ª`()`ç»™çš„æ˜¯`axios`å®ä¾‹çš„å…¨å±€é»˜è®¤é…ç½®ï¼ˆè¿”å›äº†ä¸€ä¸ªå‡½æ•°ï¼Œç±»ä¼¼åœ¨å›ºå®šä¸€ä¸ªå‚æ•°ï¼‰ï¼Œè€Œç¬¬äºŒä¸ª`()`æ˜¯è‡ªå®šä¹‰çš„ï¼Œä½ å¯ä»¥åœ¨è¿™å„¿å»ä¼ å‘è¯·æ±‚çš„é…ç½®å‚æ•°ï¼ˆè¿”å›çš„æ˜¯ä¸€ä¸ª`Promise`å®ä¾‹ï¼‰

ğŸ’¡ï¼šæ•´ä¸ªæµç¨‹å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼Ÿ

![ä»£ç ](assets/img/2021-09-05-16-38-00.png)

é¡µé¢å®šä½åˆ°`user`è·¯ç”± -> æ›´æ”¹æœ¬åœ°å­˜å‚¨çš„`access_token`ï¼Œè®©è¯¥`token`æ˜¯æ— æ•ˆçš„ -> åˆ·æ–°é¡µé¢ -> é¡µé¢ä¼šå»è·å–ç”¨æˆ·ä¿¡æ¯`getInfo` -> æŠ¥é”™ï¼Œ`401` -> å“åº”æ‹¦æˆªå™¨æ‹¦æˆªåˆ°å®ƒ -> çŸ¥é“å®ƒæ˜¯`401`ï¼š

1. åˆ¤æ–­å…¨å±€`user`æ˜¯ä¸æ˜¯æ ¹æœ¬å°±æ²¡æœ‰ï¼Ÿ -> æ²¡æœ‰æ„å‘³ç€æ²¡æœ‰`refresh_token` -> é‡æ–°ç™»å½•å°±å®Œäº‹å„¿äº†
2. æœ‰`refresh_token` -> åˆ›å»ºä¸€ä¸ªæ–°çš„`axios`å®ä¾‹ï¼Œå¸¦ç€è¿™ä¸ªå€¼è¯·æ±‚`/front/user/refresh_token`è¿™ä¸ªæ¥å£
   1. å¦‚æœå“åº”`401`ï¼Œå°±ä¼šè¢«`catch`åˆ°ï¼ŒæŠŠå…¨å±€`user`æ¸…ç©º -> é‡æ–°ç™»å½•å°±å®Œäº‹å„¿äº†
   2. å¦‚æœå“åº”æˆåŠŸï¼Œé‚£å°±æŠŠæ‹¿åˆ°çš„`data.content`èµ‹å€¼ç»™å…¨å±€çš„`user`ï¼Œä½¿ç”¨`request(error.config)`é‡æ–°å‘é€ç¬¬ä¸€æ¬¡`getInfo`çš„è¯·æ±‚å¹¶æŠŠå®ƒçš„è¿”å›å€¼`return`å‡ºå»ï¼Œä¹Ÿå°±æ˜¯äº¤ä¸ªå‘è¯·æ±‚çš„é‚£ä¸ªåœ°æ–¹ï¼ˆ`config`å°±æ˜¯ä½ ç»™`request`ä¼ çš„é‚£äº›é…ç½®ï¼Œå½“ç„¶ï¼Œè¿™ä¸ª`error.config`ä¼šæ›´å…¨ï¼‰ -> ç”±äºæˆ‘ä»¬å¯¹`request`è®¾ç½®äº†è¯·æ±‚æ‹¦æˆªå™¨ï¼Œåœ¨æ‹¦æˆªçš„æ—¶å€™ä¼šé‡æ–°è®¾ç½®`config.headers.Authorization`ï¼Œè¿™æ—¶çš„`user.access_token`æ˜¯æ–°é²œçš„ï¼ˆåˆšåˆšé‡æ–°è·å–çš„ï¼‰

![error å¯¹è±¡](assets/img/2021-09-05-16-15-31.png)

![è¿”å›ç»“æœ](assets/img/2021-09-05-16-25-05.png)

é¢å¯¹`token`åœ¨å¾ˆçŸ­æ—¶é—´å†…å°±è¿‡æœŸçš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç”¨é‡æ–°ç™»å½•ï¼Œå°±èƒ½ä¸€ç›´ä¿æŒç™»å½•çŠ¶æ€äº†ï¼å½“ç„¶ï¼Œ`refresh_token`ä¹Ÿæ˜¯ä¼šæœ‰è¿‡æœŸæ—¶é—´çš„ï¼Œä¸ç„¶ï¼Œå²‚ä¸æ˜¯ä¸€ç›´è‡ªåŠ¨æ›´æ–°çš„æœ¬åœ°çš„`user`ä¿¡æ¯ï¼Ÿ

> è®°ä½ç™»å½•ç”¨æˆ·`10`å¤©ï¼Œæ˜¯ä¸æ˜¯åœ¨è¯´`refresh_token`è¶…è¿‡`10`å¤©å°±è¿‡æœŸäº†å‘¢ï¼Ÿå¯æ˜¯å…¨å±€`user`å¹¶æ²¡æœ‰ä¸€ä¸ªå…³äº`refresh_token`è¿‡æœŸçš„å­—æ®µï¼Œå³ä¾¿æœ‰ï¼Œæˆ‘ä»¬æ¯æ¬¡è¯·æ±‚`refresh_token`éƒ½ä¼šé‡ç½®å®ƒçš„è¿‡æœŸæ—¶é—´å§ï¼å¦‚`access_token`æ˜¯`2`å¤©ï¼Œ`refresh_token`æ˜¯`3`å¤©ï¼Œä¸¤å¤©å·²è¿‡ï¼Œ`access_token`åˆ·æ–°ï¼Œè€Œ`refresh_token`åˆä¼šé‡æ–°åˆ·æ–° -> é¡¹ç›®é‡Œè¾¹å¹¶å’©æœ‰æåˆ°`Cookie`

![token åˆ·æ–°](assets/img/2021-09-05-16-50-57.png)

â¹ï¼š[session ã€cookie å’Œ token ä¸‰è€…çš„å…³ç³»å’ŒåŒºåˆ« Â· Front-end-handbook](https://wuch886.gitbooks.io/front-end-handbook/content/session-cookiehe-token-san-zhe-de-guan-xi-he-qu-bie.html)

â¹ï¼š[cookie,token éªŒè¯çš„åŒºåˆ« - ç®€ä¹¦](https://www.jianshu.com/p/c33f5777c2eb)

â¹ï¼š[ç®€å•èŠä¸€èŠ Cookieã€Sessionã€Tokenã€JWT çš„åŒºåˆ«å’Œä½œç”¨ - SegmentFault æ€å¦](https://segmentfault.com/a/1190000021810849)

ğŸ’¡ï¼šæ— ç—›åˆ·æ–°ï¼Ÿ

åœ¨`token`è¿‡æœŸçš„æƒ…å†µä¸‹ï¼Œé‡æ–°è·å–`token`ï¼ˆå…¶å®æ˜¯é‡æ–°è·å–ç™»å½•ä¿¡æ¯ï¼Œ`/front/user/refresh_token`è¿™ä¸ªæ¥å£æ˜¯åœ¨åˆ©ç”¨`refresh_token`é‡æ–°è·å–ç™»å½•ä¿¡æ¯ï¼‰ -> è¿™ä¸ªè¿‡ç¨‹ç”¨æˆ·æ˜¯æ„ŸçŸ¥ä¸åˆ°çš„ï¼ŒèƒŒåå·å·æ‘¸æ‘¸çš„è‡ªåŠ¨å‘é€äº†è¯·æ±‚ -> æ‰€ä»¥è¿™æ˜¯æ— ç—›çš„

---

ä»¥ä¸Šå°±æ˜¯å¤„ç†`token`è¿‡æœŸçš„ä¸€ä¸ªåŸºæœ¬æµç¨‹ï¼Œä½†è¿™è¿˜ä¸å®Œç¾ï¼Œè¿˜æœ‰ä¸€äº›å°é—®é¢˜ï¼

## â˜…å…³äºå¤šæ¬¡è¯·æ±‚çš„é—®é¢˜

ç›®å‰çš„ä»£ç ï¼šä¸€ä¸ªè¯·æ±‚æ²¡æœ‰é—®é¢˜

ä½†åŒä¸€æ—¶é—´å¦‚æœæœ‰å¤šä¸ªè¯·æ±‚éƒ½`401`ï¼Œé‚£å°±æœ‰é—®é¢˜äº†ï¼ -> è¯·æ±‚åˆ·æ–°å¤šæ¬¡`token`å°±ä¼šæœ‰é—®é¢˜ï¼

ğŸ’¡ï¼šé—®é¢˜å¤ç°

ç›®å‰çš„åº”ç”¨ï¼Œè¯·æ±‚çš„æ¥å£éœ€è¦æˆæƒçš„åªæœ‰ä¸€ä¸ªï¼Œé‚£å°±æ˜¯`getInfo`

å®šä½åˆ°`app-header.vue`ï¼š

![loadUserInfo](assets/img/2021-09-05-19-23-46.png)

æŠŠæœ¬åœ°`access_token`æ”¹æˆé”™çš„ï¼Œåˆ·æ–°é¡µé¢ï¼Œç›´æ¥è·³åˆ°ç™»å½•é¡µå»äº†ï¼š

``` md
http://localhost:8080/#/login?redirect=%2Fuser
```

æ£€æŸ¥ç½‘ç»œè¯·æ±‚æ—¥å¿—ï¼š

![ç½‘ç»œæ—¥å¿—](assets/img/2021-09-05-19-30-53.png)

ä¸ºå•¥ä¼šè¿™æ ·å‘¢ï¼Ÿ

å¯¼è‡´è¿™æ ·çš„é—®é¢˜ï¼š

1. åŒä¸€æ—¶é—´æœ‰å¤šæ¬¡å¹¶å‘è¯·æ±‚ï¼Œåœ¨`token`æ— æ•ˆçš„æƒ…å†µä¸‹ï¼Œä¼šå‡ºç°å¤šæ¬¡åˆ·æ–°`token`çš„æƒ…å†µ
2. å³ä¾¿å‡ºç°å¤šæ¬¡åˆ·æ–°ä¹Ÿæ²¡äº‹ï¼Œå¯é—®é¢˜æ˜¯è¿™å¤±è´¥äº†å‘€ï¼

åŸå› ï¼š`refresh_token`åªèƒ½ä½¿ç”¨ä¸€æ¬¡

ç¬¬ä¸€æ¬¡ç”¨çš„`refresh_token`å‡è®¾ä¸º`123`ï¼Œé‚£è¿™æ˜¯ ok çš„ï¼å¯ç¬¬äºŒæ¬¡ç”¨çš„`refresh_token`è¿˜æ˜¯`123`ï¼Œé‚£å°±ä¸ ok äº†ï¼

![ä¸èƒ½é‡ç”¨`refresh_token`](assets/img/2021-09-05-19-40-32.png)

`/front/user/refresh_token`è¿™ä¸ªæ¥å£æ— è®ºæˆåŠŸä¸å¦ï¼Œéƒ½è¿”å›`200`ï¼Œè¿™æ˜¯é€šè¿‡è‡ªå®šä¹‰å§¿åŠ¿è¿”å›çš„ï¼Œæ‰€ä»¥`try...catch`æ˜¯æ²¡æ³•æ•è·åˆ°`token`åˆ·æ–°å¤±è´¥çš„é—®é¢˜çš„ï¼

![refresh_token å¤±è´¥](assets/img/2021-09-05-19-48-38.png)

æ€»ä¹‹ï¼Œ`/front/user/refresh_token`å¤±è´¥äº†ï¼Œå¹¶å’©æœ‰ä½¿ç”¨æ ‡å‡†çš„ HTTP çŠ¶æ€ç ï¼Œè™½ç„¶å¤–è¡¨æˆåŠŸï¼Œä½†æ•°æ®æ˜¯å¤±è´¥çš„ï¼

## â˜…è§£å†³å¤šæ¬¡è¯·æ±‚åˆ·æ–° Token é—®é¢˜

ğŸ’¡ï¼šæ”¹é€ è¿™ä¸ªä»£ç ï¼Ÿ

![æ”¹é€ ä»£ç ](assets/img/2021-09-05-20-09-31.png)

ä¸ç”¨`try...catch`äº†ï¼Œå› ä¸º`/front/user/refresh_token`è¿™ä¸ªæ¥å£çš„è¯·æ±‚æ— æ³•æ•è·ï¼Œæ¯•ç«Ÿå®ƒä¸ç®¡æˆåŠŸä¸å¦éƒ½æ˜¯å“åº”`200 ok`çš„ï¼

``` js
function refreshToken () {
  return axios.create()({
    method: 'POST',
    url: '/front/user/refresh_token',
    data: qs.stringify({
      // refresh_token åªèƒ½ä½¿ç”¨ 1 æ¬¡
      refreshtoken: store.state.user.refresh_token
    })
  })
}
```

![æ”¹é€ ä»£ç ](assets/img/2021-09-05-20-22-33.png)

ä»£ç æ”¹é€ åï¼Œå…ˆç¡®ä¿åŸå…ˆåªå‘é€ä¸€æ¬¡`getInfo`è¯·æ±‚æ˜¯ ok çš„ï¼Œå†å»æµ‹è¯•åŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚
