### âœï¸ Tangxt â³ 2021-11-17 ğŸ·ï¸ Rollup

# 11-Rollup

1ï¼‰æ¦‚è¿°

rollup åŒæ ·ä¹Ÿæ˜¯ä¸€æ¬¾ ES Modules æ‰“åŒ…å™¨ï¼Œå®ƒä¹Ÿå¯ä»¥å°†é¡¹ç›®å½“ä¸­ä¸€äº›æ•£è½çš„ç»†å°æ¨¡å—æ‰“åŒ…æˆæ•´å—çš„ä»£ç ï¼Œä»è€Œä½¿å¾—åˆ’åˆ†çš„æ¨¡å—å¯ä»¥æ›´å¥½çš„è¿è¡Œåœ¨æµè§ˆå™¨ç¯å¢ƒæˆ–è€…æ˜¯ Node.js ç¯å¢ƒã€‚

ä»ä½œç”¨ä¸Šæ¥çœ‹ï¼Œrollup ä¸ webpack ä½œç”¨éå¸¸ç±»ä¼¼ï¼Œä¸è¿‡ç›¸æ¯”äº webpackï¼Œ rollup æ›´ä¸ºå°å·§ã€‚

å› ä¸º webpack åœ¨å»é…åˆä¸€äº›æ’ä»¶çš„ä½¿ç”¨ä¸‹ï¼Œå‡ ä¹å¯ä»¥å®Œæˆæˆ‘ä»¬å¼€å‘è¿‡ç¨‹ä¸­å‰ç«¯å·¥ç¨‹åŒ–çš„ç»å¤§å¤šæ•°å·¥ä½œï¼Œè€Œ rollup å®ƒä»…ä»…å¯ä»¥è¯´æ˜¯ä¸€æ¬¾ ESM æ‰“åŒ…å™¨ï¼Œå¹¶æ²¡æœ‰ä»»ä½•å…¶ä»–é¢å¤–åŠŸèƒ½ï¼Œä¾‹å¦‚ webpack ä¸­æœ‰å¯¹æˆ‘ä»¬å¼€å‘è€…ååˆ†å‹å¥½çš„ HMRï¼ˆæ¨¡å—çƒ­æ›¿æ¢ï¼‰åŠŸèƒ½ï¼Œè€Œ rollup ä¸­å¹¶ä¸æ”¯æŒç±»ä¼¼ HMR è¿™ç§é«˜çº§ç‰¹æ€§ã€‚

rollup è¯ç”Ÿçš„ç›®çš„å¹¶ä¸æ˜¯è¦ä¸ webpack ä¹‹ç±»çš„ä¸€äº›å·¥å…·å»å…¨é¢ç«äº‰ï¼Œå®ƒçš„åˆè¡·åªæ˜¯å¸Œæœ›èƒ½å¤Ÿæä¾›ä¸€ä¸ªé«˜æ•ˆçš„ ESM æ‰“åŒ…å™¨ï¼Œç„¶åå……åˆ†åˆ©ç”¨ ESM å„é¡¹ç‰¹æ€§ï¼Œä»¥æ­¤æ¥æ„å»ºå‡ºç»“æ„æ¯”è¾ƒæ‰å¹³ï¼Œç„¶åæ€§èƒ½æ¯”è¾ƒå‡ºä¼—çš„ç±»åº“ï¼Œè‡³äºå®ƒå…¶ä»–çš„ä¸€äº›ç‰¹ç‚¹å’Œä¼˜åŠ¿ï¼Œæˆ‘ä»¬éœ€è¦ä¸Šæ‰‹è¿‡åæ‰èƒ½äº†è§£

![é«˜æ•ˆæ‰“åŒ…å™¨](assets/img/2021-11-18-10-35-29.png)

2) rollup ä½¿ç”¨

åœ¨ä»¥ä¸‹è¿™ä¸ªç¤ºä¾‹é‡Œè¾¹ï¼Œæˆ‘ä»¬ä½¿ç”¨ ESM çš„æ–¹å¼ç»„ç»‡çš„ä»£ç æ¨¡å—åŒ–

`./src/message.js`

```js
export default {
  hi: 'Hey Guys, I am jal '
}
```

`./src/logger.js`

```js
export const log = msg => {
  console.log('---Info----')
  console.log(msg)
  console.log('-----------')
}

export const error = msg => {
  console.error('---Error-----')
  console.error(mes)
  console.error('-------------')
}
```

`./src/index.js`

```js
// å¯¼å…¥æ¨¡å—æˆå‘˜
import { log } from './logger'
import messages from './messages'

// ä½¿ç”¨æ¨¡å—æˆå‘˜
const msg = messages.hi

log(msg)
```

å¦‚ä½•å¯¹ä¸Šè¿°ç¤ºä¾‹æ‰“åŒ…ï¼Ÿ

å®‰è£… rollupï¼š`yarn add rollup --dev`

å®‰è£…æˆåŠŸå -> `node_modules/.bin`ç›®å½•ä¸‹å°±æœ‰äº†ä¸€ä¸ª rollup cli ç¨‹åº -> é€šè¿‡è¿™ä¸ª cli å»ä½¿ç”¨æ‰“åŒ…

è¿è¡Œï¼š`yarn rollup ./src/index.js --format iife --file dist/bundle.js`

> ä¸ä¼ é€’ä»»ä½•å‚æ•°ï¼Œä¹Ÿå°±æ˜¯`yarn rollup` -> è‡ªåŠ¨æ‰“å°å®ƒçš„å¸®åŠ©ä¿¡æ¯ -> ä»å¸®åŠ©ä¿¡æ¯çš„å¼€å¤´ä¸­å°±å¯ä»¥çœ‹å‡º rollup çš„æ­£ç¡®ç”¨æ³•ï¼š`rollup [options] <entry file>`ï¼ˆ`[]`æ˜¯å¯é€‰çš„ï¼Œ`<>`å¿…å¡«é¡¹ï¼‰
> 
> `--format`æ˜¯æŒ‡å®šä»£ç æ ¼å¼ -> ä½ å¸Œæœ›æŠŠ ESM çš„ä»£ç è½¬åŒ–è¿‡åç„¶åä»¥ä»€ä¹ˆæ ·çš„æ ¼å¼å»è¾“å‡º -> é€‰æ‹©æœ€é€‚åˆæµè§ˆå™¨ç«¯çš„`iife`æ ¼å¼
> 
> `--file` -> æŒ‡å®šè¾“å‡ºæ–‡ä»¶çš„è·¯å¾„ï¼ŒæŠŠæ‰“åŒ…ç»“æœè¾“å‡ºåˆ°æ–‡ä»¶å½“ä¸­ï¼Œä¸ç„¶ï¼Œæ‰“åŒ…ç»“æœå°±åœ¨ç»ˆç«¯æ˜¾ç¤ºäº†ï¼Œç±»ä¼¼`cat`ä¸€æ ·

`./dist/bundle.js`

```js
(function () {
  'use strict';

  const log = msg => {
    console.log('---Info----');
    console.log(msg);
    console.log('-----------');
  };

  var messages = {
    hi: 'Hey Guys, I am jal '
  };

  const msg = messages.hi;

  log(msg);

}());
```

> å¯ä»¥çœ‹åˆ° rollup çš„æ‰“åŒ…ç»“æœ -> æƒŠäººçš„ç®€æ´ -> åŸºæœ¬è·Ÿæˆ‘ä»¬ä»¥å‰æ‰‹å†™çš„ä»£ç æ˜¯ä¸€æ ·çš„ -> ç›¸æ¯”äº webpack å½“ä¸­å¤§é‡çš„å¼•å¯¼ä»£ç ä»¥åŠä¸€å †çš„æ¨¡å—å‡½æ•° -> rollup è¾“å‡ºçš„è¿™ä¸ª `bundle.js` å‡ ä¹æ²¡æœ‰ä»»ä½•çš„å¤šä½™ä»£ç  -> rollup å®ƒå°±æ˜¯æŠŠæˆ‘ä»¬æ‰“åŒ…è¿‡ç¨‹å½“ä¸­å„ä¸ªæ¨¡å—æŒ‰ç…§æ¨¡å—çš„ä¾èµ–é¡ºåºå…ˆåçš„æ‹¼æ¥åˆ°ä¸€èµ· -> ä½ ä»”ç»†è§‚å¯Ÿè¿™ä¸ªæ‰“åŒ…ç»“æœï¼Œä½ ä¼šå‘ç°è¿™ä¸ªè¾“å‡ºç»“æœé‡Œè¾¹åªä¼šä¿ç•™é‚£äº›ç”¨åˆ°çš„éƒ¨åˆ†ï¼Œå¯¹äºæœªå¼•ç”¨çš„éƒ¨åˆ†éƒ½æ²¡æœ‰è¾“å‡º

è¿™æ˜¯å› ä¸º rollup é»˜è®¤ä¼šå¼€å¯ TreeShaking å»ä¼˜åŒ–æˆ‘ä»¬çš„è¾“å‡ºç»“æœ -> TreeShaking è¿™ä¸ªæ¦‚å¿µæœ€æ—©ä¹Ÿå°±æ˜¯åœ¨ rollup è¿™æ ·ä¸€ä¸ªå½“ä¸­æå‡ºçš„

3ï¼‰é…ç½®æ–‡ä»¶

rollup åŒæ ·æ”¯æŒæˆ‘ä»¬ä»¥é…ç½®æ–‡ä»¶çš„æ–¹å¼å»é…ç½®æˆ‘ä»¬æ‰“åŒ…è¿‡ç¨‹ä¸­çš„å„é¡¹å‚æ•°

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼š`rollup.config.js` -> è¿™ä¸ªæ–‡ä»¶åŒæ ·è¿è¡Œåœ¨ Node ç¯å¢ƒå½“ä¸­ï¼Œä¸è¿‡ rollup å®ƒè‡ªèº«ä¼šé¢å¤–å¤„ç†è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ ESM

åœ¨è¿™é‡Œé…ç½®æ–‡ä»¶å½“ä¸­ï¼Œéœ€è¦å¯¼å‡ºä¸€ä¸ªé…ç½®å¯¹è±¡

```js
export default {
  input: './src/index.js',
  output: {
    file: 'dist/bundle.js',
    format: 'iife'
  }
}
```

> é€šè¿‡`input`å±æ€§æŒ‡å®šæ‰“åŒ…çš„å…¥å£æ–‡ä»¶è·¯å¾„ -> é€šè¿‡`output`å±æ€§æŒ‡å®šè¾“å‡ºçš„ç›¸å…³é…ç½® -> `output`å±æ€§è¦æ±‚æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨è¯¥å¯¹è±¡é‡Œè¾¹å¯ä»¥ç”¨`file`å±æ€§æŒ‡å®šæˆ‘ä»¬è¾“å‡ºçš„æ–‡ä»¶åï¼Œè€Œ`format`å±æ€§å¯ä»¥æŒ‡å®šè¾“å‡ºæ ¼å¼

è¿è¡Œï¼š`yarn rollup --config` , æŒ‡å®šé…ç½®æ–‡ä»¶ï¼š`yarn rollup --config rollup.config.js`

> æ³¨æ„ï¼šéœ€è¦æŒ‡å®š`--config`å‚æ•°ï¼Œä»¥æ­¤æ¥è¡¨é¢æˆ‘ä»¬è¦ä½¿ç”¨é¡¹ç›®çš„é…ç½®æ–‡ä»¶ -> rollup é»˜è®¤æ˜¯ä¸ä¼šå»è¯»å–é…ç½®æ–‡ä»¶çš„ï¼Œå¿…é¡»è¦ä½¿ç”¨`--config`è¿™æ ·ä¸€ä¸ªå‚æ•° -> å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è¿™ä¸ªå‚æ•°å»æŒ‡å®šä¸åŒé…ç½®æ–‡ä»¶çš„åç§°ï¼Œä¾‹å¦‚ç”¨äºç”Ÿäº§ç¯å¢ƒçš„`rollup.production.js`ã€ç”¨äºå¼€å‘ç¯å¢ƒçš„`rollup.development.js`

4) ä½¿ç”¨æ’ä»¶

rollup è‡ªèº«çš„åŠŸèƒ½å°±åªæ˜¯å¯¹ ESM è¿›è¡Œåˆå¹¶æ‰“åŒ…ï¼Œå¦‚æœæˆ‘ä»¬é¡¹ç›®éœ€è¦æ›´é«˜çº§çš„åŠŸèƒ½ï¼Œå¦‚åŠ è½½å…¶ä»–ç±»å‹çš„èµ„æºæ¨¡å—æ–‡ä»¶æˆ–è€…æ˜¯æˆ‘ä»¬è¦åœ¨ä»£ç å½“ä¸­å¯¼å…¥ CommonJS æ¨¡å—ï¼Œåˆæˆ–è€…æƒ³è¦å®ƒå»å¸®æˆ‘ä»¬ç¼–è¯‘ ES æ–°ç‰¹æ€§

å¯¹äºè¿™äº›é¢å¤–çš„éœ€æ±‚ï¼Œrollup åŒæ ·æ”¯æŒä½¿ç”¨æ’ä»¶çš„æ–¹å¼å»æ‰©å±•å®ç°ï¼Œè€Œä¸”æ’ä»¶æ˜¯ rollup å”¯ä¸€çš„æ‰©å±•æ–¹å¼ -> rollup å®ƒä¸åƒ webpack ä¸­åˆ’åˆ†äº† loaderã€plugins å’Œ minimizer è¿™ä¸‰ç§æ‰©å±•æ–¹å¼

![æ’ä»¶](assets/img/2021-11-18-13-03-51.png)

ä½¿ç”¨ä¸€ä¸ªè®©æˆ‘ä»¬å¯ä»¥åœ¨ä»£ç å½“ä¸­å¯¼å…¥ json æ–‡ä»¶çš„æ’ä»¶ -> é€šè¿‡è¿™æ ·ä¸€ä¸ªè¿‡ç¨‹å»äº†è§£å¦‚ä½•åœ¨ rollup å½“ä¸­ä½¿ç”¨æ’ä»¶

æˆ‘ä»¬ä½¿ç”¨çš„æ’ä»¶åå­—å«åšã€Œ`rollup-plugin-json`ã€

å®‰è£…æ’ä»¶`rollup-plugin-json`, è¿è¡Œï¼š`yarn add rollup-plugin-json --dev`

`package.json`

``` json
{
  "name": "03-plugins",
  "version": "0.1.0",
  "main": "index.js",
  "author": "zce <w@zce.me> (https://zce.me)",
  "license": "MIT",
  "devDependencies": {
    "rollup": "^1.26.3",
    "rollup-plugin-json": "^4.0.0"
  }
}
```

`rollup.config.js`

```js
// è¯¥ rollup é…ç½®æ–‡ä»¶å¯ä»¥ç›´æ¥ä½¿ç”¨ ESMï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨ import è¯­æ³•å»å¯¼å…¥è¿™ä¸ªæ’ä»¶æ¨¡å—
// è¯¥æ’ä»¶æ¨¡å—é»˜è®¤å¯¼å‡ºçš„æ˜¯ä¸€ä¸ªå‡½æ•°
import json from 'rollup-plugin-json'

export default {
  input: './src/index.js',
  output: {
    file: 'dist/bundle.js',
    format: 'iife'
  },
  plugins: [
    // å°†å‡½æ•°çš„è°ƒç”¨ç»“æœæ·»åŠ åˆ° plugins è¿™ä¸ªæ•°ç»„ä¸­
    json()
  ]
}
```

> æ³¨æ„ï¼šè¿™æ˜¯æŠŠå‡½æ•°çš„è°ƒç”¨ç»“æœæ”¾åˆ°`plugins`æ•°ç»„ä¸­ï¼Œå¯ä¸æ˜¯å°†è¿™ä¸ª`json`å‡½æ•°æ”¾è¿›å»

`./src/index.js`

```js
// å¯¼å…¥æ¨¡å—æˆå‘˜
import { log } from './logger'
import messages from './messages'
// package.json æ–‡ä»¶å½“ä¸­çš„æ¯ä¸ªå±æ€§å°±ä¼šä½œä¸ºå•ç‹¬çš„å¯¼å‡ºæˆå‘˜ -> è¿™æ˜¯ json æ’ä»¶å¸®æˆ‘ä»¬åšçš„
import { name, version } from '../package.json'

// ä½¿ç”¨æ¨¡å—æˆå‘˜
const msg = messages.hi

log(msg)

log(name)
log(version)
```

`./dist/bundle.js`

```js
(function () {
  'use strict';

  const log = msg => {
    console.log('---------- INFO ----------');
    console.log(msg);
    console.log('--------------------------');
  };

  var messages = {
    hi: 'Hey Guys, I am zce~'
  };

  var name = "03-plugins";
  var version = "0.1.0";

  // å¯¼å…¥æ¨¡å—æˆå‘˜

  // ä½¿ç”¨æ¨¡å—æˆå‘˜
  const msg = messages.hi;

  log(msg);

  log(name);
  log(version);

}());
```

å¯ä»¥çœ‹åˆ° json å½“ä¸­è¢«ç”¨åˆ°çš„`name`å’Œ`version`å±æ€§è¢«æ­£å¸¸æ‰“åŒ…è¿›æ¥äº†ï¼Œè€Œ json å½“ä¸­é‚£äº›æ²¡æœ‰è¢«ç”¨åˆ°çš„å±æ€§ä¹Ÿä¼šè¢« TreeShaking ç§»é™¤æ‰ã€‚

ä»¥ä¸Šå°±æ˜¯æˆ‘ä»¬åœ¨ rollup å½“ä¸­å¦‚ä½•å»ä½¿ç”¨æ’ä»¶ï¼

5) åŠ è½½ npm æ¨¡å—

rollup é»˜è®¤åªèƒ½å¤ŸæŒ‰ç…§æ–‡ä»¶è·¯å¾„çš„æ–¹å¼å»åŠ è½½æœ¬åœ°çš„æ–‡ä»¶æ¨¡å—ï¼Œå¯¹äº`node_modules`å½“ä¸­çš„é‚£äº›ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œrollup å®ƒå¹¶ä¸èƒ½å¤Ÿåƒ webpack ä¸€æ ·ç›´æ¥é€šè¿‡æ¨¡å—åç§°å¯¼å…¥å¯¹åº”çš„æ¨¡å—

ä¸ºäº†æŠ¹å¹³è¿™æ ·ä¸€ä¸ªå·®å¼‚ï¼Œrollup å®˜æ–¹æä¾›äº†ä¸€ä¸ªæ’ä»¶`rollup-plugin-node-resolve`

é€šè¿‡ä½¿ç”¨è¿™ä¸ªæ’ä»¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ä»£ç ä¸­ç›´æ¥å»ä½¿ç”¨æ¨¡å—åç§°å¯¼å…¥å¯¹åº”çš„æ¨¡å—ã€‚

å®‰è£…æ’ä»¶ï¼š`yarn add rollup-plugin-node-resolve --dev`

`rollup.config.js`

```js
import json from 'rollup-plugin-json'
// å¯¼å…¥æ’ä»¶ï¼Œå°†è¿™ä¸ªæ’ä»¶å‡½æ•°çš„è°ƒç”¨ç»“æœé…ç½®åˆ° plugins æ•°ç»„å½“ä¸­
import resolve from 'rollup-plugin-node-resolve'
export default {
  input: 'src/index.js',
  output: {
    file: 'dist/bundle.js',
    format: 'iife'
  },
  plugins: [
    json(),
    resolve()
  ]
}
```

`./src/index.js`

```js
// å¯¼å…¥æ¨¡å—æˆå‘˜
import _ from 'lodash-es'
import { log } from './logger'
import messages from './messages'
import { name, version } from '../package.json'

// ä½¿ç”¨æ¨¡å—æˆå‘˜
const msg = messages.hi

log(msg)

log(name)
log(version)
log(_.camelCase('hello world'))
```

> æ­¤æ—¶ï¼Œåœ¨ `index.js`é‡Œè¾¹æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥å¯¼å…¥`node_modules`å½“ä¸­çš„é‚£äº›ç¬¬ä¸‰æ–¹ npm æ¨¡å— -> åœ¨è¿™é‡Œå¯¼å…¥çš„æ˜¯ lodash çš„ `es` ç‰ˆæœ¬ -> ä¸ºå•¥ç”¨è¿™ä¸ªç‰ˆæœ¬ï¼Ÿ -> rollup é»˜è®¤åªèƒ½å¤Ÿå»å¤„ç† ESM æ¨¡å—ï¼Œå¦‚æœä½ æƒ³è¦ä½¿ç”¨æ™®é€šç‰ˆæœ¬ï¼Œé‚£ä½ éœ€è¦åšä¸€äº›é¢å¤–å¤„ç†

![æ‰“åŒ…ç»“æœ](assets/img/2021-11-18-13-55-40.png)

> è¯´å®åœ¨çš„ï¼Œæˆ‘åªç”¨äº†ä¸€ä¸ª lodash æ‰€æä¾›çš„API -> `bundle`é‡Œè¾¹å¤ªå¤šä»£ç äº†

6) åŠ è½½ CommonJS æ¨¡å—

æ­£å¦‚æˆ‘ä»¬ä¸Šè¾¹æ‰€çœ‹åˆ°çš„ä¸€æ ·ï¼Œrollup å®ƒè®¾è®¡çš„å°±æ˜¯åªå¤„ç† ESM æ¨¡å—çš„æ‰“åŒ…ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ä»£ç å½“ä¸­å¯¼å…¥ CommonJS æ¨¡å—ï¼Œé‚£è¿™é»˜è®¤æ˜¯ä¸è¢«æ”¯æŒçš„ï¼Œç„¶è€Œï¼Œç›®å‰è¿˜æ˜¯ä¼šæœ‰å¤§é‡çš„ npm æ¨¡å—ä½¿ç”¨ CommonJS æ–¹å¼å»å¯¼å‡ºæˆå‘˜ï¼Œæ‰€ä»¥ä¸ºäº†å…¼å®¹è¿™äº›æ¨¡å—ï¼Œå®˜æ–¹åˆç»™å‡ºäº†ä¸€ä¸ªæ’ä»¶â€”â€”`rollup-plugin-commonjs`

å®‰è£…æ’ä»¶ï¼š`yarn add rollup-plugin-commonjs --dev`

`rollup.config.js`

```js
import json from 'rollup-plugin-json'
import resolve from 'rollup-plugin-node-resolve'
import commonjs from 'rollup-plugin-commonjs'
export default {
  input: './src/index.js',
  output: {
    file: 'dist/bundle.js',
    format: 'iife'
  },
  plugins: [
    json(),
    resolve(),
    commonjs()
  ]
}
```

`cjs-module.js`

``` js
module.exports = {
  foo: 'bar'
}
```

`./src/index.js`

```js
// å¯¼å…¥æ¨¡å—æˆå‘˜
import _ from 'lodash-es'
import { log } from './logger'
import messages from './messages'
import { name, version } from '../package.json'
// è¯¥ CommonJS æ¨¡å—é»˜è®¤å¯¼å‡ºä¸€ä¸ªå¯¹è±¡
import cjs from './cjs-module'

// ä½¿ç”¨æ¨¡å—æˆå‘˜
const msg = messages.hi

log(msg)

log(name)
log(version)
log(_.camelCase('hello world'))
log(cjs)
```

`./dist/bundle.js`

![bundle](assets/img/2021-11-18-14-05-40.png)

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨`index.js`é‡Œè¾¹å¯¼å…¥çš„è¿™ä¸ª`cjs-module`çš„é»˜è®¤å¯¼å‡ºå°±ä»¥ä¸€ä¸ªå¯¹è±¡çš„å½¢å¼å‡ºç°åœ¨æˆ‘ä»¬çš„æ‰“åŒ…ç»“æœå½“ä¸­

7) ä»£ç æ‹†åˆ† : åŠ¨æ€å¯¼å…¥

> Code Splitting

åœ¨ rollup çš„æœ€æ–°ç‰ˆæœ¬ä¸­å·²ç»å¼€å§‹æ”¯æŒä»£ç æ‹†åˆ†äº†ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥ä½¿ç”¨ç¬¦åˆ ESM æ ‡å‡†çš„åŠ¨æ€å¯¼å…¥çš„æ–¹å¼å»å®ç°æ¨¡å—çš„æŒ‰éœ€åŠ è½½ï¼Œrollup å†…éƒ¨ä¹Ÿä¼šè‡ªåŠ¨å»å¤„ç†ä»£ç çš„æ‹†åˆ†ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ã€Œåˆ†åŒ…ã€

`rollup.config.js`

```js
import json from 'rollup-plugin-json'
import resolve from 'rollup-plugin-node-resolve'
import commonjs from 'rollup-plugin-commonjs'
export default {
  input: './src/index.js',
  output: {
    // file: 'dist/bundle.js',
    // format: 'iife',
    dir: 'dist', // åŠ¨æ€å¯¼å…¥æ—¶ä¼šåˆ†åŒ…æˆå¤šæ–‡ä»¶
    format: 'amd' // åŠ¨æ€å¯¼å…¥ä¸æ”¯æŒ iife
  },
  plugins: [
    json(),
    resolve(),
    commonjs()
  ]
}
```

> ä½¿ç”¨ä»£ç æ‹†åˆ†ï¼ˆcode-splittingï¼‰è¿™ç§æ–¹å¼å»æ‰“åŒ… -> è¦æ±‚è¾“å‡ºæ ¼å¼ä¸èƒ½æ˜¯ IIFE è¿™ç§å½¢å¼ -> ä¸ºå•¥ä¸èƒ½ï¼Ÿ -> è¿™ä¸ªåŸå› å¾ˆç®€å•ï¼Œå› ä¸ºè‡ªæ‰§è¡Œå‡½æ•°å®ƒä¼šæŠŠæ‰€æœ‰çš„æ¨¡å—éƒ½æ”¾åˆ°åŒä¸€ä¸ªå‡½æ•°å½“ä¸­ï¼Œå®ƒå¹¶æ²¡æœ‰åƒ webpack ä¸€æ ·æœ‰ä¸€äº›å¼•å¯¼ä»£ç ï¼Œæ‰€ä»¥è¯´å®ƒæ²¡æœ‰åŠæ³•å®ç°ä»£ç æ‹†åˆ† -> ä½ è¦æƒ³ä½¿ç”¨ä»£ç æ‹†åˆ†ï¼Œé‚£ä½ å°±å¿…é¡»è¦ä½¿ç”¨ amd æˆ–è€…æ˜¯ CommonJS è¿™æ ·çš„ä¸€äº›å…¶ä»–çš„æ ‡å‡† -> åœ¨æµè§ˆå™¨å½“ä¸­åªèƒ½ä½¿ç”¨ amd æ ‡å‡†ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠ`format`è®¾ç½®ä¸º`amd`ï¼Œä¹Ÿå°±æ˜¯ä»¥ amd æ ¼å¼å»è¾“å‡ºæ‰“åŒ…ç»“æœ
> 
> åªä¿®æ”¹`format`æ˜¯ä¸è¡Œçš„ï¼Œä½ è¿˜å¾—æŠŠ`file`æ”¹ä¸º`dir` -> ä¸ºå•¥è¦æ”¹ï¼Ÿ -> å› ä¸ºä»£ç æ‹†åˆ†æ„å‘³ç€ä¼šè¾“å‡ºå¤šä¸ª chunkï¼Œæ—¢ç„¶è¾“å‡ºå¤šä¸ªæ–‡ä»¶ï¼Œé‚£æˆ‘ä»¬å°±ä¸èƒ½å†ä½¿ç”¨`file`è¿™ç§é…ç½®æ–¹å¼äº†ï¼Œå› ä¸º`file`æ˜¯æŒ‡å®šå•ä¸ªæ–‡ä»¶è¾“å‡ºçš„æ–‡ä»¶çš„æ–‡ä»¶å -> å¦‚æœéœ€è¦è¾“å‡ºå¤šä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`dir`å‚æ•°ï¼ˆé…ç½®æ–‡ä»¶é‡Œè¾¹çš„`file`ã€`dir`å…¶å®å°±æ˜¯æˆ‘ä»¬åœ¨å‘½ä»¤ä¸­æ·»åŠ çš„å‚æ•°ï¼‰

`./src/index.js`

```js
// æ³¨é‡Šæ‰ä»¥ä¸‹ä½¿ç”¨é™æ€å¯¼å…¥çš„ä»£ç 
// // å¯¼å…¥æ¨¡å—æˆå‘˜
// import { log } from './logger'
// import messages from './messages'

// // ä½¿ç”¨æ¨¡å—æˆå‘˜
// const msg = messages.hi

// log(msg)

// ç”¨åŠ¨æ€å¯¼å…¥çš„æ–¹å¼åªå¯¼å…¥ logger è¿™ä¸ªæ¨¡å—
// è¿™ä¸ª import æ–¹æ³•åŒæ ·è¿”å›çš„æ˜¯ä¸€ä¸ª promise å¯¹è±¡
// é€šè¿‡è¯¥ promise å¯¹è±¡çš„ then æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°ä¸€ä¸ªæ¨¡å—å¯¼å…¥è¿‡åçš„å¯¹è±¡ -> æ¨¡å—å¯¼å‡ºçš„æˆå‘˜éƒ½è¢«æ”¾åˆ°è¿™ä¸ªå¯¹è±¡å½“ä¸­ -> å¯ä»¥ä½¿ç”¨è§£æ„çš„æ–¹å¼æå–è¯¥å¯¹è±¡é‡Œè¾¹çš„ log æ–¹æ³•
import('./logger').then(({ log }) => {
  // ä½¿ç”¨ log æ–¹æ³•æ‰“å°ä¸€ä¸ªæ—¥å¿—æ¶ˆæ¯
  log('code splitting~')
})
```

æ‰“åŒ…ç»“æœï¼š

![æ‰“åŒ…ç»“æœ](assets/img/2021-11-18-14-30-38.png)

å¯ä»¥çœ‹åˆ°`dist`ç›®å½•ä¸‹ï¼Œæœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼Œrollup æ˜¯æ ¹æ®åŠ¨æ€å¯¼å…¥ï¼Œä»¥æ­¤æ¥ç”Ÿæˆä¸€ä¸ªå…¥å£ bundleï¼Œä»¥åŠåŠ¨æ€å¯¼å…¥æ‰€å¯¹åº”çš„é‚£ä¸ª bundle -> å®ƒä»¬éƒ½æ˜¯é‡‡ç”¨ amd æ ‡å‡†å»è¾“å‡ºçš„

ä»¥ä¸Šå°±æ˜¯åœ¨ rollup å½“ä¸­å¦‚ä½•å»å®ç°ä»£ç æ‹†åˆ† -> ä½¿ç”¨åŠ¨æ€å¯¼å…¥å»å®ç°çš„

8) å¤šå…¥å£æ‰“åŒ…

rollup åŒæ ·æ”¯æŒå¤šå…¥å£æ‰“åŒ…ï¼Œè€Œä¸”å¯¹äºä¸åŒå…¥å£å½“ä¸­çš„é‚£äº›å…¬å…±éƒ¨åˆ†ä¹Ÿä¼šè‡ªåŠ¨æå–åˆ°å•ä¸ªæ–‡ä»¶å½“ä¸­ä½œä¸ºç‹¬ç«‹çš„ bundle -> å…·ä½“æ¥çœ‹ä¸€ä¸‹å¦‚ä½•é…ç½®

åœ¨è¿™ä¸ªç¤ºä¾‹é‡Œè¾¹ï¼Œæœ‰ä¸¤ä¸ªå…¥å£ï¼Œåˆ†åˆ«æ˜¯ï¼š

- `index.js`
- `album.js`

å®ƒä»¬ä¿©å…¬ç”¨çš„æ¨¡å—æ˜¯ï¼š

- `fetch.js`
- `logger.js`

é…ç½®å¤šå…¥å£æ‰“åŒ…çš„æ–¹å¼éå¸¸ç®€å•ï¼Œåªéœ€è¦æŠŠ`input`å±æ€§ä¿®æ”¹ä¸ºä¸€ä¸ªæ•°ç»„å°±å¯ä»¥äº†ï¼Œå½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸ webpack å½“ä¸­é‚£ç§å¯¹è±¡é…ç½®å½¢å¼å»é…ç½®

ä¸è¿‡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¤šå…¥å£æ‰“åŒ…å†…éƒ¨ä¼šè‡ªåŠ¨æå–å…¬å…±æ¨¡å—ï¼Œä¹Ÿå°±æ˜¯è¯´å†…éƒ¨ä½¿ç”¨ä»£ç æ‹†åˆ†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨`iife`è¿™ç§è¾“å‡ºæ ¼å¼ -> ç”¨`amd`æ ¼å¼

`rollup.config.js`

``` js
export default {
  // input: ['src/index.js', 'src/album.js'], // å¤šå…¥å£æ‰“åŒ…
  // å¤šå…¥å£æ‰“åŒ…çš„å¦ä¸€ç§å†™æ³•
  input: {
    foo: 'src/index.js',
    bar: 'src/album.js'
  },
  output: {
    dir: 'dist',
    format: 'amd'
  }
}
```

è¿è¡Œ`rollup`æ‰“åŒ…å‘½ä»¤

æ­¤æ—¶`dist`ç›®å½•å¤šå‡ºä¸‰ä¸ª JS æ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯ä¸åŒæ‰“åŒ…å…¥å£çš„æ‰“åŒ…ç»“æœï¼Œä»¥åŠæˆ‘ä»¬å…¬å…±æå–å‡ºæ¥çš„ä¸€ä¸ªå…¬å…±æ¨¡å—

![æ‰“åŒ…ç»“æœ](assets/img/2021-11-18-14-54-47.png)

æ³¨æ„ï¼Œå¯¹äº amd è¿™ç§è¾“å‡ºæ ¼å¼çš„ js æ–‡ä»¶ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥å¼•ç”¨åˆ°é¡µé¢ä¸Š -> å¿…é¡»é€šè¿‡å®ç° amd æ ‡å‡†çš„åº“å»åŠ è½½ï¼ˆä¹‹å‰åœ¨ä»‹ç» amd æ ‡å‡†çš„æ—¶å€™å°±åº”è¯¥æœ‰æ‰€äº†è§£äº†ï¼‰

åœ¨`dist`ç›®å½•ä¸‹æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª`html`æ–‡ä»¶ -> åœ¨è¯¥æ–‡ä»¶é‡Œè¾¹ä½¿ç”¨æ‰“åŒ…ç”Ÿæˆçš„ bundle -> é‡‡ç”¨ `require.js`è¿™ä¸ªåº“å»åŠ è½½ä»¥ amd è¾“å‡ºçš„ bundle -> è¿™ä¸ª`require.js`æˆ‘ç”¨çš„æ˜¯ CDN åœ°å€ -> æˆ‘ä»¬æŠŠå®ƒå¼•å…¥åˆ°é¡µé¢å½“ä¸­ï¼Œé€šè¿‡`data-main`è¿™ä¸ªå‚æ•°å¯ä»¥æŒ‡å®š`require.js`è¦åŠ è½½çš„è¿™ä¸ªå…¥å£æ¨¡å—çš„æ¨¡å—è·¯å¾„

![å…¥å£æ¨¡å—](assets/img/2021-11-18-15-01-18.png)

èµ„æºè¯·æ±‚æƒ…å†µï¼š

![è¯·æ±‚](assets/img/2021-11-18-15-04-20.png)

9ï¼‰rollupã€webpack é€‰ç”¨åŸåˆ™

é€šè¿‡ä»¥ä¸Šçš„è¿™äº›æ¢ç´¢å’Œå°è¯•ï¼Œæˆ‘ä»¬å‘ç° rollup ç¡®å®æœ‰å®ƒçš„ä¼˜åŠ¿ï¼Œå½“ç„¶ï¼Œå®ƒçš„ç¼ºç‚¹ä¹ŸæŒºå‡¸æ˜¾çš„

ğŸ’¡ï¼šrollup ä¼˜åŠ¿

+ è¾“å‡ºçš„ç»“æœä¼šæ›´åŠ æ‰å¹³ä¸€äº›ï¼Œé‚£æ‰§è¡Œæ•ˆç‡è‡ªç„¶ä¼šæ›´é«˜
+ è‡ªåŠ¨ç§»é™¤æœªå¼•ç”¨çš„ä»£ç  -> TreeShrinking
+ æ‰“åŒ…ç»“æœä¾ç„¶å®Œå…¨å¯è¯» -> rollup çš„æ‰“åŒ…ç»“æœåŸºæœ¬ä¸Šè·Ÿæˆ‘ä»¬æ‰‹å†™çš„ä»£ç æ˜¯ä¸€è‡´çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™æ‰“åŒ…ç»“æœå¯¹äºå¼€å‘è€…è€Œè¨€è¿˜æ˜¯å¯ä»¥æ­£å¸¸çš„é˜…è¯»çš„

ğŸ’¡ï¼šrollup ç¼ºç‚¹

+ åŠ è½½é ESM çš„ç¬¬ä¸‰æ–¹æ¨¡å—æ¯”è¾ƒå¤æ‚ -> éœ€è¦é…ç½®æ’ä»¶
+ æ¨¡å—æœ€ç»ˆéƒ½ä¼šè¢«æ‰“åŒ…åˆ°ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œæ— æ³•å®ç° HMR -> æ— æ³•åƒ webpack é‚£æ ·å»å®ç°æ¨¡å—çƒ­æ›¿æ¢ï¼ˆHMRï¼‰è¿™ç§å¼€å‘ä½“éªŒ
+ æµè§ˆå™¨ç¯å¢ƒä¸­ï¼Œä»£ç æ‹†åˆ†åŠŸèƒ½ä¾èµ– AMD åº“ -> å¦‚ `require.js` -> å¯¹äºä»£ç æ‹†åˆ†å¿…é¡»è¦ä½¿ç”¨åƒ amd è¿™æ ·çš„è¾“å‡ºæ ¼å¼

---

ç»¼åˆä»¥ä¸Šçš„è¿™äº›ç‰¹ç‚¹ï¼Œæˆ‘ä»¬å‘ç°ï¼š

å¦‚æœæˆ‘ä»¬æ­£åœ¨å¼€å‘åº”ç”¨ç¨‹åºï¼Œé‚£æˆ‘ä»¬è‚¯å®šä¼šé¢ä¸´è¦å»å¤§é‡å¼•å…¥ç¬¬ä¸‰æ–¹æ¨¡å—è¿™æ ·çš„éœ€æ±‚ï¼ŒåŒæ—¶æˆ‘ä»¬åˆéœ€è¦åƒ HMR è¿™æ ·çš„åŠŸèƒ½å»æå‡æˆ‘ä»¬çš„å¼€å‘ä½“éªŒï¼Œè€Œä¸”æˆ‘ä»¬çš„åº”ç”¨ä¸€æ—¦å¤§äº†è¿‡åï¼Œè¿˜æ¶‰åŠåˆ°å¿…é¡»è¦å»åˆ†åŒ… -> å¯¹äºè¿™äº›éœ€æ±‚ï¼Œrollup å®ƒåœ¨æ»¡è¶³ä¸Šéƒ½ä¼šæœ‰äº›æ¬ ç¼º

å¦‚æœæˆ‘ä»¬æ­£åœ¨å¼€å‘ä¸€ä¸ª JavaScript æ¡†æ¶æˆ–è€…æ˜¯ä¸€ä¸ªç±»åº“ï¼Œrollup çš„è¿™äº›ä¼˜ç‚¹å°±ç‰¹åˆ«æœ‰å¿…è¦äº†ï¼Œè€Œè¿™äº›ç¼ºç‚¹å‡ ä¹ä¹Ÿéƒ½å¯ä»¥å¿½ç•¥ã€‚

æˆ‘ä»¬å°±æ‹¿åŠ è½½ç¬¬ä¸‰æ–¹æ¨¡å—æ¥è¯´ï¼Œåœ¨æˆ‘ä»¬å¼€å‘ç±»åº“çš„æ—¶å€™ï¼Œåœ¨æˆ‘ä»¬çš„ä»£ç é‡Œè¾¹ï¼Œå¾ˆå°‘ä¼šå»ä¾èµ–ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œæ‰€ä»¥è¯´å¾ˆå¤šåƒ Reactã€Vue ä¹‹ç±»çš„ä¸€äº›æ¡†æ¶ä¸­ï¼Œå®ƒä»¬éƒ½æ˜¯ä½¿ç”¨ rollup ä½œä¸ºæ¨¡å—æ‰“åŒ…å™¨ï¼Œè€Œå¹¶éæ˜¯ webpack

![æ‰“åŒ…å™¨](assets/img/2021-11-18-15-19-32.png)

ä½†æ˜¯ï¼Œåˆ°ç›®å‰ä¸ºæ­¢çš„å¼€æºç¤¾åŒºä¸­ï¼Œ**å¤§å¤šæ•°äººè¿˜æ˜¯å¸Œæœ›è¿™ä¸¤ä¸ªå·¥å…·å¯ä»¥å…±åŒå­˜åœ¨ï¼Œå…±åŒå‘å±•ï¼Œå¹¶ä¸”èƒ½å¤Ÿç›¸äº’æ”¯æŒå’Œå€Ÿé‰´** -> ä¸ºå•¥ä¼šæœ‰è¿™æ ·çš„å¸Œæœ›ï¼Ÿ

è¿™ä¸ªåŸå› ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯å¸Œæœ›èƒ½å¤Ÿ**è®©æ›´ä¸“ä¸šçš„å·¥å…·å»åšæ›´ä¸“ä¸šçš„äº‹æƒ…**

æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼šwebpack å¤§è€Œå…¨ï¼Œè€Œ rollup æ˜¯å°è€Œç¾

åœ¨å¯¹äºŒè€…çš„é€‰æ‹©ä¸Šï¼Œæˆ‘ä»¬åŸºæœ¬çš„åŸåˆ™å°±æ˜¯ï¼š

- å¦‚æœæˆ‘ä»¬æ­£åœ¨å¼€å‘åº”ç”¨ç¨‹åºï¼Œå»ºè®®å¤§å®¶ä½¿ç”¨ webpack
- å¦‚æœä½ æ­£åœ¨å¼€å‘ç±»åº“ / æ¡†æ¶çš„è¯ï¼Œå»ºè®®é€‰æ‹© rollup

å½“ç„¶ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªç»å¯¹çš„æ ‡å‡† -> åªæ˜¯ä¸€ä¸ªç»éªŒæ³•åˆ™ç½¢äº†ï¼Œæ¯•ç«Ÿ rollup å®ƒåŒæ ·ä¹Ÿå¯ä»¥å»æ„å»ºç»å¤§å¤šæ•°çš„åº”ç”¨ç¨‹åºï¼Œè€Œ webpack åŒæ ·ä¹Ÿå¯ä»¥å»æ„å»ºç±»åº“æˆ–è€…æ˜¯æ¡†æ¶ï¼Œåªä¸è¿‡ï¼Œå®ƒä»¬ç›¸å¯¹æ¥è®²çš„è¯ï¼Œå°±æ˜¯ã€Œæœ¯ä¸šæœ‰ä¸“æ”»ã€çš„æ„Ÿè§‰

å¦å¤–ï¼Œéšç€ webpack è¿‘å‡ å¹´çš„å‘å±•ï¼Œrollup ä¸­çš„å¾ˆå¤šä¼˜åŠ¿å‡ ä¹å·²ç»è¢«æŠ¹å¹³äº†ï¼Œä¾‹å¦‚ rollup å½“ä¸­çš„è¿™ç§æ‰å¹³åŒ–è¾“å‡ºï¼Œæˆ‘ä»¬åœ¨ webpack å½“ä¸­å°±å¯ä»¥ä½¿ç”¨ `concatenateModules` è¿™æ ·ä¸€ä¸ªæ’ä»¶å»å®Œæˆ -> `concatenateModules`ä¹Ÿå¯ä»¥å®ç°ç±»ä¼¼çš„è¿™æ ·ä¸€ä¸ªè¾“å‡º

10ï¼‰äº†è§£æ›´å¤š

â¹ï¼š[rollup æ‰“åŒ…å·¥å…·-è‡´å‰ç«¯-éšå†¬](https://zhiqianduan.com/engineering/rollup%E6%89%93%E5%8C%85%E5%B7%A5%E5%85%B7.html)