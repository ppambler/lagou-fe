### ✍️ Tangxt ⏳ 2021-11-14 🏷️ 模块化

# 08-ES Modules in Node.js - 新版本进一步支持、ES Modules in Node.js - Babel 兼容方案

## ★ES Modules in Node.js - 新版本进一步支持

![新版本进一步支持](assets/img/2021-11-14-17-23-09.png)

在 node 的最新版本当中，它进一步的支持了 ES Modules。

### <mark>1）把 node 切换到支持 ESM 的版本</mark>

我们可以来尝试一下，我们先通过 `nvm` 去切换到 `12.10.0` 的这样一个版本。

``` bash
nvm use 12.10.0
```

这个时候我们明确一下这个版本没有任何问题。

``` bash
node --version
# v12.10.0
```

![切换版本](assets/img/2021-11-14-18-03-24.png)

然后紧接着我们就可以通过 `node --experimental-modules` 去执行一下我们这个 JS 文件。

![执行 JS](assets/img/2021-11-14-18-08-15.png)

![不用加参数](assets/img/2021-11-14-18-09-17.png)

此时执行的效果跟我们之前所看到的也是一样的。

### <mark>2）往`package.json`里边添加`type`字段并设置为`module`</mark>

不过在这个新版本当中，我们可以给项目的 `package.json` 当中去添加一个 `type` 字段 -> 我们将这个 `type` 字段设置为 `module`

![执行 js 文件](assets/img/2021-11-14-18-14-04.png)

> 老师在演示的时候也加了`--experimental-modules`参数，其实不用加也行啊！

这个时候我们这个项目下所有的 JS 文件默认就会以 ES Modules 去工作了 -> 也就是说我们不用再将扩展名改成 `.mjs` 了，我们直接将它们改回为`.js`。

改回来过后，我们再回到文件当中，将文件当中的`.mjs`后缀结尾的路径也给它修改回来。

此时我们就可以回到命令行当中，再次重新运行一下 `index.js`

此时我们这个 JS 文件就会按照 ES Modules 的形式去工作了

---

如果你不添加这个`type`，直接用 node 执行`.js`后缀的 JS 文件，那么就会报错：

![error](assets/img/2021-11-14-18-18-08.png)

---

### <mark>3）有了`"type": "module"`，那遵守 CommonJS 规范的`.js`模块还能被正常加载吗？</mark>

![cjs](assets/img/2021-11-14-18-22-24.png)

如果这个时候你还想去使用 CommonJS 的话，例如我们这儿再去新建一个 `common.js` 这样一个文件，我们在这个文件当中按照 CommonJS 的方式去载入 `path` 这个模块，然后尝试使用 `path` 模块里面的 `join` 成员去把 `dir` 和 `foo` 连接起来 -> 这只是一个测试。

这个时候我们回到我们的命令行当中，直接通过这种环境去启动我们的这个 CommonJS 的这样一个模块。

此时你会发现我们的命令行当中会报一个错误说：`require is not defined`

这也就意味着我们现在还是使用 ES Modules 的形式运行了这个 JS 文件。

### <mark>4）遵守 CommonJS 规范的模块得把`.js`后缀改为`.cjs`才会被正常加载</mark>

所以说这个时候我们需要单独对于 CommonJS 这种方式做一个额外的处理，那就是将这个`common.js`文件修改为`.cjs`这样一个扩展名。

![cjs](assets/img/2021-11-14-18-25-40.png)

此时我们再次去执行的话，就可以正常的去使用 CommonJS 规范了。

### <mark>5）代码</mark>

`module.js`：

``` js
export const foo = 'hello'

export const bar = 'world'
```

`index.js`：

``` js
// Node v12 之后的版本，可以通过 package.json 中添加 type 字段为 module，
// 将默认模块系统修改为 ES Module
// 此时就不需要修改文件扩展名为 .mjs 了

import { foo, bar } from './module.js'

console.log(foo, bar)
```

`common.cjs`：

``` js
// 如果需要在 type=module 的情况下继续使用 CommonJS，
// 需要将文件扩展名修改为 .cjs

const path = require('path')

console.log(path.join(__dirname, 'foo'))
```

`package.json`：

``` js
{
  "type": "module"
}
```

## ★ES Modules in Node.js - Babel 兼容方案

![Babel 兼容方案](assets/img/2021-11-14-18-36-17.png)