### âœï¸ Tangxt â³ 2021-05-10 ğŸ·ï¸ es6

# 01-7-Proxyã€Proxy vs definePropertyã€Reflect

![Kitten sees a tiger in its reflection](assets/img/2021-05-12-11-28-30.png)

> Kitten sees a tiger in its reflection

## â˜…Proxy

> ä»£ç†å¯¹è±¡

1ï¼‰æ¦‚è¿°

å¦‚æœæˆ‘ä»¬æƒ³è¦ç›‘è§†æŸä¸ªå¯¹è±¡ä¸­çš„å±æ€§è¯»å†™ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ES5 æ‰€æä¾›çš„`Object.defineProperty`è¿™æ ·çš„æ–¹æ³•æ¥å»ä¸ºæˆ‘ä»¬çš„å¯¹è±¡æ·»åŠ å±æ€§ï¼Œè¿™æ ·ä¸€æ¥å°±å¯ä»¥æ•è·åˆ°æˆ‘ä»¬å¯¹è±¡å½“ä¸­å±æ€§çš„è¯»å†™è¿‡ç¨‹

è¿™ç§æ–¹æ³•å…¶å®åº”ç”¨å¾—éå¸¸å¹¿æ³›ï¼Œåœ¨ Vue3.0 ä»¥å‰çš„ç‰ˆæœ¬å°±æ˜¯ä½¿ç”¨è¿™æ ·ä¸€ä¸ªæ–¹æ³•æ¥å»å®ç°**æ•°æ®å“åº”**çš„ï¼Œä»è€Œå®ŒæˆåŒå‘æ•°æ®ç»‘å®š

è€Œåœ¨ ES2015 å½“ä¸­ï¼Œå…¨æ–°è®¾è®¡äº†ä¸€ä¸ªå«åšã€ŒProxyã€çš„ç±»å‹ï¼ -> å®ƒå°±æ˜¯ä¸“é—¨ç”¨æ¥ä¸ºå¯¹è±¡è®¾ç½®è®¿é—®ä»£ç†å™¨

å¦‚æœä½ ä¸ç†è§£ä»€ä¹ˆå«åšã€Œä»£ç†ã€ï¼Œé‚£ä¹ˆä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆã€Œé—¨å«ã€å³å¯ï¼ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ç®¡ä½ è¿›å»æ‹¿ä¸œè¥¿ï¼Œè¿˜æ˜¯å¾€é‡Œè¾¹æ”¾ä¸œè¥¿ï¼Œéƒ½å¿…é¡»è¦ç»è¿‡è¿™æ ·ä¸€ä¸ªä»£ç† -> é€šè¿‡ã€ŒProxyã€ï¼Œå°±å¯ä»¥è½»æ¾ç›‘è§†åˆ°å¯¹è±¡çš„è¯»å†™è¿‡ç¨‹ï¼

æˆ–è€…è¿™æ ·ç†è§£ä»£ç†ï¼š

![Proxy](assets/img/2021-05-12-11-34-53.png)

ç›¸æ¯”äº`Object.defineProperty`ï¼Œ**`Proxy`çš„åŠŸèƒ½è¦æ›´ä¸ºå¼ºå¤§ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿæ›´ä¸ºæ–¹ä¾¿**

nextï¼šå¦‚ä½•å»ä½¿ç”¨ Proxyï¼Ÿ

2ï¼‰ä½¿ç”¨

å®šä¹‰ä¸€ä¸ª `person` å¯¹è±¡ï¼š

``` js
const person = {
  name: 'zce',
  age: 20
}
```

é€šè¿‡`new Proxy`çš„æ–¹å¼æ¥å»ä¸º`person`åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ï¼š

``` js
const personProxy = new Proxy()
```

`Proxy`è¿™ä¸ªæ„é€ å‡½æ•°ï¼š

- ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯æˆ‘ä»¬éœ€è¦ä»£ç†çš„ç›®æ ‡å¯¹è±¡ -> `target`
- ç¬¬äºŒä¸ªå‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ -> å¯ä»¥æŠŠå®ƒç§°ä¹‹ä¸ºä»£ç†çš„å¤„ç†å¯¹è±¡ -> `handler`ï¼ˆå®šä¹‰å“ªäº›æ“ä½œå°†è¢«æ‹¦æˆªï¼Œä»¥åŠé‡æ–°å®šä¹‰å¯¹å¯¹è±¡é»˜è®¤è¡Œä¸ºçš„æ“ä½œï¼‰
  - å¯ä»¥é€šè¿‡ `get` æ–¹æ³•ç›‘è§†æˆ‘ä»¬å¯¹ç›®æ ‡å¯¹è±¡å±æ€§çš„è®¿é—®
    - æœ€ç®€å•çš„ä½¿ç”¨å§¿åŠ¿ï¼Œå°±æ˜¯åªæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š`target`ï¼ˆæ‰€ä»£ç†çš„ç›®æ ‡å¯¹è±¡ï¼‰ã€`property`ï¼ˆå¤–éƒ¨æ‰€è®¿é—®çš„è¿™ä¸ªå±æ€§çš„å±æ€§åï¼‰
    - è¯¥æ–¹æ³•çš„è¿”å›å€¼ï¼šè¯¥å€¼å°†ä¼šä½œä¸ºå¤–éƒ¨å»è®¿é—®æˆ‘ä»¬è¿™ä¸ªå±æ€§æ‰€å¾—åˆ°çš„ç»“æœ
  - é€šè¿‡`set`æ–¹æ³•æ¥ç›‘è§†æˆ‘ä»¬å¯¹è±¡å½“ä¸­è®¾ç½®å±æ€§è¿™ä¹ˆä¸€ä¸ªè¿‡ç¨‹

1ã€æµ‹è¯• `get` æ–¹æ³•

![get](assets/img/2021-05-19-11-03-17.png)

`get`æ–¹æ³•ç›‘å¬åˆ°äº†å±æ€§çš„è¯»å–ï¼Œä¹ŸçŸ¥é“æ˜¯å“ªä¸ªå±æ€§åœ¨æäº‹æƒ…ï¼é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬å¾—åˆ°çš„ç»“æœä¹Ÿç¡®å®æ˜¯ `get` çš„è¿”å›å€¼ï¼

è¿™ä¸ªæ–¹æ³•å†…éƒ¨çš„æ­£å¸¸é€»è¾‘ï¼Œå®ƒåº”è¯¥æ˜¯è¿™æ ·çš„ï¼š

> åˆ¤æ–­ä»£ç†ç›®æ ‡å¯¹è±¡å½“ä¸­æ˜¯å¦å­˜åœ¨ `prop` è¿™ä¸ªå±æ€§ï¼Œå¦‚æœå­˜åœ¨å°±è¿”å›å¯¹åº”çš„å€¼ï¼Œåä¹‹ï¼Œåˆ™è¿”å› `undefined`ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªé»˜è®¤å€¼ `'default'`

``` js
const person = {
  name: 'zce',
  age: 20
}

const personProxy = new Proxy(person,{
  get(target,prop,receiver) {
    return prop in target ? target[prop] : 'default'
    // console.log(target,prop,receiver)
    // return 666
  }
})

console.log(personProxy.name) // 'zce'
```

æ­¤æ—¶ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ª`name`å±æ€§è¢«æ­£å¸¸è¾“å‡ºäº†ï¼

å¦‚æœä½ è®¿é—®çš„æ˜¯ä¸€ä¸ªä¸å­˜åœ¨çš„å±æ€§ï¼Œå¦‚ `personProxy.xxx`ï¼Œé‚£ä¹ˆå…¶æ‰€è¾“å‡ºçš„ç»“æœå°±æ˜¯é»˜è®¤å€¼`'default'`äº†ï¼

2ã€æµ‹è¯• `set` æ–¹æ³•

è¿™ä¸ªæ–¹æ³•é»˜è®¤æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š

- targetï¼šä»£ç†ç›®æ ‡å¯¹è±¡
- propï¼šæˆ‘ä»¬è¦å†™å…¥çš„å±æ€§åç§°
- valueï¼šæˆ‘ä»¬è¦å†™å…¥çš„å±æ€§å€¼

é€šè¿‡ä»£ç†å¯¹è±¡ï¼Œä¸º `person` å†™å…¥ä¸€ä¸ª `gender` å±æ€§ï¼š

![set](assets/img/2021-05-19-16-35-12.png)

`set`æ–¹æ³•å†…éƒ¨æ­£å¸¸çš„é€»è¾‘ï¼š

> ä¸ºä»£ç†ç›®æ ‡è®¾ç½®æŒ‡å®šçš„å±æ€§ï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ•°æ®è¿›è¡Œæ ¡éªŒï¼

``` js
const personProxy = new Proxy(person, {
  // ç›‘è§†å±æ€§è¯»å–
  get (target, property) {
    return property in target ? target[property] : 'default'
    // console.log(target, property)
    // return 100
  },
  // ç›‘è§†å±æ€§è®¾ç½®æˆ–åˆ›å»º
  set (target, property, value) {
    if (property === 'age') {
      if (!Number.isInteger(value)) {
        throw new TypeError(`${value} is not an int`)
      }
    }

    target[property] = value
    // console.log(target, property, value)
  }
})

personProxy.age = 100
```

å¦‚æœä½ è¿™æ ·è®¾ç½®ä¸€ä¸ªä¸æ­£å¸¸çš„å€¼ï¼š

``` js
personProxy.age = '666'
```

é‚£ä¹ˆå°±ä¼šæŠ›å‡ºé”™è¯¯ï¼š

![error](assets/img/2021-05-19-16-41-46.png)

ğŸ’¡ï¼šä½¿ç”¨ `set` æ–¹æ³•ä¸€èˆ¬éœ€è¦è¿”å›ä¸€ä¸ª `true`ï¼Œç”¨äºæŒ‡ç¤ºè¿™ä¸ªæ“ä½œæˆåŠŸäº†ï¼Ÿ

> ä½¿ç”¨ `Proxy`ï¼Œä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°éªŒè¯ä¼ é€’ç»™å¯¹è±¡çš„å€¼ã€‚

``` js
let validator = {
  set: function(obj, prop, value) {
    if (prop === 'age') {
      if (!Number.isInteger(value)) {
        throw new TypeError('The age is not an integer');
      }
      if (value > 200) {
        throw new RangeError('The age seems invalid');
      }
    }

    // The default behavior to store the value
    obj[prop] = value;

    // Indicate success
    return true;
  }
};

const person = new Proxy({}, validator);

person.age = 100;
console.log(person.age); // 100
person.age = 'young';    // Throws an exception
person.age = 300;        // Throws an exception
```

---

ä»¥ä¸Šå°±æ˜¯ `Proxy` çš„ä¸€äº›åŸºæœ¬ç”¨æ³•ï¼Œä¹‹å`Proxy`ä¼šç”¨å¾—è¶Šæ¥è¶Šå¤šï¼Œå¦‚ Vue3.0 å°±ä½¿ç”¨ `Proxy` å»å®ç°å†…éƒ¨çš„æ•°æ®å“åº”äº†

## â˜…Proxy å¯¹æ¯” defineProperty

