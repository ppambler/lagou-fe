### âœï¸ Tangxt â³ 2021-05-10 ğŸ·ï¸ es6

# 01-7-Proxyã€Proxy vs definePropertyã€Reflect

![Kitten sees a tiger in its reflection](assets/img/2021-05-12-11-28-30.png)

> Kitten sees a tiger in its reflection

## â˜…Proxy

> ä»£ç†å¯¹è±¡

### <mark>1ï¼‰æ¦‚è¿°</mark>

å¦‚æœæˆ‘ä»¬æƒ³è¦ç›‘è§†æŸä¸ªå¯¹è±¡ä¸­çš„å±æ€§è¯»å†™ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ES5 æ‰€æä¾›çš„`Object.defineProperty`è¿™æ ·çš„æ–¹æ³•æ¥å»ä¸ºæˆ‘ä»¬çš„å¯¹è±¡æ·»åŠ å±æ€§ï¼Œè¿™æ ·ä¸€æ¥å°±å¯ä»¥æ•è·åˆ°æˆ‘ä»¬å¯¹è±¡å½“ä¸­å±æ€§çš„è¯»å†™è¿‡ç¨‹

è¿™ç§æ–¹æ³•å…¶å®åº”ç”¨å¾—éå¸¸å¹¿æ³›ï¼Œåœ¨ Vue3.0 ä»¥å‰çš„ç‰ˆæœ¬å°±æ˜¯ä½¿ç”¨è¿™æ ·ä¸€ä¸ªæ–¹æ³•æ¥å»å®ç°**æ•°æ®å“åº”**çš„ï¼Œä»è€Œå®ŒæˆåŒå‘æ•°æ®ç»‘å®š

è€Œåœ¨ ES2015 å½“ä¸­ï¼Œå…¨æ–°è®¾è®¡äº†ä¸€ä¸ªå«åšã€ŒProxyã€çš„ç±»å‹ï¼ -> å®ƒå°±æ˜¯ä¸“é—¨ç”¨æ¥ä¸ºå¯¹è±¡è®¾ç½®è®¿é—®ä»£ç†å™¨

å¦‚æœä½ ä¸ç†è§£ä»€ä¹ˆå«åšã€Œä»£ç†ã€ï¼Œé‚£ä¹ˆä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆã€Œé—¨å«ã€å³å¯ï¼ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ç®¡ä½ è¿›å»æ‹¿ä¸œè¥¿ï¼Œè¿˜æ˜¯å¾€é‡Œè¾¹æ”¾ä¸œè¥¿ï¼Œéƒ½å¿…é¡»è¦ç»è¿‡è¿™æ ·ä¸€ä¸ªä»£ç† -> é€šè¿‡ã€ŒProxyã€ï¼Œå°±å¯ä»¥è½»æ¾ç›‘è§†åˆ°å¯¹è±¡çš„è¯»å†™è¿‡ç¨‹ï¼

æˆ–è€…è¿™æ ·ç†è§£ä»£ç†ï¼š

![Proxy](assets/img/2021-05-12-11-34-53.png)

å†æˆ–è€…è¿™æ ·ï¼š

![ä»£ç†æœåŠ¡å™¨å’Œä»£ç†å¯¹è±¡](assets/img/2021-05-19-17-07-10.png)

ç›¸æ¯”äº`Object.defineProperty`ï¼Œ**`Proxy`çš„åŠŸèƒ½è¦æ›´ä¸ºå¼ºå¤§ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿæ›´ä¸ºæ–¹ä¾¿**

nextï¼šå¦‚ä½•å»ä½¿ç”¨ Proxyï¼Ÿ

### <mark>2ï¼‰ä½¿ç”¨</mark>

å®šä¹‰ä¸€ä¸ª `person` å¯¹è±¡ï¼š

``` js
const person = {
  name: 'zce',
  age: 20
}
```

é€šè¿‡`new Proxy`çš„æ–¹å¼æ¥å»ä¸º`person`åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ï¼š

``` js
const personProxy = new Proxy()
```

`Proxy`è¿™ä¸ªæ„é€ å‡½æ•°ï¼š

- ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯æˆ‘ä»¬éœ€è¦ä»£ç†çš„ç›®æ ‡å¯¹è±¡ -> `target`
- ç¬¬äºŒä¸ªå‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ -> å¯ä»¥æŠŠå®ƒç§°ä¹‹ä¸ºä»£ç†çš„å¤„ç†å¯¹è±¡ -> `handler`ï¼ˆå®šä¹‰å“ªäº›æ“ä½œå°†è¢«æ‹¦æˆªï¼Œä»¥åŠé‡æ–°å®šä¹‰å¯¹å¯¹è±¡é»˜è®¤è¡Œä¸ºçš„æ“ä½œï¼‰
  - å¯ä»¥é€šè¿‡ `get` æ–¹æ³•ç›‘è§†æˆ‘ä»¬å¯¹ç›®æ ‡å¯¹è±¡å±æ€§çš„è®¿é—®
    - æœ€ç®€å•çš„ä½¿ç”¨å§¿åŠ¿ï¼Œå°±æ˜¯åªæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š`target`ï¼ˆæ‰€ä»£ç†çš„ç›®æ ‡å¯¹è±¡ï¼‰ã€`property`ï¼ˆå¤–éƒ¨æ‰€è®¿é—®çš„è¿™ä¸ªå±æ€§çš„å±æ€§åï¼‰
    - è¯¥æ–¹æ³•çš„è¿”å›å€¼ï¼šè¯¥å€¼å°†ä¼šä½œä¸ºå¤–éƒ¨å»è®¿é—®æˆ‘ä»¬è¿™ä¸ªå±æ€§æ‰€å¾—åˆ°çš„ç»“æœ
  - é€šè¿‡`set`æ–¹æ³•æ¥ç›‘è§†æˆ‘ä»¬å¯¹è±¡å½“ä¸­è®¾ç½®å±æ€§è¿™ä¹ˆä¸€ä¸ªè¿‡ç¨‹

#### <mark>1ã€æµ‹è¯• `get` æ–¹æ³•</mark>

![get](assets/img/2021-05-19-11-03-17.png)

`get`æ–¹æ³•ç›‘å¬åˆ°äº†å±æ€§çš„è¯»å–ï¼Œä¹ŸçŸ¥é“æ˜¯å“ªä¸ªå±æ€§åœ¨æäº‹æƒ…ï¼é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬å¾—åˆ°çš„ç»“æœä¹Ÿç¡®å®æ˜¯ `get` çš„è¿”å›å€¼ï¼

è¿™ä¸ªæ–¹æ³•å†…éƒ¨çš„æ­£å¸¸é€»è¾‘ï¼Œå®ƒåº”è¯¥æ˜¯è¿™æ ·çš„ï¼š

> åˆ¤æ–­ä»£ç†ç›®æ ‡å¯¹è±¡å½“ä¸­æ˜¯å¦å­˜åœ¨ `prop` è¿™ä¸ªå±æ€§ï¼Œå¦‚æœå­˜åœ¨å°±è¿”å›å¯¹åº”çš„å€¼ï¼Œåä¹‹ï¼Œåˆ™è¿”å› `undefined`ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªé»˜è®¤å€¼ `'default'`

``` js
const person = {
  name: 'zce',
  age: 20
}

const personProxy = new Proxy(person,{
  get(target,prop,receiver) {
    return prop in target ? target[prop] : 'default'
    // console.log(target,prop,receiver)
    // return 666
  }
})

console.log(personProxy.name) // 'zce'
```

æ­¤æ—¶ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ª`name`å±æ€§è¢«æ­£å¸¸è¾“å‡ºäº†ï¼

å¦‚æœä½ è®¿é—®çš„æ˜¯ä¸€ä¸ªä¸å­˜åœ¨çš„å±æ€§ï¼Œå¦‚ `personProxy.xxx`ï¼Œé‚£ä¹ˆå…¶æ‰€è¾“å‡ºçš„ç»“æœå°±æ˜¯é»˜è®¤å€¼`'default'`äº†ï¼

#### <mark>2ã€æµ‹è¯• `set` æ–¹æ³•</mark>

è¿™ä¸ªæ–¹æ³•é»˜è®¤æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š

- targetï¼šä»£ç†ç›®æ ‡å¯¹è±¡
- propï¼šæˆ‘ä»¬è¦å†™å…¥çš„å±æ€§åç§°
- valueï¼šæˆ‘ä»¬è¦å†™å…¥çš„å±æ€§å€¼

é€šè¿‡ä»£ç†å¯¹è±¡ï¼Œä¸º `person` å†™å…¥ä¸€ä¸ª `gender` å±æ€§ï¼š

![set](assets/img/2021-05-19-16-35-12.png)

`set`æ–¹æ³•å†…éƒ¨æ­£å¸¸çš„é€»è¾‘ï¼š

> ä¸ºä»£ç†ç›®æ ‡è®¾ç½®æŒ‡å®šçš„å±æ€§ï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ•°æ®è¿›è¡Œæ ¡éªŒï¼

``` js
const personProxy = new Proxy(person, {
  // ç›‘è§†å±æ€§è¯»å–
  get (target, property) {
    return property in target ? target[property] : 'default'
    // console.log(target, property)
    // return 100
  },
  // ç›‘è§†å±æ€§è®¾ç½®æˆ–åˆ›å»º
  set (target, property, value) {
    if (property === 'age') {
      if (!Number.isInteger(value)) {
        throw new TypeError(`${value} is not an int`)
      }
    }

    target[property] = value
    // console.log(target, property, value)
  }
})

personProxy.age = 100
```

å¦‚æœä½ è¿™æ ·è®¾ç½®ä¸€ä¸ªä¸æ­£å¸¸çš„å€¼ï¼š

``` js
personProxy.age = '666'
```

é‚£ä¹ˆå°±ä¼šæŠ›å‡ºé”™è¯¯ï¼š

![error](assets/img/2021-05-19-16-41-46.png)

ğŸ’¡ï¼šä½¿ç”¨ `set` æ–¹æ³•ä¸€èˆ¬éœ€è¦è¿”å›ä¸€ä¸ª `true`ï¼Œç”¨äºæŒ‡ç¤ºè¿™ä¸ªæ“ä½œæˆåŠŸäº†ï¼Ÿ

> ä½¿ç”¨ `Proxy`ï¼Œä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°éªŒè¯ä¼ é€’ç»™å¯¹è±¡çš„å€¼ã€‚

``` js
let validator = {
  set: function(obj, prop, value) {
    if (prop === 'age') {
      if (!Number.isInteger(value)) {
        throw new TypeError('The age is not an integer');
      }
      if (value > 200) {
        throw new RangeError('The age seems invalid');
      }
    }

    // The default behavior to store the value
    obj[prop] = value;

    // Indicate success
    return true;
  }
};

const person = new Proxy({}, validator);

person.age = 100;
console.log(person.age); // 100
person.age = 'young';    // Throws an exception
person.age = 300;        // Throws an exception
```

---

ä»¥ä¸Šå°±æ˜¯ `Proxy` çš„ä¸€äº›åŸºæœ¬ç”¨æ³•ï¼Œä¹‹å`Proxy`ä¼šç”¨å¾—è¶Šæ¥è¶Šå¤šï¼Œå¦‚ Vue3.0 å°±ä½¿ç”¨ `Proxy` å»å®ç°å†…éƒ¨çš„æ•°æ®å“åº”äº†

## â˜…Proxy å¯¹æ¯” defineProperty

äº†è§£äº† Proxy çš„åŸºæœ¬ç”¨æ³•è¿‡åï¼Œæ¥ä¸‹æ¥å°±æ·±å…¥æ¢ç´¢ä¸€ä¸‹ç›¸æ¯”äº`Object.defineProperty`ï¼ŒProxy åˆ°åº•æœ‰å“ªäº›ä¼˜åŠ¿ï¼

é¦–å…ˆï¼Œæœ€æ˜æ˜¾çš„ä¼˜åŠ¿åœ¨äº Proxy è¦æ›´ä¸ºå¼ºå¤§ä¸€äº›ï¼Œè€Œè¿™ä¸ªã€Œå¼ºå¤§ã€å…·ä½“ä½“ç°åœ¨`Object.defineProperty`å®ƒ**åªèƒ½å¤Ÿç›‘è§†åˆ°å¯¹è±¡å±æ€§çš„è¯»å–æˆ–è€…æ˜¯å†™å…¥ -> è¯»å†™**

è€Œ Proxy å®ƒå¯ä»¥ç›‘è§†åˆ°å¾ˆå¤š`Object.defineProperty` ç›‘è§†ä¸åˆ°çš„è¡Œä¸º -> æ¢å¥è¯è¯´ã€Œ**Proxy èƒ½å¤Ÿç›‘è§†åˆ°æ›´å¤šå¯¹è±¡æ“ä½œ**ã€ï¼Œå¦‚`delete`æ“ä½œã€å¯¹å¯¹è±¡å½“ä¸­æ–¹æ³•çš„è°ƒç”¨ç­‰ç­‰â€¦â€¦

### <mark>1ï¼‰ä¼˜åŠ¿ 1ï¼šProxy å¯ä»¥ç›‘è§†è¯»å†™ä»¥å¤–çš„æ“ä½œ</mark>

``` js
// ä¼˜åŠ¿ 1ï¼šProxy å¯ä»¥ç›‘è§†è¯»å†™ä»¥å¤–çš„æ“ä½œ 
// --------------------------

const person = {
  name: 'zce',
  age: 20
}

// ä¸º person å¯¹è±¡å®šä¹‰ä¸€ä¸ª Proxy å¯¹è±¡
// åœ¨ Proxy å¯¹è±¡çš„å¤„ç†å¯¹è±¡å½“ä¸­é¢å¤–æ·»åŠ äº†ä¸€ä¸ª deleteProperty æ–¹æ³•
// è¯¥æ–¹æ³•ä¼šåœ¨å¤–éƒ¨å¯¹å½“å‰è¿™ä¸ª person å¯¹è±¡è¿›è¡Œ delete æ“ä½œæ—¶è‡ªåŠ¨æ‰§è¡Œï¼
// è¯¥æ–¹æ³•åŒæ ·æ¥æ”¶ä¸¤ä¸ªå‚æ•° -> ä»£ç†ç›®æ ‡å¯¹è±¡ + ä½ è¦åˆ é™¤çš„è¿™ä¸ªå±æ€§çš„åç§°
const personProxy = new Proxy(person, {
  deleteProperty (target, property) {
    // è¾“å‡ºä¸€ä¸ªæ¶ˆæ¯
    console.log('delete', property)
    // ä½¿ç”¨ delete æ“ä½œï¼Œåˆ é™¤æ‰ç›®æ ‡ä¿¡æ¯
    delete target[property]
  }
})

// å¤–éƒ¨æ“ä½œï¼šç›´æ¥é€šè¿‡ delete å»åˆ é™¤è¿™ä¸ªä»£ç†å¯¹è±¡å½“ä¸­çš„ age å±æ€§
delete personProxy.age
console.log(person)

// delete age
// { name: 'zce' }
```

å¯ä»¥çœ‹åˆ°ï¼ŒProxy å®ƒç¡®å®èƒ½å¤Ÿåšåˆ° `Object.defineProperty` ä¸èƒ½åšåˆ°çš„äº‹æƒ…ï¼

å½“ç„¶ï¼Œé™¤äº† `delete` è¿™ä¸ªæ“ä½œä»¥å¤–ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶å®ƒçš„å¯¹è±¡æ“ä½œéƒ½èƒ½å¤Ÿè¢«ç›‘è§†åˆ°ï¼Œå¦‚ï¼š

![å…¶å®ƒ handler](assets/img/2021-05-19-19-10-07.png)

> è¿™ä¸ªè¡¨æ ¼é‡Œè¾¹çš„å†…å®¹æœ‰å¾ˆå®Œå–„çš„ä»‹ç»ï¼Œä½ å¯ä»¥å•ç‹¬å»åšä¸€äº›æµ‹è¯•ï¼

### <mark>2ï¼‰ä¼˜åŠ¿ 2ï¼šProxy æ›´å¥½çš„æ”¯æŒæ•°ç»„å¯¹è±¡çš„ç›‘è§† </mark>

ä»¥å¾€ï¼Œæˆ‘ä»¬æƒ³è¦é€šè¿‡`Object.defineProperty`å»ç›‘è§†æ•°ç»„çš„æ“ä½œ -> æœ€å¸¸è§çš„ä¸€ç§æ–¹å¼å°±æ˜¯é€šè¿‡**é‡å†™æ•°ç»„çš„æ“ä½œæ–¹æ³•** -> è¿™ä¹Ÿæ˜¯ vue é‡Œè¾¹æ‰€ä½¿ç”¨çš„æ–¹å¼

å¤§ä½“çš„æ€è·¯æ˜¯è¿™æ ·çš„ï¼š

> é€šè¿‡è‡ªå®šä¹‰çš„æ–¹æ³•å»è¦†ç›–æ‰æ•°ç»„åŸå‹å¯¹è±¡ä¸Šçš„`push`ã€`shift`ä¹‹ç±»çš„ä¸€äº›æ–¹æ³•ï¼Œä»¥æ­¤æ¥å»åŠ«æŒå¯¹è¿™ä¸ªæ–¹æ³•è°ƒç”¨çš„è¿‡ç¨‹ -> å…·ä½“çš„å®ç°ï¼Œvuejs æºç å‰–æè¯¾ç¨‹é‡Œè¾¹æœ‰ä¸“é—¨ä»‹ç»åˆ°

å›è¿‡å¤´æ¥ï¼Œè¯è¯´ï¼Œå¦‚ä½•ä½¿ç”¨ Proxy å¯¹è±¡å»å¯¹æ•°ç»„è¿›è¡Œç›‘è§†å‘¢ï¼Ÿ

1. å®šä¹‰ä¸€ä¸ª `list` æ•°ç»„
2. ä¸ºè¿™ä¸ª `list` æ•°ç»„å®šä¹‰ä¸€ä¸ª Proxy å¯¹è±¡ `listProxy`
3. åœ¨è¿™ä¸ª Proxy å¯¹è±¡çš„å¤„ç†å¯¹è±¡ä¸Š
   1. æ·»åŠ ä¸€ä¸ª`set`æ–¹æ³• -> ç›‘è§†æ•°æ®çš„å†™å…¥
4. æµ‹è¯• -> `listProxy.push(666)`

``` js
// ä¼˜åŠ¿ 2ï¼šProxy å¯ä»¥å¾ˆæ–¹ä¾¿çš„ç›‘è§†æ•°ç»„æ“ä½œ 
// --------------------------

const list = []

const listProxy = new Proxy(list, {
  set (target, property, value) {
    console.log('set', property, value)
    target[property] = value
    return true // è¡¨ç¤ºè®¾ç½®æˆåŠŸ
  }
})

listProxy.push(100)
// set 0 100
// set length 1

listProxy.push(100)
// set 1 100
// set length 2
```

`property`æ˜¯æ•°ç»„çš„ä¸‹æ ‡ï¼Œ`value`åˆ™æ˜¯ä¸‹æ ‡æ‰€å¯¹åº”çš„å€¼

å¯ä»¥çœ‹åˆ° Proxy å†…éƒ¨ä¼šè‡ªåŠ¨æ ¹æ® `push` æ“ä½œè‡ªåŠ¨æ¨ç®—å‡ºå®ƒåº”è¯¥æ‰€å¤„çš„ä¸‹æ ‡ -> è¯´ç™½äº†ï¼Œå°±æ˜¯èƒ½è‡ªåŠ¨æ¨ç®—å‡ºä½ è¦æ“ä½œçš„æ˜¯å“ªä¸ªä¸‹æ ‡ï¼

åŒç†ï¼Œæ•°ç»„çš„å…¶å®ƒä¸€äº›æ“ä½œæ–¹å¼ï¼Œéƒ½æ˜¯ç±»ä¼¼çš„ï¼

ä»¥ä¸Šå°±æ˜¯ Proxy å¯¹æ•°ç»„ä¸€ä¸ªç›‘è§†äº†ï¼ -> å¯ä»¥çœ‹åˆ°å®ƒçš„åŠŸèƒ½è¿˜æ˜¯éå¸¸å¼ºå¤§çš„ï¼ -> è¿™ä¸€ç‚¹ï¼Œå¦‚æœæ”¾åˆ° `Object.defineProperty` ä¸Šå»æçš„è¯å°±ä¼šç‰¹åˆ«çš„éº»çƒ¦ï¼

### <mark>3ï¼‰ä¼˜åŠ¿ 3ï¼šProxy æ˜¯ä»¥éä¾µå…¥çš„æ–¹å¼ç›‘ç®¡äº†å¯¹è±¡çš„è¯»å†™</mark>

Proxy ç›¸æ¯”äº`Object.deleteProperty`è¿˜æœ‰ä¸€ç‚¹ä¼˜åŠ¿ï¼Œé‚£å°±æ˜¯ã€ŒProxyã€å®ƒæ˜¯ä»¥éä¾µå…¥çš„æ–¹å¼ç›‘ç®¡äº†æ•´ä¸ªå¯¹è±¡çš„è¯»å†™ï¼Œæ¢å¥è¯è¯´ï¼Œå°±æ˜¯ã€Œ**ä¸€ä¸ªå·²ç»å®šä¹‰å¥½çš„å¯¹è±¡ï¼Œæˆ‘ä»¬ä¸éœ€è¦å¯¹å¯¹è±¡æœ¬èº«å»åšä»»ä½•çš„æ“ä½œå°±å¯ä»¥ç›‘è§†åˆ°å®ƒå†…éƒ¨æˆå‘˜çš„è¯»å†™äº†**ã€

``` js
// ä¼˜åŠ¿ 3ï¼šProxy ä¸éœ€è¦ä¾µå…¥å¯¹è±¡ 
// --------------------------

// Proxy æ–¹å¼æ›´ä¸ºåˆç†
const person2 = {
  name: 'zce',
  age: 20
}

const personProxy = new Proxy(person2, {
  get (target, property) {
    console.log('get', property)
    return target[property]
  },
  set (target, property, value) {
    console.log('set', property, value)
    target[property] = value
  }
})

personProxy.name = 'jack'

console.log(personProxy.name)
```

è€Œ`Object.deleteProperty`è¿™ç§å§¿åŠ¿ï¼Œå°±è¦æ±‚æˆ‘ä»¬å¿…é¡»è¦é€šè¿‡ç‰¹å®šçš„æ–¹å¼å•ç‹¬å»å®šä¹‰å¯¹è±¡å½“ä¸­é‚£äº›éœ€è¦è¢«ç›‘è§†çš„å±æ€§ï¼Œå› æ­¤ï¼Œå¯¹äºä¸€ä¸ªå·²ç»å­˜åœ¨çš„å¯¹è±¡è€Œè¨€ï¼Œæˆ‘ä»¬æƒ³è¦å»ç›‘è§†å®ƒçš„å±æ€§ï¼Œé‚£å°±éœ€è¦å»åšå¾ˆå¤šé¢å¤–çš„æ“ä½œäº†

``` js
const person = {}

Object.defineProperty(person, 'name', {
  get () {
    console.log('name è¢«è®¿é—®')
    return person._name
  },
  set (value) {
    console.log('name è¢«è®¾ç½®')
    person._name = value
  }
})
Object.defineProperty(person, 'age', {
  get () {
    console.log('age è¢«è®¿é—®')
    return person._age
  },
  set (value) {
    console.log('age è¢«è®¾ç½®')
    person._age = value
  }
})

person.name = 'jack'

console.log(person.name)
```

å¦‚ä½•ä½“ä¼šåˆ°è¿™ä¸ªä¼˜åŠ¿ï¼Ÿ -> åœ¨å¤§é‡ä½¿ç”¨`Object.deleteProperty`çš„è¿‡ç¨‹ä¸­ï¼Œå»æ…¢æ…¢ä½“ä¼š Proxy çš„è¿™ä¸ªã€Œéä¾µå…¥ã€ä¼˜åŠ¿ï¼

> Proxy å§¿åŠ¿ï¼Œè¿™ä»£ç æ˜¾ç„¶è¦å†™å¾—æ›´å°‘ï¼

## â˜…Reflect

> ç»Ÿä¸€çš„å¯¹è±¡æ“ä½œ API

Reflect æ˜¯ ES2015 ä¸­æä¾›çš„ä¸€ä¸ªå…¨æ–°çš„å†…ç½®å¯¹è±¡ï¼Œå¦‚æœæŒ‰ç…§ Java æˆ– C# è¿™ç±»è¯­è¨€çš„è¯´æ³•ï¼Œé‚£ **Reflect å±äºä¸€ä¸ªé™æ€ç±»**ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä¸èƒ½é€šè¿‡ `new` æ–¹å¼å»æ„å»ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œåªèƒ½å»è°ƒç”¨è¿™ä¸ªé™æ€ç±»å½“ä¸­çš„ä¸€äº›é™æ€æ–¹æ³•ï¼Œè€Œè¿™ä¸€ç‚¹å¯¹äºå¤§å®¶è€Œè¨€æ˜¾ç„¶å¹¶ä¸é™Œç”Ÿï¼Œå› ä¸ºåœ¨ JS ä¸­çš„ `Math`ä¹Ÿæ˜¯è¿™æ ·çš„â€¦â€¦

- `new Reflect()` âŒ
- `Reflect.get()` âœ”ï¸

**Reflect å†…éƒ¨å°è£…äº†ä¸€ç³»åˆ—å¯¹å¯¹è±¡çš„åº•å±‚æ“ä½œ**ï¼Œå…·ä½“æä¾›äº†ä¸€å…± **14** ä¸ªé™æ€æ–¹æ³•ï¼ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå·²ç»è¢«åºŸå¼ƒæ‰äº†ï¼Œæ‰€ä»¥ç°åœ¨ï¼Œåªå‰©ä¸‹ **13** ä¸ªäº†ï¼

ä»”ç»†å»æŸ¥çœ‹ Reflect æ–‡æ¡£ï¼Œä½ ä¼šå‘ç°è¿™ 13 ä¸ªæ–¹æ³•çš„æ–¹æ³•åä¸ Proxy å¯¹è±¡å½“ä¸­çš„é‚£ä¸ªå¤„ç†å¯¹è±¡é‡Œè¾¹çš„æ–¹æ³•æˆå‘˜æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼

å…¶å®ï¼Œ**Reflect æˆå‘˜æ–¹æ³•å°±æ˜¯ Proxy å¤„ç†å¯¹è±¡é‡Œè¾¹çš„é‚£äº›æ–¹æ³•å†…éƒ¨çš„é»˜è®¤å®ç°**

è¿™å¥è¯çœ‹èµ·æ¥ä¸å¤ªå¥½ç†è§£ï¼Œä½†å¦‚æœä½ çœ‹äº†ä¸€äº›ä¾‹å­ï¼Œä½ ä¹Ÿå°±èƒ½å¤Ÿæ˜ç™½äº†ï¼

### <mark>1ï¼‰ä»£ç </mark>

1. å®šä¹‰ä¸€ä¸ª`obj`å¯¹è±¡
2. ä¸º`obj`å¯¹è±¡ï¼Œå®šä¹‰ä¸€ä¸ª Proxy å¯¹è±¡ -> `proxy` -> æˆ‘ä»¬çŸ¥é“åœ¨`handler`ï¼ˆProxy çš„å¤„ç†å¯¹è±¡ï¼‰é‡Œè¾¹å¯ä»¥æ·»åŠ ä¸åŒçš„æ–¹æ³•æˆå‘˜ï¼Œæ¥å»ç›‘å¬å¯¹è±¡æ‰€å¯¹åº”çš„æ“ä½œï¼Œå¯å¦‚æœæˆ‘ä»¬æ²¡æœ‰å»æ·»åŠ å…·ä½“çš„å¤„ç†æ–¹æ³•å‘¢ï¼Ÿå¦‚`getã€set`æ–¹æ³•éƒ½ä¸å†™ï¼Œé‚£å®ƒå†…éƒ¨çš„è¿™äº›`getã€set`åˆ°åº•æ˜¯æ€æ ·æ‰§è¡Œçš„å‘¢ï¼Ÿ
3. æµ‹è¯•ï¼šåœ¨å¤–ç•Œè®¿é—®è¿™ä¸ªä»£ç†å¯¹è±¡`proxy`å½“ä¸­çš„å±æ€§ -> `proxy.foo`

å…¶å®ï¼ŒProxy å†…éƒ¨é»˜è®¤å®ç°çš„é€»è¾‘å°±æ˜¯è°ƒç”¨äº† Reflect å¯¹è±¡å½“ä¸­æ‰€å¯¹åº”çš„æ–¹æ³•

![Reflect](assets/img/2021-05-19-22-38-13.png)

ç®€å•æ¥è¯´ï¼Œä½ åœ¨`handler`é‡Œè¾¹ä½ ä¸å†™ä»»ä½•çš„æˆå‘˜æ–¹æ³•ï¼Œé‚£ä¹ˆå½“ä½ å¯¹ä»£ç†å¯¹è±¡ï¼š

- è¯»å–æŸä¸ªå±æ€§`proxy.xxx` -> ä½ çœ‹ä¸è§çš„å†…éƒ¨ä¼šè§¦å‘`get`æ–¹æ³• -> ä½ çœ‹ä¸è§çš„`get`å†…éƒ¨ä¼šè¿”å›`Reflect.get()`çš„è¿”å›å€¼
- å†™å…¥æŸä¸ªå±æ€§`proxy.xxx = 666` -> å†…éƒ¨è§¦å‘`Reflect.set()`
- â€¦â€¦

æ‰€ä»¥ï¼Œè¿™ä¹Ÿå°±è¡¨æ˜äº†æˆ‘ä»¬åœ¨å®ç°è‡ªå®šä¹‰`get`ã€`set`ç­‰è¿™æ ·çš„é€»è¾‘æ—¶ï¼Œæ›´æ ‡å‡†çš„åšæ³•æ˜¯ï¼š

1. å…ˆå»å®ç°è‡ªå·±æ‰€éœ€è¦çš„ç›‘è§†é€»è¾‘ -> `console.log('watch logic~')`ï¼ˆæ¨¡æ‹Ÿç›‘è§†é€»è¾‘ï¼‰
2. æœ€åå†å»è¿”å›é€šè¿‡ Reflect ä¸­å¯¹åº”çš„æ–¹æ³•çš„ä¸€ä¸ªè°ƒç”¨ç»“æœ -> `return Reflect.get(target, property)`ï¼ˆè®¿é—®æˆ‘ä»¬å½“å‰è¿™ä¸ªç›®æ ‡å¯¹è±¡é‡Œè¾¹å¯¹åº”çš„å±æ€§ï¼‰

### <mark>2ï¼‰Reflect çš„ä»·å€¼æ‰€åœ¨</mark>

Reflect çš„ç”¨æ³•å…¶å®éå¸¸ç®€å•ï¼Œåœ¨ MDN ä¸Šå·²ç»æœ‰äº†éå¸¸æ¸…æ™°çš„ä»‹ç»ï¼Œä½†æ˜¯å¤§å¤šæ•°äººæ¥è§¦åˆ°è¿™ä¸ª Reflect å¯¹è±¡çš„ç¬¬ä¸€ä¸ªæ„Ÿè§‰å°±æ˜¯ã€Œ**ä¸ºä»€ä¹ˆè¦æœ‰ Reflect è¿™æ ·ä¸€ä¸ªå¯¹è±¡ï¼Ÿ**ã€ -> ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒçš„ä»·å€¼å…·ä½“ä½“ç°åœ¨ä»€ä¹ˆåœ°æ–¹ï¼Ÿ

zce ä¸ªäººè®¤ä¸ºï¼š

> Reflect å¯¹è±¡æœ€å¤§çš„æ„ä¹‰å°±æ˜¯ã€Œå®ƒç»Ÿä¸€æä¾›äº†ä¸€å¥—ç”¨äºæ“ä½œå¯¹è±¡çš„ APIã€

ä¸ºå•¥è¿™æ ·è¯´ï¼Ÿ

å› ä¸ºåœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å»æ“ä½œå¯¹è±¡æ—¶ï¼Œæœ‰å¯èƒ½ä¼šä½¿ç”¨`Object`å¯¹è±¡ä¸Šçš„ä¸€äº›æ–¹æ³•ï¼Œä¹Ÿæœ‰å¯èƒ½ä½¿ç”¨çš„æ˜¯åƒ`delete`ã€`in`ç­‰è¿™æ ·çš„æ“ä½œç¬¦ï¼Œè€Œè¿™äº›**å¯¹äºæ–°æ‰‹æ¥è¯´ï¼Œå®åœ¨æ˜¯å¤ªä¹±äº†ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆè§„å¾‹**ï¼Œè€Œ Reflect å¯¹è±¡å°±å¾ˆå¥½åœ°è§£å†³äº†è¿™æ ·çš„ä¸€ä¸ªé—®é¢˜ï¼ -> ä¹Ÿå°±æ˜¯ï¼Œå®ƒ**ç»Ÿä¸€äº†å¯¹è±¡çš„æ“ä½œæ–¹å¼**ï¼

ä¸¾å‡ ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¥çœ‹ä¸€ä¸‹ Reflect çš„ç‰›é€¼ä¹‹å¤„

ä¾‹å­ï¼š

``` js
const obj = {
  name: 'zce',
  age: 18
}

console.log('name' in obj)
console.log(delete obj['age'])
console.log(Object.keys(obj))
// true
// [ 'name' ]

console.log(Reflect.has(obj, 'name'))
console.log(Reflect.deleteProperty(obj, 'age'))
console.log(Reflect.ownKeys(obj))
// true
// [ 'name' ]
```

æŒ‰ç…§ä¼ ç»Ÿçš„æ–¹å¼ï¼š

- å¦‚æœæˆ‘ä»¬éœ€è¦å»åˆ¤æ–­è¿™ä¸ª`obj`å¯¹è±¡æ˜¯å¦å­˜åœ¨æŸä¸ªå±æ€§ï¼Œé‚£å°±éœ€è¦ä½¿ç”¨`'name' in obj`è¿™æ ·ä¸€ç§è¯­å¥ -> éœ€è¦ç”¨åˆ°`in`æ“ä½œç¬¦
- å¦‚æœéœ€è¦å»åˆ é™¤è¿™ä¸ª`obj`çš„`age`å±æ€§ï¼Œé‚£å°±éœ€è¦ä½¿ç”¨`delete`è¯­å¥ -> `delete obj['age']`
- å¦‚æœéœ€è¦å»è·å–å¯¹è±¡ä¸­æ‰€æœ‰çš„å±æ€§åï¼Œé‚£å°±éœ€è¦ä½¿ç”¨`Object.keys(obj)`è¿™æ ·ä¸€ä¸ªæ–¹æ³•
- â€¦â€¦

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åŒæ ·éƒ½æ˜¯å»**æ“ä½œ**ä¸€ä¸ªå¯¹è±¡ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸€ä¼šå„¿éœ€è¦ç”¨æ“ä½œç¬¦çš„æ–¹å¼ï¼ˆå¦‚`inã€delete`ï¼‰ï¼Œä¸€ä¼šå„¿åˆéœ€è¦ç”¨åˆ°æŸä¸€ä¸ªå¯¹è±¡å½“ä¸­çš„æ–¹æ³•ï¼ˆå¦‚`Object.keys()`ï¼‰

è€Œæ¢ä½œç°åœ¨ï¼ŒReflect å¯¹è±¡å°±æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„æ–¹å¼ï¼š

- åˆ¤æ–­è¿™ä¸ªå¯¹è±¡å½“ä¸­æ˜¯å¦å­˜åœ¨æŸä¸€ä¸ªå±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ -> `Reflect.has(obj, 'name')`
- å»åˆ é™¤å¯¹è±¡å½“ä¸­çš„æŸä¸€ä¸ªå±æ€§ -> `Reflect.deleteProperty(obj, 'age')`
- å»è·å–å¯¹è±¡å½“ä¸­æ‰€æœ‰çš„å±æ€§å -> `Reflect.ownKeys(obj)`

å¯ä»¥çœ‹åˆ°è¿™æ ·ä¸€ç§ä½¿ç”¨ä½“éªŒï¼Œæ›´ä¸ºåˆç†ä¸€ç‚¹ï¼Œå½“ç„¶ï¼Œè¿™åªæ˜¯ zce çš„ä¸ªäººæ„Ÿæ‚Ÿ

æ€»ä¹‹ï¼Œè¿™ç§ä½¿ç”¨ä½“éªŒï¼Œéœ€è¦è‡ªå·±å¤šå¤šå»ä½“ä¼š

éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œä»¥å‰é‚£ç§å¯¹è±¡çš„æ“ä½œæ–¹å¼ä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼Œä½†æ˜¯ **ES å®˜æ–¹å¸Œæœ›ç»è¿‡ä¸€æ®µæ—¶é—´çš„è¿‡æ¸¡è¿‡åï¼Œä»¥åçš„æ ‡å‡†å½“ä¸­ï¼Œå°±ä¼šæŠŠä¹‹å‰çš„é‚£äº›æ–¹æ³•ç»™å®ƒåºŸå¼ƒæ‰**ï¼Œæ‰€ä»¥å°±ç°åœ¨è€Œè¨€ï¼Œè¿™ 13 ä¸ªæ–¹æ³•ä½ å°±åº”è¯¥å»äº†è§£ï¼Œä»¥åŠå®ƒä»¬å„è‡ªæ‰€å–ä»£çš„ç”¨æ³•ï¼ -> è¿™äº›å†…å®¹åœ¨ MDN ä¸Šæœ‰å®Œæ•´çš„æè¿°ï¼

![Reflect](assets/img/2021-05-19-23-34-02.png)

> `Reflect.enumerate(object)`è¿™ä¸ª API è¢«åºŸå¼ƒäº†

### <mark>3ï¼‰Object vs Reflect</mark>

`Object`ä¸`Reflect`çš„å…³ç³»æ˜¯äº¤é›†çš„ï¼Œå³ï¼š

![Object vs Reflect](assets/img/2021-05-19-23-43-19.png)

## â˜…è¡¥å……

ä¸€ä¸ªç®€å• Proxy ä¾‹å­ï¼š

``` js
const user = {
  firstName: "John",
  lastName: "Doe",
  email: "john.doe@example.com",
};
const handler = {
  get(target, property) {
    console.log(`Property ${property} has been read.`);
    return target[property];
  },
};
const proxyUser = new Proxy(user, handler);
console.log(proxyUser.firstName);
console.log(proxyUser.lastName);

// Property firstName has been read.
// John
// Property lastName has been read.
// Doe
```

ä¸»è¦çœ‹å›¾ï¼š

![proxy example](assets/img/2021-05-20-00-02-14.png)

## â˜…äº†è§£æ›´å¤š

â¹ï¼š[Proxy - JavaScript - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy)

â¹ï¼š[Reflect - JavaScript - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Reflect)

â¹ï¼š[Comparing Reflect and Object methods - JavaScript - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Reflect/Comparing_Reflect_and_Object_methods)

â¹ï¼š[JavaScript Proxy Explained Clearly By Practical Examples](https://www.javascripttutorial.net/es6/javascript-proxy/)

â¹ï¼š[A practical guide to Javascript Proxy - by Thomas Barrasso - Bits and Pieces](https://blog.bitsrc.io/a-practical-guide-to-es6-proxy-229079c3c2f0)

â¹ï¼š[JavaScript Proxy Object Explained](https://areknawo.com/javascript-proxy-object-explained/)

â¹ï¼š[Scala: Proxy Design Pattern - DZone Java](https://dzone.com/articles/scala-proxy-design-pattern)

â¹ï¼š[æ·±å…¥ç†è§£ ES6 ç¬¬ 12 ç« -ä»£ç†ï¼ˆProxyï¼‰å’Œåå°„ï¼ˆReflectionï¼‰API - å´ç§‹é›¨çš„åšå®¢ - qiuyu Blog](https://helloqiuyu.com/2019/01/19/es6-set-map-proxy/)

â¹ï¼š[åŸºäº ES6 çš„ Proxy ï¼Œ100 è¡Œä»£ç å®ç°ä¸€ä¸ª XMLHttpRequest çš„æ‹¦æˆªæ ¸å¿ƒ ajax-proxy](https://juejin.cn/post/6844903984327557134)

â¹ï¼š[å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡çš„æŸä¸ªå±æ€§æ˜¯å¯å†™çš„ï¼Ÿ Â· Issue #19 Â· akira-cn/FE_You_dont_know](https://github.com/akira-cn/FE_You_dont_know/issues/19)

â¹ï¼š[JavaScript Metaprogramming - ES6 Proxy Use and Abuse - Eirik Langholm Vullum - YouTube](https://www.youtube.com/watch?v=opf7xX-whIw)

â¹ï¼š[æ¢ç©¶æ•°æ®ç»‘å®šï¼ˆ2ï¼‰ES6 Proxy - Deng's Blog](http://objcer.com/2017/10/31/Data-Binding-with-ES6-Proxies/)

â¹ï¼š[ES6 Reflect API Tutorial](http://qnimate.com/es6-reflect-api-tutorial/)

## â˜…æ€»ç»“

- ä»£ç†ï¼šğŸ± å’Œ ğŸ…ï¼Œè®¿é—® ğŸ…ï¼Œæ”¹ ğŸ±
- å†ä¹Ÿä¸æƒ³ä½¿ç”¨ `Object.defineProperty` äº†
- ç”¨ Reflect API æ¥æ“ä½œå¯¹è±¡å§ï¼