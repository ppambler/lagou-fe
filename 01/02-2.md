### âœï¸ Tangxt â³2021-08-18 ğŸ·ï¸ Asynchronous

# 02-2-Promise æ¦‚è¿°ã€åŸºæœ¬ç”¨æ³•ã€ä½¿ç”¨æ¡ˆä¾‹ã€å¸¸è§è¯¯åŒºã€é“¾å¼è°ƒç”¨ã€å¼‚å¸¸å¤„ç†ã€é™æ€æ–¹æ³•ã€å¹¶è¡Œæ‰§è¡Œã€æ‰§è¡Œæ—¶åº

## â˜…æ¦‚è¿°

![æ¦‚è¿°](assets/img/2021-08-19-11-18-50.png)

å›è°ƒå‡½æ•°å¯ä»¥è¯´æ˜¯ JS ä¸­æ‰€æœ‰å¼‚æ­¥ç¼–ç¨‹æ–¹å¼çš„æ ¹åŸºï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ä¼ ç»Ÿå›è°ƒæ–¹å¼å»å®Œæˆå¤æ‚çš„å¼‚æ­¥æµç¨‹ï¼Œé‚£å°±æ— æ³•é¿å…å¤§é‡çš„å›è°ƒå‡½æ•°åµŒå¥—äº†

è¿™ä¹Ÿå°±ä¼šå¯¼è‡´æˆ‘ä»¬å¸¸è¯´çš„å›è°ƒåœ°ç‹±é—®é¢˜ï¼š

![å›è°ƒåœ°ç‹±](assets/img/2021-08-19-11-00-47.png)

ä¸ºäº†é¿å…å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼ŒCommonJS ç¤¾åŒºç‡å…ˆæå‡ºäº†ä¸€ç§å«åš `Promise` çš„è§„èŒƒ -> ç›®çš„å°±æ˜¯ä¸ºå¼‚æ­¥ç¼–ç¨‹æä¾›ä¸€ç§æ›´åˆç†ã€æ›´å¼ºå¤§çš„ç»Ÿä¸€è§£å†³æ–¹æ¡ˆ

åæ¥åœ¨ ES2015 å½“ä¸­è¢«æ ‡å‡†åŒ–è¿›äº† ES çš„è¯­è¨€è§„èŒƒ

![æ‰¿è¯º](assets/img/2021-08-19-11-26-45.png)

> çˆ¸çˆ¸æ‰¿è¯ºå‡ºå»ç»™ä½ ä¹°ä¸€å°ç”µè„‘ -> é—¨åº—å…³é—¨äº†ï¼Œæ²¡ä¹°åˆ°å°±å›æ¥äº†ï¼Œé‚£è¿™ä¸ªæ‰¿è¯ºå°±å˜æˆ`Rejected`æ€äº†ï¼Œå¦‚æœé—¨åº—æ²¡å…³ï¼Œä¹°å›æ¥äº†ï¼Œé‚£è¿™ä¸ªæ‰¿è¯ºå°±å˜æˆ`Fulfilled`æ€äº† -> ä¸ç®¡æ˜¯å¦ä¹°å›æ¥äº†ï¼Œä½ éƒ½ä¼šæœ‰ä¸€ä¸ªç›¸åº”çš„ååº”ï¼Œå¦‚ä¹°äº†å°±å¾ˆå¼€å¿ƒï¼Œæ²¡æœ‰ä¹°å°±å¾ˆç”Ÿæ°”â€¦â€¦ -> è‡³äºä»¥åä¹°äº†ï¼Œé‚£ä¹Ÿæ˜¯å¦å¤–ä¸€ä¸ªæ‰¿è¯ºçš„äº‹å„¿äº†ï¼Œè¿™ä¸ªæ‰¿è¯ºå·²ç»`Fulfilled`äº†ï¼Œé‚£å°±æ— æ³•æ”¹å˜äº†â€¦â€¦

æ‰€è°“çš„ Promise å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨æ¥è¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡æœ€ç»ˆç»“æŸè¿‡åï¼Œå®ƒç©¶ç«Ÿæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œå°±åƒæ˜¯å†…éƒ¨å¯¹å¤–ç•Œåšå‡ºäº†ä¸€ä¸ªæ‰¿è¯ºï¼Œä¸€å¼€å§‹è¿™ä¸ªæ‰¿è¯ºæ˜¯ä¸€ç§å¾…å®šçš„çŠ¶æ€ï¼Œè‹±æ–‡å«åšã€Œ`Pending`ã€ -> æœ€ç»ˆæœ‰å¯èƒ½æˆåŠŸï¼Œè¢«å«åšã€Œ`Fulfilled`ã€ï¼Œä¹Ÿæœ‰å¯èƒ½å¤±è´¥ï¼Œè¢«å«åšã€Œ`Rejected`ã€

å½¢è±¡ç‚¹æ¥è¯´ï¼š

æˆ‘æ‰¿è¯ºç»™ä½ ä¹°ä¸€ä»¶å¤§è¡£ï¼Œé‚£æ­¤æ—¶æˆ‘å°±ä¼šç­‰å¾…æˆ‘è¿™ä¸ªæ‰¿è¯ºçš„ç»“æœï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘çš„è¿™ä¸ªæ‰¿è¯ºæ­¤æ—¶æ˜¯ä¸€ä¸ªã€Œå¾…å®šã€çš„çŠ¶æ€ -> å¦‚æœç¡®å®æˆ‘ä¹°å›æ¥äº†è¿™ä»¶å¤§è¡£ï¼Œé‚£è¿™ä¸ªæ‰¿è¯ºä¹Ÿå°±æˆåŠŸäº†ï¼Œåä¹‹ä¸ç®¡ä»€ä¹ˆåŸå› ï¼Œæˆ‘æ²¡æœ‰ä¹°å›æ¥è¿™ä»¶å¤§è¡£ï¼Œé‚£è¿™ä¸ªæ‰¿è¯ºå°±æ˜¯å¤±è´¥äº†

æ‰¿è¯ºç»“æŸè¿‡å -> ä¸ç®¡è¿™ä¸ªæ‰¿è¯ºæœ€ç»ˆæ˜¯è¾¾æˆè¿˜æ˜¯å¤±è´¥éƒ½ä¼šæœ‰ç›¸å¯¹åº”çš„ååº” -> æ¯”å¦‚è¯´æˆ‘è¾¾æˆäº†ï¼Œé‚£ä½ å°±å¯èƒ½ä¼šå¾ˆæ„Ÿæ¿€ï¼Œé‚£å¦‚æœæˆ‘å¤±è´¥äº†ï¼Œé‚£ä½ å°±æœ‰å¯èƒ½æŠŠæˆ‘éª‚ä¸€é¡¿

ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ‰¿è¯ºçŠ¶æ€æ˜ç¡®è¿‡åï¼Œéƒ½ä¼šæœ‰ç›¸å¯¹åº”çš„ä»»åŠ¡ä¼šè¢«è‡ªåŠ¨æ‰§è¡Œï¼Œè€Œä¸”**è¿™ç§æ‰¿è¯ºä¼šæœ‰ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„ç‰¹ç‚¹ï¼Œå°±æ˜¯ä¸€æ—¦æ˜ç¡®äº†ç»“æœè¿‡åï¼Œå°±ä¸å¯èƒ½å†å‘ç”Ÿæ”¹å˜äº†** -> ä¾‹å¦‚ï¼Œæˆ‘æ²¡æœ‰ä¹°åˆ°å¤§è¡£ï¼Œé‚£ä¹ˆè¿™ä¸ªç»™ä½ ä¹°å¤§è¡£çš„æ‰¿è¯ºå°±æ˜¯å¤±è´¥äº†çš„ï¼Œå®ƒå°±ä¸å¯èƒ½å†å˜æˆæˆåŠŸäº†ï¼Œå³ä¾¿è¯´æˆ‘ä»¥åå†ç»™ä½ ä¹°äº†ï¼Œä½†é‚£ä¹Ÿæ˜¯ä»¥åçš„äº‹æƒ…äº†ï¼Œå¯¹äºæˆ‘ä»¬ä¸€å¼€å§‹çš„æ‰¿è¯ºï¼Œå®ƒè¿˜æ˜¯å¤±è´¥çš„

è½å®åˆ°ç¨‹åºä¸Šï¼Œå¦‚ä½ éœ€è¦æˆ‘å¸®ä½ å»å‘é€ä¸€ä¸ª Ajax è¯·æ±‚ï¼Œé‚£ä½ å°±å¯ä»¥ç†è§£ä¸ºã€Œæˆ‘æ‰¿è¯ºå¸®ä½ è¯·æ±‚ä¸€ä¸ªåœ°å€ã€ï¼Œè€Œè¿™ä¸ªè¯·æ±‚æœ€ç»ˆæœ‰å¯èƒ½æˆåŠŸï¼ŒæˆåŠŸé‚£å°±è°ƒç”¨ä½ çš„`onFulfilled`å›è°ƒï¼Œè€Œå¦‚æœè¯·æ±‚å¤±è´¥çš„è¯ï¼Œæˆ‘å°±ä¼šå»è°ƒç”¨ä½ çš„`onRejected`å›è°ƒ -> è€Œè¿™å°±æ˜¯ Promise çš„ä¸€ä¸ªæ¦‚å¿µäº†

## â˜…åŸºæœ¬ç”¨æ³•

åœ¨ä»£ç å±‚é¢ï¼ŒPromise å®é™…ä¸Šæ˜¯ ES2015 æ‰€æä¾›ä¸€ä¸ªçš„å…¨å±€ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ„é€ å‡ºä¸€ä¸ª Promise å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„æ‰¿è¯ºï¼Œè¿™ä¸ªç±»å‹çš„æ„é€ å‡½æ•°å®ƒéœ€è¦æ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå…‘ç°æ‰¿è¯ºçš„é€»è¾‘

![åŸºæœ¬ç”¨æ³•](assets/img/2021-08-19-15-52-49.png)

è¿™ä¸ªå‡½æ•°ä¼šåœ¨æ„é€  Promise çš„è¿‡ç¨‹å½“ä¸­è¢«åŒæ­¥æ‰§è¡Œï¼Œè¿™ä¸ªå‡½æ•°å†…éƒ¨ä¼šæ¥æ”¶åˆ°ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯`resolve`å’Œ`reject` -> äºŒè€…éƒ½ä¸€ä¸ªå‡½æ•°

`resolve`å‡½æ•°çš„ä½œç”¨å°±æ˜¯å°†è¿™ä¸ª Promise å¯¹è±¡çš„çŠ¶æ€ä¿®æ”¹ä¸º`Fulfilled`ï¼Œä¹Ÿå°±æ˜¯æˆåŠŸ -> ä¸€èˆ¬æˆ‘ä»¬å°†å¼‚æ­¥ä»»åŠ¡çš„æ“ä½œç»“æœé€šè¿‡`resolve`çš„å‚æ•°ä¼ é€’å‡ºå»

åŒç†ï¼Œ`reject`å‡½æ•°çš„ä½œç”¨å°±æ˜¯è¿™ä¸ª Promise å¯¹è±¡çš„çŠ¶æ€ä¿®æ”¹ä¸º`Rejected`ï¼Œä¹Ÿå°±æ˜¯å¤±è´¥ -> ä¸€èˆ¬æˆ‘ä»¬ç»™`reject`ä¼ é€’çš„å‚æ•°æ˜¯ä¸€ä¸ªé”™è¯¯çš„å¯¹è±¡ï¼Œç”¨æ¥è¡¨ç¤ºè¿™ä¸ªæ‰¿è¯ºå®ƒä¸ºä»€ä¹ˆå¤±è´¥ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªç†ç”±

æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼ŒPromise å¯¹è±¡çš„çŠ¶æ€ä¸€æ—¦ç¡®ç«‹è¿‡åå°±ä¸èƒ½å†è¢«ä¿®æ”¹äº†ï¼Œæ‰€ä»¥åœ¨å‡½æ•°é‡Œè¾¹åªèƒ½è°ƒç”¨`resolve`æˆ–`reject`

Promise å®ä¾‹åˆ›å»ºå®Œè¿‡åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨å®ƒçš„`then`æ–¹æ³•åˆ†åˆ«å»æŒ‡å®š`onFulfilled`å’Œ`onRejected`å›è°ƒå‡½æ•°

`then`çš„å‚æ•°ï¼š

- ç¬¬ä¸€ä¸ªæ˜¯`onFulfilled`å‡½æ•° -> ä¹Ÿå°±æ˜¯æ‰¿è¯ºæˆåŠŸè¿‡åçš„å›è°ƒå‡½æ•°
- ç¬¬äºŒä¸ªæ˜¯`onRejected`å‡½æ•° -> ä¹Ÿå°±æ˜¯æ‰¿è¯ºå¤±è´¥è¿‡åçš„å›è°ƒå‡½æ•°

æ³¨æ„ï¼Œå‡½æ•°ï¼ˆä¼ ç»™`Promise`çš„å‡½æ•°å‚æ•°ï¼‰å½“ä¸­æ²¡æœ‰ä»»ä½•çš„å¼‚æ­¥æ“ä½œï¼Œ`then`æ–¹æ³•å½“ä¸­æ‰€æŒ‡å®šçš„å›è°ƒå‡½æ•° -> ä»»ç„¶ä¼šè¿›å…¥åˆ°å›è°ƒé˜Ÿåˆ—å½“ä¸­å»æ’é˜Ÿ

ä¹Ÿå°±æ˜¯è¯´å‡½æ•°é‡Œè¾¹çš„åŒæ­¥ä»£ç æ‰§è¡Œå®Œäº†ï¼Œæ‰ä¼šå»æ‰§è¡Œä¼ ç»™`then`çš„å›è°ƒå‡½æ•°

å¯¹äº Promiseï¼Œå®ƒçš„å›è°ƒæ‰§è¡Œçš„æ—¶åºé—®é¢˜æ˜¯æ¯”è¾ƒç‰¹æ®Šçš„ -> ä¹‹åä¼šè¯´åˆ°

![Promise ä¾‹å­](assets/img/2021-08-19-16-55-31.png)

> æˆ‘æ‰¿è¯ºå¸®ä½ ä¹°ä¸€å°ç”µè„‘ -> è¿™ä¸ªä¹°å¯èƒ½æˆåŠŸï¼Œå¯èƒ½å¤±è´¥ -> ä¹°æˆåŠŸï¼Œä½ ä¼šå¼€å¿ƒï¼Œæ²¡æœ‰ä¹°åˆ°ï¼Œä½ ä¼šå¤±è½

ğŸ’¡ï¼šä½¿ç”¨`webpack-dev-server`æ¥æµ‹è¯•ä»£ç ï¼Ÿ

è¿™æ ·å¯ä»¥è®©ä½ ä¸ç”¨åˆ›å»ºä¸€ä¸ª`index.html`

`package.json`ï¼š

``` json
{
  "name": "asynchronous",
  "version": "0.1.0",
  "main": "index.js",
  "author": "zce <w@zce.me> (https://zce.me)",
  "license": "MIT",
  "devDependencies": {
    "html-webpack-plugin": "^3.2.0",
    "webpack": "^4.41.2",
    "webpack-cli": "^3.3.10",
    "webpack-dev-server": "^3.9.0"
  }
}
```

å¯åŠ¨ä¸€ä¸ª`server`ï¼š

``` bash
yarn webpack-dev-server xxx.js --open
```

ğŸ’¡ï¼š`new Error('promise rejected').toString()`çš„è¿”å›å€¼ï¼Ÿ

`"Error: promise rejected"`

![Error](assets/img/2021-08-19-15-45-57.png)

## â˜…ä½¿ç”¨æ¡ˆä¾‹

ä½¿ç”¨ Promise å°è£… Ajax è¯·æ±‚ï¼š

``` js
function ajax (url) {
  return new Promise(function (resolve, reject) {
    var xhr = new XMLHttpRequest()
    xhr.open('GET', url)
    xhr.responseType = 'json'
    xhr.onload = function () {
      if (this.status === 200) {
        resolve(this.response)
      } else {
        reject(new Error(this.statusText))
      }
    }
    xhr.send()
  })
}
```

1. å®šä¹‰ä¸€ä¸ª`ajax`å‡½æ•° -> æ¥æ”¶ä¸€ä¸ª`url`å‚æ•°ï¼Œç”¨æ¥æ¥æ”¶å¤–ç•Œéœ€è¦è¯·æ±‚çš„åœ°å€ -> å¯¹å¤–è¿”å›ä¸€ä¸ª`Promise`å¯¹è±¡ï¼Œç›¸å¯¹äºå¯¹å¤–ä½œå‡ºä¸€ä¸ªæ‰¿è¯º
2. åœ¨è¿™ä¸ª`Promise`å¯¹è±¡çš„æ‰§è¡Œé€»è¾‘å½“ä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨`XMLHttpRequest`å¯¹è±¡å»å‘é€ä¸€ä¸ª`ajax`è¯·æ±‚
   1. è®¾ç½®è¯·æ±‚æ–¹å¼ï¼Œä»¥åŠè¯·æ±‚åœ°å€
   2. è®¾ç½®å“åº”ç±»å‹ä¸º`json` -> è¿™ä¸ªæ–¹å¼æ˜¯ HTML5 å½“ä¸­å¼•å…¥çš„ä¸€ä¸ªæ–°ç‰¹æ€§ï¼Œå¯ä»¥è®©æˆ‘ä»¬åœ¨è¯·æ±‚å®Œæˆè¿‡åç›´æ¥æ‹¿åˆ°ä¸€ä¸ª`json`å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²
   3. ä¸º`xhr`æ³¨å†Œä¸€ä¸ª`onload`äº‹ä»¶ -> è¿™ä¸ªä¹Ÿæ˜¯ HTML5 å½“ä¸­æä¾›çš„ä¸€ä¸ªæ–°äº‹ä»¶ -> è¯·æ±‚å®Œæˆè¿‡åä¼šè§¦å‘ï¼Œä¹Ÿå°±æ˜¯ä¼ ç»Ÿçš„`readystate === 4`è¿™ä¸ªçŠ¶æ€æ‰ä¼šæ‰§è¡Œ
      1. åˆ¤æ–­è¯·æ±‚çš„çŠ¶æ€æ˜¯å¦æ˜¯`200`ï¼Ÿ -> å¦‚æœæ˜¯æ„å‘³ç€è¯·æ±‚å·²ç»æˆåŠŸäº† -> è°ƒç”¨`resolve`ï¼Œè¡¨ç¤ºæˆ‘ä»¬è¿™ä¸ª`Promise`å·²ç»æˆåŠŸäº†ï¼Œä¼ ç»™`resolve`çš„å‚æ•°æ˜¯ã€Œè¯·æ±‚å¾—åˆ°çš„å“åº”ç»“æœã€
      2. ä¸æ˜¯`200`ï¼Ÿ -> ä¹Ÿå°±æ˜¯è¯·æ±‚å¤±è´¥äº† -> è°ƒç”¨`reject`å‡½æ•°ï¼Œè¡¨ç¤º`Promise`å¤±è´¥ -> å‚æ•°æ˜¯é”™è¯¯ä¿¡æ¯å¯¹è±¡ï¼Œå…¶å‚æ•°æ˜¯`statusText`
   4. è°ƒç”¨`xhr`çš„`send`æ–¹æ³•å¼€å§‹æ‰§è¡Œå¼‚æ­¥è¯·æ±‚
3. è‡³æ­¤ï¼Œ`Promise`ç‰ˆæœ¬çš„`ajax`å‡½æ•°å°±å°è£…å¥½äº†

æµ‹è¯•æˆåŠŸå›è°ƒï¼š

![æµ‹è¯•](assets/img/2021-08-19-18-31-35.png)

è°ƒç”¨`ajax`å‡½æ•°è¿”å›ä¸€ä¸ª`Promise`å¯¹è±¡ -> é€šè¿‡è¿™ä¸ªå¯¹è±¡çš„`then`æŒ‡å®šå›è°ƒ -> æˆåŠŸå›è°ƒå’Œå¤±è´¥å›è°ƒ

æµ‹è¯•å¤±è´¥å›è°ƒï¼š

``` js
// æŠŠåœ°å€æ”¹ä¸ºæ˜¯ä¸€ä¸ªä¸å­˜åœ¨çš„åœ°å€
ajax('/api/foo.json').then(function (res) {
  console.log(res)
}, function (error) {
  console.log(error)
})
```

![å¤±è´¥å›è°ƒ](assets/img/2021-08-19-18-33-03.png)

çŠ¶æ€æ–‡æœ¬æ˜¯æŒ‡ï¼š

![çŠ¶æ€æ–‡æœ¬](assets/img/2021-08-19-18-35-21.png)

ğŸ’¡ï¼šåœ¨æœ¬åœ°å‡†å¤‡ä¸€äº›`json`æ–‡ä»¶ï¼Œç”¨æ¥æ¨¡æ‹Ÿä¸€äº› API æ¥å£

![API](assets/img/2021-08-19-18-23-56.png)

---

ä»¥ä¸Šå°±æ˜¯é’ˆå¯¹äº`Promise`çš„ä¸€ä¸ªåŸºæœ¬çš„åº”ç”¨â€¦â€¦

## â˜…å¸¸è§è¯¯åŒº

é€šè¿‡å‰è¾¹çš„å°è¯•ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œä»è¡¨è±¡ä¸Šæ¥çœ‹ï¼ŒPromise çš„æœ¬è´¨ä¹Ÿå°±æ˜¯ä½¿ç”¨å›è°ƒå‡½æ•°çš„æ–¹å¼å»å®šä¹‰æˆ‘ä»¬å¼‚æ­¥ä»»åŠ¡ç»“æŸè¿‡åæ‰€éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚åªä¸è¿‡è¿™é‡Œçš„å›è°ƒå‡½æ•°æ˜¯é€šè¿‡`then`æ–¹æ³•ä¼ é€’è¿›å»çš„ï¼Œè€Œä¸”`Promise`å°†æˆ‘ä»¬çš„å›è°ƒåˆ†æˆäº†ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯ï¼š

- æˆåŠŸè¿‡åçš„å›è°ƒ -> è¢«å«åš`onFulfilled`
- å¤±è´¥è¿‡åçš„å›è°ƒ -> è¢«å«åš`onRejected`

![Promise](assets/img/2021-08-19-19-34-09.png)

å–„äºæ€è€ƒçš„ä½ ï¼Œè‚¯å®šä¼šæƒ³åˆ°ï¼Œæ—¢ç„¶è¿˜æ˜¯å›è°ƒå‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦**è¿ç»­ä¸²è”æ‰§è¡Œå¤šä¸ªå¼‚æ­¥ä»»åŠ¡**æ—¶ï¼Œè¿™ä»ç„¶ä¼šå‡ºç°å›è°ƒå‡½æ•°åµŒå¥—çš„é—®é¢˜å•Šï¼

æ¯”å¦‚ï¼š

![ä¾‹å­](assets/img/2021-08-19-19-41-12.png)

å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä»ç„¶ä¼šå½¢æˆå›è°ƒåœ°ç‹±ï¼Œè¿™æ ·ä½¿ç”¨ Promise ä¹Ÿå°±æ²¡æœ‰ä»»ä½•çš„æ„ä¹‰äº†ï¼Œè€Œä¸”è¿˜å¢åŠ äº†é¢å¤–çš„å¤æ‚åº¦ï¼Œè¿˜ä¸å¦‚ä½¿ç”¨ä¼ ç»Ÿçš„å›è°ƒæ–¹å¼äº†

å…¶å®è¿™ç§**åµŒå¥—ä½¿ç”¨çš„æ–¹å¼**æ˜¯æˆ‘ä»¬ä½¿ç”¨ Promise æœ€å¸¸è§çš„è¯¯åŒº

![è¯¯åŒº](assets/img/2021-08-19-19-43-29.png)

è€Œæ­£ç¡®çš„åšæ³•å®é™…ä¸Šæ˜¯å€ŸåŠ©äº Promise `then` æ–¹æ³•çš„é“¾å¼è°ƒç”¨çš„ç‰¹ç‚¹ï¼Œå°½é‡å»ä¿è¯æˆ‘ä»¬å¼‚æ­¥ä»»åŠ¡çš„**æ‰å¹³åŒ–**

![æ‰å¹³åŒ–](assets/img/2021-08-19-19-46-38.png)

å…·ä½“æ€ä¹ˆæ“ä½œï¼Œè¯·çœ‹ä¸‹è¾¹â€¦â€¦

## â˜…é“¾å¼è°ƒç”¨

ç›¸æ¯”äºä¼ ç»Ÿå›è°ƒå‡½æ•°çš„æ–¹å¼ï¼ŒPromise æœ€å¤§çš„ä¼˜åŠ¿å°±æ˜¯å¯ä»¥ã€Œ**é“¾å¼è°ƒç”¨**ã€

è¿™æ ·å°±èƒ½æœ€å¤§ç¨‹åº¦çš„é¿å…å›è°ƒåµŒå¥—

ğŸ’¡ï¼šå…·ä½“ä»£ç 

`then`æ–¹æ³•çš„ä½œç”¨ -> ä¸º Promise å¯¹è±¡æ·»åŠ çŠ¶æ€æ˜ç¡®åçš„å›è°ƒå‡½æ•°ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯`onFulfilled`å›è°ƒï¼Œå³æˆåŠŸè¿‡åçš„å›è°ƒï¼Œç¬¬äºŒä¸ªå‚æ•°åˆ™æ˜¯`onRejected`å›è°ƒï¼Œå³å¤±è´¥è¿‡åçš„å›è°ƒ

å…¶ä¸­ï¼Œã€Œå¤±è´¥è¿‡åçš„å›è°ƒã€å®é™…ä¸Šæ˜¯å¯ä»¥çœç•¥çš„

`then`æ–¹æ³•æœ€å¤§çš„ç‰¹ç‚¹æ˜¯å®ƒçš„å†…éƒ¨ä¹Ÿä¼šè¿”å›ä¸€ä¸ª`Promise`å¯¹è±¡

![è¿”å› Promise å¯¹è±¡](assets/img/2021-08-19-20-18-45.png)

æŒ‰ç…§ä»¥å¾€æˆ‘ä»¬å¯¹é“¾å¼è°ƒç”¨çš„è®¤çŸ¥ï¼Œè¿™é‡Œè¿”å›çš„`promise2`åº”è¯¥ä¹Ÿæ˜¯`promise`è¿™ä¸ªå¯¹è±¡

ç„¶

``` js
console.log(promise2 === promise) // false
```

å¯ä»¥çœ‹åˆ°å®ƒä»¬ä¿©å¹¶ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡å•Šï¼ -> å¹¶ä¸æ˜¯æˆ‘ä»¬ä»¥å¤–æ‰€ç†ŸçŸ¥çš„é‚£ç§åœ¨æ–¹æ³•å†…éƒ¨è¿”å›`this`çš„æ–¹å¼æ‰€å®ç°çš„é“¾å¼è°ƒç”¨ -> **è¿™ä¸€ç‚¹å°¤å…¶éœ€è¦æ³¨æ„**

æ€»ä¹‹ï¼Œè¿™é‡Œçš„`then`è¿”å›ä¸€ä¸ªå…¨æ–°çš„`Promise`å¯¹è±¡ -> å…¶ç›®çš„æ˜¯ä¸ºäº†å®ç°ã€Œ**Promise é“¾**ã€ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæ‰¿è¯ºç»“æŸäº†è¿‡åå†å»è¿”å›ä¸€ä¸ªæ–°çš„æ‰¿è¯º -> æ¯ä¸ªæ‰¿è¯ºéƒ½å¯ä»¥è´Ÿè´£ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œè€Œä¸”ç›¸äº’ä¹‹é—´åˆæ²¡æœ‰ä»€ä¹ˆå½±å“

è¿™æ„å‘³ç€æ¯ä¸ª`then`æ–¹æ³•å®é™…ä¸Šéƒ½æ˜¯åœ¨ä¸ºä¸Šä¸€ä¸ª`then`æ–¹æ³•æ‰€è¿”å›çš„`Promise`å¯¹è±¡æ·»åŠ çŠ¶æ€æ˜ç¡®è¿‡åçš„å›è°ƒ

![then](assets/img/2021-08-19-20-50-22.png)

åœ¨`then`é‡Œè¾¹æ‰‹åŠ¨è¿”å›ä¸€ä¸ª`Promise`å¯¹è±¡ï¼Œç­‰åŒäºè¿™æ ·ï¼š

![then çš„è¿”å›å€¼](assets/img/2021-08-19-20-52-20.png)

ä¸‹ä¸€ä¸ª`then`æ–¹æ³•å®é™…ä¸Šå°±æ˜¯åœ¨ä¸º`ajax('/api/urls.json')`è¿™ä¸ª`Promise`å¯¹è±¡å»æ·»åŠ çŠ¶æ€æ˜ç¡®è¿‡åçš„å›è°ƒï¼Œä¹Ÿå°±æ˜¯è¯´`ajax('/api/urls.json')`è¿™ä¸ª`ajax`è¯·æ±‚å®Œæˆè¿‡åï¼Œä¼šè‡ªåŠ¨æ‰§è¡Œä¸‹ä¸€ä¸ª`then`æ–¹æ³•å½“ä¸­çš„å›è°ƒ -> è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥é¿å…ä¸å¿…è¦çš„å›è°ƒåµŒå¥—äº† -> é‡åˆ°å¤šä¸ªè¿ç»­çš„ä»»åŠ¡ï¼Œé‚£å°±å¯ä»¥ä½¿ç”¨è¿™ç§é“¾å¼è°ƒç”¨çš„æ–¹å¼æ¥é¿å…å›è°ƒåµŒå¥—ï¼Œä»è€Œå°½é‡ä¿è¯ä»£ç çš„**æ‰å¹³åŒ–**

å¦‚æœå›è°ƒè¿”å›çš„ä¸æ˜¯`Promise`å¯¹è±¡ï¼Œè€Œæ˜¯ä¸€ä¸ªæ™®é€šçš„å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼å°±ä¼šä½œä¸ºå½“å‰è¿™ä¸ª`then`æ–¹æ³•æ‰€è¿”å›çš„é‚£ä¸ª`Promise`ä¸­çš„å€¼ -> ä¸‹ä¸€ä¸ª`then`æ–¹æ³•å½“ä¸­ï¼Œæ¥æ”¶çš„å›è°ƒå‚æ•°å®é™…ä¸Šæ‹¿åˆ°çš„å°±æ˜¯è¿™ä¸ªæ™®é€šçš„å€¼ -> å¦‚æœå›è°ƒå½“ä¸­æ²¡æœ‰è¿”å›ä»»ä½•å€¼ï¼Œé‚£é»˜è®¤è¿”å›çš„å°±æ˜¯ä¸€ä¸ª`undefined`äº†

ç¬¬ä¸€æ¬¡æ¥è§¦è¿™æ ·å†™å›è°ƒï¼Œå¯èƒ½ä¼šæœ‰ç‚¹ç»•ï¼Œæœ‰ç‚¹é¢ è¦†ä¹‹å‰ä¼ ç»Ÿå†™å›è°ƒçš„æ–¹å¼

æ‰€ä»¥åœ¨è¿™ï¼Œæˆ‘ä»¬å¯ä»¥ä»è¡¨è±¡ä¸Šå†å»æ€»ç»“ä¸€ä¸‹ï¼š

![é“¾å¼è°ƒç”¨](assets/img/2021-08-19-21-07-04.png)

> `then`çš„å›è°ƒè¿”å›äº†ä¸€ä¸ª`Promise`å¯¹è±¡ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ª`then`æ³¨å†Œçš„å›è°ƒå°±æ˜¯ä¸ºè¿™ä¸ª`Promise`å¯¹è±¡è€ŒæœåŠ¡çš„ï¼Œæ€»ä¹‹ï¼Œ`then`çš„å›è°ƒè¿”å›æ¥ä¸€ä¸ª`Promise`å®ä¾‹ï¼Œé‚£ä¹ˆä½ å°±åœ¨ä¸‹ä¸€ä¸ª`then`é‡Œè¾¹æ³¨å†Œç›¸åº”çš„å›è°ƒï¼

![æµ‹è¯•](assets/img/2021-08-19-21-28-10.png)

ğŸ’¡ï¼šäº†è§£`then`çš„æ‰§è¡Œæœºåˆ¶ï¼Ÿ

`then`çš„æ‰§è¡Œï¼Œä¼šæŠŠä¸¤ä¸ªå›è°ƒæ‰”åˆ°`promise.then()`è¿™ä¸ª`promise`çš„å›è°ƒé˜Ÿåˆ—é‡Œè¾¹å»ï¼Œå½“`promise`çš„å¼‚æ­¥ä»»åŠ¡è°ƒç”¨æˆåŠŸåï¼Œæ‰§è¡Œ`resolve`æ–¹æ³•ï¼Œä¼šæŠŠ`promise`çš„çŠ¶æ€`PromiseState`æ”¹ä¸º`fulfilled`ï¼Œä¸æ­¤åŒæ—¶ï¼ŒæŠŠ`PromiseResult`çš„å€¼èµ‹å€¼ä¸ºé‚£ä¸ªä¼ ç»™`resolve`æ–¹æ³•çš„å€¼ï¼Œç´§æ¥ç€è°ƒç”¨å›è°ƒæˆåŠŸé˜Ÿåˆ—é‡Œè¾¹çš„ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ä¼ ç»™`then`çš„æˆåŠŸå›è°ƒ

æµ‹è¯•ä»£ç ï¼š

``` js
console.log('******* ç¬¬ä¸€è½®ä»£ç  start *******')
const shop = true
const promise = new MyPromise((resolve, reject) => {
  console.log('---------- fn start ------------')
  console.log('ä½ è€çˆ¸æˆ‘å»ä¹°ç”µè„‘äº†')
  console.log('å¯åŠ¨æŒ‡ä»¤ï¼Œå¼€å¯å€’è®¡æ—¶â€¦â€¦')
  setTimeout(() => {
    console.log('******* ç¬¬äºŒè½®ä»£ç  start *******')
    if (shop) {
      console.log('>= 2s è¿‡å»äº†ã€‚..')
      console.log(n,'è°ƒç”¨ resolve')
      resolve('å„¿å­ï¼Œä½ çš„ç”µè„‘æ¥äº†')
    } else {
      reject('å¯¹ä¸èµ·ï¼Œå„¿å­ï¼Œé—¨åº—æ²¡å¼€é—¨â€¦â€¦')
    }
    console.log('******* ç¬¬äºŒè½®ä»£ç  end *******')
  }, 2000)
  console.log('---------- fn end ------------')
})

const xxx = promise.then((res) => {
  console.log('----------then1------------')
  console.log('onFulfilled start')
  console.log(res)
  console.log('æˆ‘å¾ˆå¼€å¿ƒ')
  console.log('è¿™ä¸ª then æ²¡æœ‰è¿”å› Promise')
  console.log('onFulfilled end')
  console.log('----------then1------------')
}, (error) => {
  console.log(error)
  console.log('æˆ‘å¾ˆå¤±è½')
})
console.log(xxx)
console.log('******* ç¬¬ä¸€è½®ä»£ç  end *******')
```

log æ—¥å¿—ï¼š

``` html
******* ç¬¬ä¸€è½®ä»£ç  start *******
-------æ„é€  Promise å®ä¾‹ start-------
init statusã€value çš„çŠ¶æ€
init æˆåŠŸæ€/å¤±è´¥æ€ å›è°ƒå‡½æ•°é˜Ÿåˆ—
å£°æ˜ resolve/reject å‡½æ•°
è°ƒç”¨ä¼ ç»™ new Promise(fn) çš„ fnï¼Œä¸¤ä¸ªå®å‚æ˜¯ resolveã€reject
---------- fn start ------------
ä½ è€çˆ¸æˆ‘å»ä¹°ç”µè„‘äº†
å¯åŠ¨æŒ‡ä»¤ï¼Œå¼€å¯å€’è®¡æ—¶â€¦â€¦
---------- fn end ------------
-------æ„é€  Promise å®ä¾‹ end-------
then æ‰§è¡Œå¼€å§‹
åˆ¤æ–­ä¼ å…¥çš„å›è°ƒ onFulfilled/onReject æ˜¯å¦æ˜¯ä¸ªå‡½æ•°
-------æ„é€  Promise å®ä¾‹ start-------
init statusã€value çš„çŠ¶æ€
init æˆåŠŸæ€/å¤±è´¥æ€ å›è°ƒå‡½æ•°é˜Ÿåˆ—
å£°æ˜ resolve/reject å‡½æ•°
è°ƒç”¨ä¼ ç»™ new Promise(fn) çš„ fnï¼Œä¸¤ä¸ªå®å‚æ˜¯ resolveã€reject
@@@@@@@ then fn start @@@@@@@
then è¿”å›äº†ä¸€ä¸ª Promiseï¼Œè¯¥ Promise çš„å‡½æ•°å‚æ•°å¼€å§‹åŒæ­¥æ‰§è¡Œ
å£°æ˜ä¸€ä¸ª fulfilled å‡½æ•°
å£°æ˜ä¸€ä¸ª rejected å‡½æ•°
åˆ¤æ–­æ‰¿è¯ºçš„çŠ¶æ€
ä¸º PENDING æ€ï¼ŒæŠŠ fulfilled/rejected åŠ å…¥åˆ° æˆåŠŸ/å¤±è´¥ å›è°ƒé˜Ÿåˆ—ä¸­â€¦
then æ‰§è¡Œç»“æŸäº†ï¼Œè¿”å›äº†ä¸€ä¸ª Promise å®ä¾‹
@@@@@@@ then fn end @@@@@@@
-------æ„é€  Promise å®ä¾‹ end-------
MyPromise {
  status: 'PENDING',
  value: null,
  reason: null,
  onFulfilledCallbacks: [],
  onRejectedCallbacks: []
}
******* ç¬¬ä¸€è½®ä»£ç  end *******
******* ç¬¬äºŒè½®ä»£ç  start *******
>= 2s è¿‡å»äº†ã€‚..
1 è°ƒç”¨ resolve
resolve start
æ›´æ”¹ promise.then() è¿™ä¸ª promise çš„çŠ¶æ€å’Œç»“æœ
éå† fulfilled æˆåŠŸå›è°ƒé˜Ÿåˆ—ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰è¦è°ƒç”¨ fulfilled å‡½æ•°â€¦â€¦
æœ‰ fulfilled å‡½æ•°
$$$$$$$$$$$$$$$$$$$$$$$$ fulfilled æ‰§è¡Œ $$$$$$$$$$$$$$$$$$$$$$$$
è°ƒç”¨ then çš„ç¬¬ä¸€ä¸ªå‚æ•° onFulfilledï¼Œå¹¶ä¸”æŠŠè¿™ä¸ª promise çš„ç»“æœä¼ ç»™è¯¥å›è°ƒå‡½æ•°
----------then1------------
onFulfilled start
å„¿å­ï¼Œä½ çš„ç”µè„‘æ¥äº†
æˆ‘å¾ˆå¼€å¿ƒ
è¿™ä¸ª then æ²¡æœ‰è¿”å› Promise
onFulfilled end
----------then1------------
æ‹¿åˆ° onFulfilled çš„è¿”å›å€¼ p2
å¦‚æœ p2 æ˜¯ä¸€ä¸ª Promise å®ä¾‹ï¼Œé‚£å°±ç»§ç»­ p2.then()ï¼Œå¹¶æŠŠä¸‹ä¸€ä¸ª then çš„å‚æ•° onFulfilledã€onReject ä½œä¸º p2.then() çš„ä¸¤ä¸ªå®å‚
å¦‚æœ p2 ä¸æ˜¯ï¼Œé‚£å°±è°ƒç”¨ resolve(p2)
resolve start
æ›´æ”¹ promise.then() è¿™ä¸ª promise çš„çŠ¶æ€å’Œç»“æœ
éå† fulfilled æˆåŠŸå›è°ƒé˜Ÿåˆ—ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰è¦è°ƒç”¨ fulfilled å‡½æ•°â€¦â€¦
1 æ²¡æœ‰ fulfilled å‡½æ•°ï¼Œè°ƒç”¨ resolve ç»“æŸ
$$$$$$$$$$$$$$$$$$$$$$$$ fulfilled è°ƒç”¨ç»“æŸ $$$$$$$$$$$$$$$$$$$$$$$$
2 æ²¡æœ‰ fulfilled å‡½æ•°ï¼Œè°ƒç”¨ resolve ç»“æŸ
******* ç¬¬äºŒè½®ä»£ç  end *******
```

æç‚¼çŸ¥è¯†ç‚¹ï¼š

- è¿”å›ä¸€ä¸ª`Promise`åšäº†ä»€ä¹ˆï¼Ÿ
  - åœ¨ `new Promise((resolve,reject)=>{})`å®ä¾‹çš„è¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œäº†è¿™ä¸ª`(resolve,reject)=>{}`ï¼ˆé—­åŒ…ï¼‰ï¼Œ`resolve`å’Œ`reject`è¿™ä¸¤ä¸ªåå­—å¯ä»¥éšæ„èµ·
    - `Promise`æ„é€ å™¨å†…éƒ¨å£°æ˜äº†ä¸¤ä¸ªå‡½æ•°`resolve`ã€`reject`
      - `resolve`å’Œ`reject`éƒ½æ˜¯åŒæ­¥`API`
      - `resolve` -> æ›´æ”¹`Promise`å®ä¾‹çŠ¶æ€ï¼šä»`PENDING`åˆ°`FULFILLED`ï¼Œä»¥åŠæ›´æ”¹`Promise`å®ä¾‹çš„ç»“æœå€¼ï¼ˆå¼‚æ­¥ä»»åŠ¡çš„ç»“æœï¼‰ -> éå†æˆåŠŸå›è°ƒé˜Ÿåˆ—ï¼Œæ‰§è¡Œ`then`çš„ç¬¬ä¸€ä¸ªå‚æ•°
      - `reject` -> åŸºæœ¬åŒä¸Š
- `new Promise((resolve,reject)=>{}).then(success,error).then().then()â€¦â€¦`åšäº†ä»€ä¹ˆï¼Ÿ
  - `(resolve,reject)=>{}`æ‰§è¡Œäº†ï¼Œ`then1`æ‰§è¡Œäº†ï¼Œ`then2`æ‰§è¡Œäº†ï¼Œ`then3`æ‰§è¡Œäº†â€¦â€¦
    - `then`çš„æ‰§è¡Œåšäº†ä»€ä¹ˆï¼Ÿ
      - è¿”å›ä¸€ä¸ªæ–°çš„`Promise`å¯¹è±¡ï¼Œæ—¢ç„¶è¿”å›ï¼Œé‚£å°±ä¼šæœ‰ä¸€ä¸ª`(resolve,reject)=>{}`è¢«æ‰§è¡Œ -> è¿™æ„å‘³ç€å®ƒä¸ä¸‹ä¸€ä¸ª`then`æœ‰å…³è”
      - `(resolve,reject)=>{}`ä¸»è¦æ˜¯æŠŠ`success`/`error`è¿™ä¸¤ä¸ªå‡½æ•°æ‰”åˆ°æˆåŠŸå›è°ƒé˜Ÿåˆ—/å¤±è´¥å›è°ƒé˜Ÿåˆ—
      - `p.then(s1,e1)` -> `s1`çŸ¥é“`p`çš„çŠ¶æ€å’Œå€¼
- å¼‚æ­¥ä»»åŠ¡ç»“æŸäº†ï¼Œè°ƒç”¨`resolve('data')` -> ä¸»è¦æ˜¯æ‰§è¡Œ`success`æ–¹æ³•
  - `success`æ–¹æ³•è¿”å›çš„ä¸æ˜¯ä¸€ä¸ª`Promise`å®ä¾‹ -> é‚£å°±è°ƒç”¨ä¸‹ä¸€ä¸ª`then`çš„`success` -> `resolve(result)` -> `resolve`å¤„ç†çš„æ‰¿è¯ºæ˜¯ä¸€ä¸ª`Pending`çŠ¶æ€çš„æ–°æ‰¿è¯ºï¼Œä¹Ÿå°±æ˜¯`then`è¿”å›çš„é‚£ä¸ªæ‰¿è¯º
  - è¿”å›çš„æ˜¯ä¸€ä¸ª`Promise`å®ä¾‹ -> ä¹Ÿå°±æ˜¯åœ¨ä¸€ä¸ªå›è°ƒé‡Œè¾¹å¼€å¯äº†ä¸€ä¸ªæ–°çš„æ‰¿è¯ºï¼ˆæŠŠ`then`è¿”å›çš„æ‰¿è¯ºæ‰”äº†ï¼Œä¸‹ä¸€ä¸ª`then`é‡Œè¾¹å›è°ƒç”¨è¿™ä¸ªå›è°ƒè¿”å›çš„æ–°æ‰¿è¯ºï¼‰ -> åœ¨è¿™ä¸ªå›è°ƒç»“æŸå‰ï¼Œç»‘å®šä¸‹ä¸€ä¸ª`then`æ–¹æ³• -> `p.then(resolve,reject)`ï¼ˆå®ŒæˆåŒæ­¥ä»£ç çš„æ‰§è¡Œï¼‰ -> ä¹Ÿå°±æ˜¯é‚£ä¸¤ä¸ªæˆåŠŸå›è°ƒé˜Ÿåˆ—å’Œå¤±è´¥å›è°ƒé˜Ÿåˆ—ï¼ˆè¿™ä¸¤ä¸ªé˜Ÿåˆ—éƒ½æŒæœ‰ä¸‹ä¸€ä¸ª`then`çš„å¯¹åº”çš„å›è°ƒï¼‰

![Promise è¿è¡Œé€»è¾‘](assets/img/2021-08-20-11-53-51.png)

â¹ï¼š[Promise.thenæ˜¯å¦‚ä½•å®ç°é“¾å¼è°ƒç”¨çš„](https://juejin.cn/post/6883121706123132936)

â¹ï¼š[å›¾è§£ Promise å®ç°åŸç†ï¼ˆä¸€ï¼‰â€”â€” åŸºç¡€å®ç° - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/58428287)

ğŸ’¡ï¼šæ‰§è¡Œæ—¶åº

![æ—¶åº](assets/img/2021-08-20-11-19-35.png)

## â˜…å¼‚å¸¸å¤„ç†
