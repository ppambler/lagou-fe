### âœï¸ Tangxt â³ 2021-08-24 ğŸ·ï¸ Asynchronous

# 02-3-Generator å¼‚æ­¥æ–¹æ¡ˆã€Async å‡½æ•°

## â˜…å‰è¨€

1ï¼‰Promise vs Callback

ğŸ’¡ï¼šå®šä¹‰ä¸€ä¸ª`ajax`å‡½æ•°ï¼Œè®©å®ƒæ—¢å¯ä»¥å¾€`then`ä¼ å›è°ƒï¼Œåˆå¯ä»¥å¾€å®ƒç¬¬äºŒä¸ªå‚æ•°ä¼ å›è°ƒï¼Ÿ

``` js
function ajax(url, callback) {
  const executor = (resolve, reject) => {
    var xhr = new XMLHttpRequest()
    xhr.open('GET', url)
    xhr.responseType = 'json'
    xhr.onload = () => {
      if (xhr.status === 200) {
        resolve(xhr.response)
      } else {
        reject(new Error(xhr.statusText))
      }
    }
    xhr.send()
  }

  if (typeof callback === 'function') {
    // support callback
    executor(
      res => callback(null, res),
      err => callback(err)
    )
    return undefined
  }

  return new Promise(executor)
}
```

æµ‹è¯•ä»£ç ï¼š

![æµ‹è¯•ä»£ç ](assets/img/2021-08-24-15-08-37.png)

ğŸ’¡ï¼šCallback çš„é—®é¢˜ï¼Ÿ

![Callback](assets/img/2021-08-24-15-09-38.png)

ğŸ’¡ï¼šå¦‚ä½•è§£å†³å›åˆ°åœ°ç‹±é—®é¢˜ï¼Ÿ

![Promise chain](assets/img/2021-08-24-15-11-19.png)

ğŸ’¡ï¼šå¦‚ä½•è§£å†³å¼‚æ­¥ä»£ç ä¸å¥½é˜…è¯»çš„é—®é¢˜ï¼Ÿ

![å¼‚æ­¥ä»£ç ä¸å¥½é˜…è¯»](assets/img/2021-08-24-15-17-59.png)

ğŸ’¡ï¼šå°ç»“

![åŒºåˆ«](assets/img/2021-08-24-15-16-36.png)

## â˜…Generator å¼‚æ­¥æ–¹æ¡ˆï¼ˆä¸Šï¼‰

> å›é¡¾ Generator å‡½æ•°

1ï¼‰æ¦‚è¿°

ç›¸æ¯”äºä¼ ç»Ÿçš„å›è°ƒå§¿åŠ¿ï¼ŒPromise å»å¤„ç†å¼‚æ­¥è°ƒç”¨æœ€å¤§çš„ä¼˜åŠ¿å°±æ˜¯å¯ä»¥é€šè¿‡é“¾å¼è°ƒç”¨è§£å†³å›è°ƒåµŒå¥—è¿‡æ·±çš„é—®é¢˜

ä½¿ç”¨ Promise å¤„ç†å¼‚æ­¥ä»»åŠ¡çš„ä¸²è”æ‰§è¡Œï¼Œå®ƒçš„è¡¨ç°å°±æ˜¯ä¸€ä¸ª`then`ç„¶åå¤„ç†ä¸€ä¸ªå¼‚æ­¥è°ƒç”¨ï¼Œæœ€ç»ˆæ•´ä½“ä¼šå½¢æˆä¸€ä¸ªä»»åŠ¡çš„é“¾æ¡ï¼Œä»è€Œå®ç°æ‰€æœ‰ä»»åŠ¡çš„ä¸²è”æ‰§è¡Œ

![ä¸²è”æ‰§è¡Œ](assets/img/2021-08-24-15-02-00.png)

ä½†æ˜¯ï¼Œè¿™æ ·å†™ä»ç„¶ä¼šæœ‰å¤§é‡çš„å›è°ƒå‡½æ•°ï¼Œè™½ç„¶å®ƒä»¬ç›¸äº’ä¹‹é—´æ²¡æœ‰åµŒå¥—ï¼Œä½†æ˜¯å®ƒä»¬è¿˜æ˜¯æ²¡æ³•è¾¾åˆ°æˆ‘ä»¬ä¼ ç»ŸåŒæ­¥ä»£ç çš„é‚£ç§å¯è¯»æ€§

å¦‚æœæ˜¯ä¼ ç»ŸåŒæ­¥ä»£ç å§¿åŠ¿ï¼Œé‚£æˆ‘ä»¬çš„ä»£ç å¯èƒ½å°±æ˜¯è¿™ä¸ªæ ·å­ï¼š

![åŒæ­¥ä»£ç ](assets/img/2021-08-24-15-03-22.png)

å¾ˆæ˜æ˜¾è¿™ç§æ–¹å¼å»å†™æˆ‘ä»¬çš„å¼‚æ­¥ä»£ç  -> å®ƒæ˜¯æœ€ç®€æ´ï¼Œä¹Ÿæ˜¯æœ€å®¹æ˜“é˜…è¯»å’Œç†è§£çš„

ğŸ’¡ï¼šå¾®ä»»åŠ¡ä¹Ÿæ˜¯éœ€è¦æ’é˜Ÿçš„ï¼Ÿ

![å¾®ä»»åŠ¡](assets/img/2021-08-24-17-46-01.png)

ğŸ‘‡ï¼šçœ‹çœ‹ä¸¤ç§æ›´ä¼˜çš„å¼‚æ­¥ç¼–ç¨‹å†™æ³•

2ï¼‰ES2015 æä¾›çš„ Generator

ä¹‹å‰å·²ç»ç®€å•äº†è§£è¿‡ç”Ÿæˆå™¨å‡½æ•°çš„è¯­æ³•ä»¥åŠå®ƒçš„ä¸€äº›åŸºæœ¬ç‰¹ç‚¹ï¼Œåœ¨è¿™é‡Œï¼Œå°±ç®€å•å¤ä¹ ä¸€ä¸‹

ğŸ’¡ï¼šè¯­æ³•

![è¯­æ³•](assets/img/2021-08-24-18-57-53.png)

![å‚æ•°](assets/img/2021-08-24-18-59-24.png)

> `next()`æœ‰è¿”å›å€¼ï¼Œè€Œ`yield`ä¹Ÿæœ‰è¿”å›å€¼ï¼Œä½ ç»™`next()`ä¼ çš„å‚æ•°å°±æ˜¯å®ƒçš„è¿”å›å€¼ï¼Œä¸ä¼ å°±æ˜¯`undefined`å€¼ -> `yield`ç›¸å½“äºæ˜¯æš‚åœäº†ï¼Œ`yield`å³è¾¹çš„å€¼ï¼ˆç«™åœ¨`yield`è¿™ä¸ªé—¨å‰çš„å€¼ï¼‰æ˜¯`{value,done}`é‡Œè¾¹çš„`value`å€¼ï¼Œä¸‹ä¸€ä¸ª`next`çš„å‚æ•°ï¼Œç›¸å½“äºæ˜¯æœ‰ä¸€ä¸ªå€¼æ‰“ç ´äº†`yield`è¿™æ‰‡é—¨ï¼ŒæŠ•å…¥äº†`res`çš„æ€€æŠ±
> 
> `generator.throw`åŒ`next`ä¸€æ ·ï¼Œ`res1`æ±‚å€¼æ—¶ï¼ŒæŠ›äº†ä¸ªå¼‚å¸¸ç½¢äº†

![å‚æ•°å€¼](assets/img/2021-08-24-19-13-04.png)

> å¦‚æœä½ ç»™ç¬¬äºŒä¸ª`next`ä¼ äº†ä¸€ä¸ª`new Error('xxx')`é”™è¯¯å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™æ˜¯ä¸ä¼šæŠŠé”™è¯¯ç»™æŠ›å‡ºçš„ï¼Œè¿™ä¼šå½“ä½œæ˜¯ä¸€ä¸ªæ™®é€šçš„é”™è¯¯å¯¹è±¡å€¼èµ‹å€¼ç»™`res`

- é¦–å…ˆï¼Œåœ¨æ™®é€šå‡½æ•°åŸºç¡€ä¹‹ä¸Šå¤šäº†ä¸€ä¸ª`*`
  - è°ƒç”¨è¿™ä¸ªç”Ÿæˆå™¨å‡½æ•°å¹¶ä¸ä¼šç«‹å³å»æ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œè€Œæ˜¯å¾—åˆ°çš„ä¸€ä¸ªç”Ÿæˆå™¨å¯¹è±¡
  - ç›´åˆ°æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„`next`æ–¹æ³•ï¼Œè¿™ä¸ªå‡½æ•°çš„å‡½æ•°ä½“æ‰ä¼šå¼€å§‹æ‰§è¡Œ
- å…¶æ¬¡ï¼Œåœ¨å‡½æ•°å†…éƒ¨å¯ä»¥éšæ—¶ä½¿ç”¨`yield`å…³é”®è¯ï¼Œå‘å¤–å»è¿”å›ä¸€ä¸ªå€¼
  - åœ¨`next`æ–¹æ³•è¿”å›çš„å¯¹è±¡å½“ä¸­å»æ‹¿åˆ°è¿™æ ·ä¸€ä¸ªè¿”å›çš„å€¼ï¼Œå¦å¤–ï¼Œè¿”å›çš„è¿™ä¸ªå¯¹è±¡è¿˜æœ‰ä¸€ä¸ª`done`å±æ€§ï¼Œç”¨æ¥è¡¨ç¤ºè¿™ä¸ªç”Ÿæˆå™¨æ˜¯å¦å·²ç»å…¨éƒ¨æ‰§è¡Œå®Œäº†
  - è€Œä¸”ï¼Œ`yield`å…³é”®è¯å¹¶ä¸ä¼šåƒ`return`è¯­å¥ä¸€æ ·ç«‹å³å»ç»“æŸè¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œï¼Œå®ƒåªæ˜¯æš‚åœè¿™ä¸ªç”Ÿæˆå™¨å‡½æ•°çš„æ‰§è¡Œï¼Œç›´åˆ°å¤–ç•Œä¸‹ä¸€æ¬¡è°ƒç”¨ç”Ÿæˆå™¨å¯¹è±¡çš„`next`æ–¹æ³•ï¼Œæ‰ä¼šç»§ç»­ä»`yield`è¿™ä¸ªä½ç½®å¾€ä¸‹æ‰§è¡Œ
- å¦å¤–ï¼Œè°ƒç”¨`next`æ–¹æ³•æ—¶ï¼Œä¼ å…¥äº†ä¸€ä¸ªå‚æ•°ï¼Œå¦‚`bar`ï¼Œé‚£ä¹ˆè¿™ä¸ªå‚æ•°ä¼šä½œä¸º`yield`è¿™ä¸ªè¯­å¥çš„è¿”å›å€¼ -> è¯´ç™½äº†ï¼Œ`yield 'foo'`æ˜¯æœ‰è¿”å›å€¼çš„ï¼ˆç›¸å½“äºæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼‰ï¼Œåœ¨`yield`çš„å·¦è¾¹å¯ä»¥æ¥æ”¶åˆ°è¿™ä¸ªå€¼
- è¿˜æœ‰ï¼Œæ‰‹åŠ¨è°ƒç”¨ç”Ÿæˆå™¨å¯¹è±¡çš„`throw`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯ä»¥åœ¨ç”Ÿæˆå™¨å‡½æ•°å†…éƒ¨æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ -> å®ƒåŒ`next`ä¸€æ ·ä¹Ÿä¼šè®©ç”Ÿæˆå™¨å‡½æ•°å¾€ä¸‹æ‰§è¡Œï¼Œä¸è¿‡å®ƒçš„ä½œç”¨æ˜¯æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸

ğŸ’¡ï¼š`yield` çš„æ„æ€ï¼Ÿ

![yield](assets/img/2021-08-24-19-42-22.png)

â¹ï¼š[yield - JavaScript - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/yield)

---

ç†è§£äº†ç”Ÿæˆå™¨å‡½æ•°çš„ç‰¹ç‚¹ä»¥åŠå®ƒçš„æ‰§è¡Œè¿‡ç¨‹è¿‡åï¼Œä¸‹ä¸€æ­¥æ˜¯çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ Generator å»ç®¡ç†æˆ‘ä»¬çš„å¼‚æ­¥æµç¨‹

## â˜…Generator å¼‚æ­¥æ–¹æ¡ˆï¼ˆä¸­ï¼‰