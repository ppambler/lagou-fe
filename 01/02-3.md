### âœï¸ Tangxt â³ 2021-08-24 ğŸ·ï¸ Asynchronous

# 02-3-Generator å¼‚æ­¥æ–¹æ¡ˆã€Async å‡½æ•°

## â˜…å‰è¨€

### <mark>1ï¼‰Promise vs Callback</mark>

ğŸ’¡ï¼šå®šä¹‰ä¸€ä¸ª`ajax`å‡½æ•°ï¼Œè®©å®ƒæ—¢å¯ä»¥å¾€`then`ä¼ å›è°ƒï¼Œåˆå¯ä»¥å¾€å®ƒç¬¬äºŒä¸ªå‚æ•°ä¼ å›è°ƒï¼Ÿ

``` js
function ajax(url, callback) {
  const executor = (resolve, reject) => {
    var xhr = new XMLHttpRequest()
    xhr.open('GET', url)
    xhr.responseType = 'json'
    xhr.onload = () => {
      if (xhr.status === 200) {
        resolve(xhr.response)
      } else {
        reject(new Error(xhr.statusText))
      }
    }
    xhr.send()
  }

  if (typeof callback === 'function') {
    // support callback
    executor(
      res => callback(null, res),
      err => callback(err)
    )
    return undefined
  }

  return new Promise(executor)
}
```

æµ‹è¯•ä»£ç ï¼š

![æµ‹è¯•ä»£ç ](assets/img/2021-08-24-15-08-37.png)

ğŸ’¡ï¼šCallback çš„é—®é¢˜ï¼Ÿ

![Callback](assets/img/2021-08-24-15-09-38.png)

ğŸ’¡ï¼šå¦‚ä½•è§£å†³å›åˆ°åœ°ç‹±é—®é¢˜ï¼Ÿ

![Promise chain](assets/img/2021-08-24-15-11-19.png)

ğŸ’¡ï¼šå¦‚ä½•è§£å†³å¼‚æ­¥ä»£ç ä¸å¥½é˜…è¯»çš„é—®é¢˜ï¼Ÿ

![å¼‚æ­¥ä»£ç ä¸å¥½é˜…è¯»](assets/img/2021-08-24-15-17-59.png)

ğŸ’¡ï¼šå°ç»“

![åŒºåˆ«](assets/img/2021-08-24-15-16-36.png)

## â˜…Generator å¼‚æ­¥æ–¹æ¡ˆï¼ˆä¸Šï¼‰

> å›é¡¾ Generator å‡½æ•°

### <mark>1ï¼‰æ¦‚è¿°</mark>

ç›¸æ¯”äºä¼ ç»Ÿçš„å›è°ƒå§¿åŠ¿ï¼ŒPromise å»å¤„ç†å¼‚æ­¥è°ƒç”¨æœ€å¤§çš„ä¼˜åŠ¿å°±æ˜¯å¯ä»¥é€šè¿‡é“¾å¼è°ƒç”¨è§£å†³å›è°ƒåµŒå¥—è¿‡æ·±çš„é—®é¢˜

ä½¿ç”¨ Promise å¤„ç†å¼‚æ­¥ä»»åŠ¡çš„ä¸²è”æ‰§è¡Œï¼Œå®ƒçš„è¡¨ç°å°±æ˜¯ä¸€ä¸ª`then`ç„¶åå¤„ç†ä¸€ä¸ªå¼‚æ­¥è°ƒç”¨ï¼Œæœ€ç»ˆæ•´ä½“ä¼šå½¢æˆä¸€ä¸ªä»»åŠ¡çš„é“¾æ¡ï¼Œä»è€Œå®ç°æ‰€æœ‰ä»»åŠ¡çš„ä¸²è”æ‰§è¡Œ

![ä¸²è”æ‰§è¡Œ](assets/img/2021-08-24-15-02-00.png)

ä½†æ˜¯ï¼Œè¿™æ ·å†™ä»ç„¶ä¼šæœ‰å¤§é‡çš„å›è°ƒå‡½æ•°ï¼Œè™½ç„¶å®ƒä»¬ç›¸äº’ä¹‹é—´æ²¡æœ‰åµŒå¥—ï¼Œä½†æ˜¯å®ƒä»¬è¿˜æ˜¯æ²¡æ³•è¾¾åˆ°æˆ‘ä»¬ä¼ ç»ŸåŒæ­¥ä»£ç çš„é‚£ç§å¯è¯»æ€§

å¦‚æœæ˜¯ä¼ ç»ŸåŒæ­¥ä»£ç å§¿åŠ¿ï¼Œé‚£æˆ‘ä»¬çš„ä»£ç å¯èƒ½å°±æ˜¯è¿™ä¸ªæ ·å­ï¼š

![åŒæ­¥ä»£ç ](assets/img/2021-08-24-15-03-22.png)

å¾ˆæ˜æ˜¾è¿™ç§æ–¹å¼å»å†™æˆ‘ä»¬çš„å¼‚æ­¥ä»£ç  -> å®ƒæ˜¯æœ€ç®€æ´ï¼Œä¹Ÿæ˜¯æœ€å®¹æ˜“é˜…è¯»å’Œç†è§£çš„

ğŸ’¡ï¼šå¾®ä»»åŠ¡ä¹Ÿæ˜¯éœ€è¦æ’é˜Ÿçš„ï¼Ÿ

![å¾®ä»»åŠ¡](assets/img/2021-08-24-17-46-01.png)

ğŸ‘‡ï¼šçœ‹çœ‹ä¸¤ç§æ›´ä¼˜çš„å¼‚æ­¥ç¼–ç¨‹å†™æ³•

### <mark>2ï¼‰ES2015 æä¾›çš„ Generator</mark>

ä¹‹å‰å·²ç»ç®€å•äº†è§£è¿‡ç”Ÿæˆå™¨å‡½æ•°çš„è¯­æ³•ä»¥åŠå®ƒçš„ä¸€äº›åŸºæœ¬ç‰¹ç‚¹ï¼Œåœ¨è¿™é‡Œï¼Œå°±ç®€å•å¤ä¹ ä¸€ä¸‹

ğŸ’¡ï¼šè¯­æ³•

![è¯­æ³•](assets/img/2021-08-24-18-57-53.png)

![å‚æ•°](assets/img/2021-08-24-18-59-24.png)

> `next()`æœ‰è¿”å›å€¼ï¼Œè€Œ`yield`ä¹Ÿæœ‰è¿”å›å€¼ï¼Œä½ ç»™`next()`ä¼ çš„å‚æ•°å°±æ˜¯å®ƒçš„è¿”å›å€¼ï¼Œä¸ä¼ å°±æ˜¯`undefined`å€¼ -> `yield`ç›¸å½“äºæ˜¯æš‚åœäº†ï¼Œ`yield`å³è¾¹çš„å€¼ï¼ˆç«™åœ¨`yield`è¿™ä¸ªé—¨å‰çš„å€¼ï¼‰æ˜¯`{value,done}`é‡Œè¾¹çš„`value`å€¼ï¼Œä¸‹ä¸€ä¸ª`next`çš„å‚æ•°ï¼Œç›¸å½“äºæ˜¯æœ‰ä¸€ä¸ªå€¼æ‰“ç ´äº†`yield`è¿™æ‰‡é—¨ï¼ŒæŠ•å…¥äº†`res`çš„æ€€æŠ±
> 
> `generator.throw`åŒ`next`ä¸€æ ·ï¼Œ`res1`æ±‚å€¼æ—¶ï¼ŒæŠ›äº†ä¸ªå¼‚å¸¸ç½¢äº†

![å‚æ•°å€¼](assets/img/2021-08-24-19-13-04.png)

> å¦‚æœä½ ç»™ç¬¬äºŒä¸ª`next`ä¼ äº†ä¸€ä¸ª`new Error('xxx')`é”™è¯¯å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™æ˜¯ä¸ä¼šæŠŠé”™è¯¯ç»™æŠ›å‡ºçš„ï¼Œè¿™ä¼šå½“ä½œæ˜¯ä¸€ä¸ªæ™®é€šçš„é”™è¯¯å¯¹è±¡å€¼èµ‹å€¼ç»™`res`

- é¦–å…ˆï¼Œåœ¨æ™®é€šå‡½æ•°åŸºç¡€ä¹‹ä¸Šå¤šäº†ä¸€ä¸ª`*`
  - è°ƒç”¨è¿™ä¸ªç”Ÿæˆå™¨å‡½æ•°å¹¶ä¸ä¼šç«‹å³å»æ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œè€Œæ˜¯å¾—åˆ°çš„ä¸€ä¸ªç”Ÿæˆå™¨å¯¹è±¡
  - ç›´åˆ°æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„`next`æ–¹æ³•ï¼Œè¿™ä¸ªå‡½æ•°çš„å‡½æ•°ä½“æ‰ä¼šå¼€å§‹æ‰§è¡Œ
- å…¶æ¬¡ï¼Œåœ¨å‡½æ•°å†…éƒ¨å¯ä»¥éšæ—¶ä½¿ç”¨`yield`å…³é”®è¯ï¼Œå‘å¤–å»è¿”å›ä¸€ä¸ªå€¼
  - åœ¨`next`æ–¹æ³•è¿”å›çš„å¯¹è±¡å½“ä¸­å»æ‹¿åˆ°è¿™æ ·ä¸€ä¸ªè¿”å›çš„å€¼ï¼Œå¦å¤–ï¼Œè¿”å›çš„è¿™ä¸ªå¯¹è±¡è¿˜æœ‰ä¸€ä¸ª`done`å±æ€§ï¼Œç”¨æ¥è¡¨ç¤ºè¿™ä¸ªç”Ÿæˆå™¨æ˜¯å¦å·²ç»å…¨éƒ¨æ‰§è¡Œå®Œäº†
  - è€Œä¸”ï¼Œ`yield`å…³é”®è¯å¹¶ä¸ä¼šåƒ`return`è¯­å¥ä¸€æ ·ç«‹å³å»ç»“æŸè¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œï¼Œå®ƒåªæ˜¯æš‚åœè¿™ä¸ªç”Ÿæˆå™¨å‡½æ•°çš„æ‰§è¡Œï¼Œç›´åˆ°å¤–ç•Œä¸‹ä¸€æ¬¡è°ƒç”¨ç”Ÿæˆå™¨å¯¹è±¡çš„`next`æ–¹æ³•ï¼Œæ‰ä¼šç»§ç»­ä»`yield`è¿™ä¸ªä½ç½®å¾€ä¸‹æ‰§è¡Œ
- å¦å¤–ï¼Œè°ƒç”¨`next`æ–¹æ³•æ—¶ï¼Œä¼ å…¥äº†ä¸€ä¸ªå‚æ•°ï¼Œå¦‚`bar`ï¼Œé‚£ä¹ˆè¿™ä¸ªå‚æ•°ä¼šä½œä¸º`yield`è¿™ä¸ªè¯­å¥çš„è¿”å›å€¼ -> è¯´ç™½äº†ï¼Œ`yield 'foo'`æ˜¯æœ‰è¿”å›å€¼çš„ï¼ˆç›¸å½“äºæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼‰ï¼Œåœ¨`yield`çš„å·¦è¾¹å¯ä»¥æ¥æ”¶åˆ°è¿™ä¸ªå€¼
- è¿˜æœ‰ï¼Œæ‰‹åŠ¨è°ƒç”¨ç”Ÿæˆå™¨å¯¹è±¡çš„`throw`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯ä»¥åœ¨ç”Ÿæˆå™¨å‡½æ•°å†…éƒ¨æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ -> å®ƒåŒ`next`ä¸€æ ·ä¹Ÿä¼šè®©ç”Ÿæˆå™¨å‡½æ•°å¾€ä¸‹æ‰§è¡Œï¼Œä¸è¿‡å®ƒçš„ä½œç”¨æ˜¯æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸

ğŸ’¡ï¼š`yield` çš„æ„æ€ï¼Ÿ

![yield](assets/img/2021-08-24-19-42-22.png)

â¹ï¼š[yield - JavaScript - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/yield)

---

ç†è§£äº†ç”Ÿæˆå™¨å‡½æ•°çš„ç‰¹ç‚¹ä»¥åŠå®ƒçš„æ‰§è¡Œè¿‡ç¨‹è¿‡åï¼Œä¸‹ä¸€æ­¥æ˜¯çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ Generator å»ç®¡ç†æˆ‘ä»¬çš„å¼‚æ­¥æµç¨‹

## â˜…Generator å¼‚æ­¥æ–¹æ¡ˆï¼ˆä¸­ï¼‰

> ä½“éªŒ Generator å‡½æ•°å¼‚æ­¥æ–¹æ¡ˆ

æˆ‘ä»¬å®Œå…¨å¯ä»¥å€ŸåŠ©äº`yield`å®ƒå¯ä»¥**æš‚åœç”Ÿæˆå™¨å‡½æ•°æ‰§è¡Œ**è¿™æ ·ä¸€ä¸ªç‰¹ç‚¹æ¥å»ä½¿ç”¨ç”Ÿæˆå™¨å‡½æ•°å»å®ç°ä¸€ä¸ªæ›´ä¼˜çš„å¼‚æ­¥ç¼–ç¨‹ä½“éªŒ

ğŸ’¡ï¼šå®šä¹‰ä¸€ä¸ª`ajax`å‡½æ•°

``` js
function ajax(url) {
  return new Promise((resolve, reject) => {
    var xhr = new XMLHttpRequest()
    xhr.open('GET', url)
    xhr.responseType = 'json'
    xhr.onload = () => {
      if (xhr.status === 200) {
        resolve(xhr.response)
      } else {
        reject(new Error(xhr.statusText))
      }
    }
    xhr.send()
  })
}
```

ğŸ‘‡ï¼šå…·ä½“å®ç°å§¿åŠ¿

![å®ç°](assets/img/2021-08-25-13-23-22.png)

1. å®šä¹‰ä¸€ä¸ªç”Ÿæˆå™¨å‡½æ•°`main`
2. åœ¨`main`é‡Œè¾¹ä½¿ç”¨`yield`å»è¿”å›ä¸€ä¸ª`ajax`è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è¿”å›ä¸€ä¸ª`Promise`å¯¹è±¡ -> æ¥æ”¶`yield`è¯­å¥çš„è¿”å›å€¼ï¼Œæ‰“å°è¿™ä¸ªå€¼
3. åœ¨å¤–ç•Œè°ƒç”¨`main` -> å¾—åˆ°ä¸€ä¸ªç”Ÿæˆå™¨å¯¹è±¡ -> è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„`next`æ–¹æ³• -> æ‰§è¡Œåˆ°ç”Ÿæˆå™¨å‡½æ•°é‡Œè¾¹ç¬¬ä¸€ä¸ª`yield`çš„ä½ç½®ï¼Œå³ä¼šæ‰§è¡Œç¬¬ä¸€ä¸ª`ajax`è°ƒç”¨ -> `next`è¿”å›å¯¹è±¡çš„`value`å°±æ˜¯`ajax`è°ƒç”¨æ‰€è¿”å›çš„`Promise`å¯¹è±¡ -> é€šè¿‡`then`å§¿åŠ¿æŒ‡å®šè¿™ä¸ª`Promise`å¯¹è±¡çš„å›è°ƒ -> åœ¨`then`çš„`cb`é‡Œè¾¹æ‹¿åˆ°è¿™ä¸ª`Promise`çš„æ‰§è¡Œç»“æœ`data` -> å†è°ƒç”¨ä¸€æ¬¡`next`ï¼ŒæŠŠ`data`ä½œä¸ºå‚æ•°ä¼ é€’ç»™`next`ï¼Œè¿™æ ·ä¸€æ¥`main`å‡½æ•°å°±å¯ä»¥æ¥ç€ç»§ç»­å¾€ä¸‹æ‰§è¡Œäº†ï¼Œè€Œä¸”è¿™ä¸ª`data`ä¼šä½œä¸ºå½“å‰è¿™ä¸ª`yield`çš„è¿”å›å€¼ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ‹¿åˆ°è¿™ä¸ª`result`çš„å€¼äº†

è¿™æ ·ä¸€æ¥ï¼Œå¯¹äº`Promise`å‡½æ•°çš„å†…éƒ¨ï¼Œæˆ‘ä»¬å°±å½»åº•æ¶ˆç­äº†`Promise`çš„å›è°ƒï¼Œæœ‰äº†ä¸€ç§è¿‘ä¹äºåŒæ­¥ä»£ç çš„ä½“éªŒ

åŒç†ï¼Œåœ¨`main`å‡½æ•°å½“ä¸­ï¼Œå†å»æ·»åŠ ä¸‹ä¸€ä¸ª`yield`æ“ä½œ

![æ·»åŠ  yield](assets/img/2021-08-25-13-59-13.png)

å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é€’å½’å§¿åŠ¿å»ä¸æ–­è¿­ä»£ï¼Œç›´åˆ°è¿”å›ç»“æœçš„`done`å±æ€§ä¸º`true`ï¼Œä¹Ÿå°±æ˜¯ç”Ÿæˆå™¨æ‰§è¡Œç»“æŸè¿‡åï¼Œæˆ‘ä»¬å°±ç»“æŸè¿™æ ·ä¸€ä¸ªé€’å½’

> ä¸ºäº†è®©`main`é‡Œè¾¹çš„ä»£ç åŒæ­¥æ‰§è¡Œï¼Œç»“æœæˆ‘ä»¬åœ¨å¤–ç•Œåˆä¼šåˆ°äº†å›è°ƒåœ°ç‹±â€¦â€¦

## â˜…Generator å¼‚æ­¥æ–¹æ¡ˆï¼ˆä¸‹ï¼‰

> é€’å½’æ‰§è¡Œ Generator å‡½æ•°

ç”¨é€’å½’çš„å§¿åŠ¿æ¥å®ç°ä¸€ä¸ªæ›´é€šç”¨çš„ç”Ÿæˆå™¨å‡½æ•°çš„æ‰§è¡Œå™¨

ğŸ’¡ï¼šåšæ³•

ç”¨ç”Ÿæˆå™¨å‡½æ•°å®Œæˆå¼‚æ­¥ç¼–ç¨‹ï¼š

![ç”Ÿæˆå™¨å‡½æ•°](assets/img/2021-08-25-15-14-39.png)

å¦‚ä½•è®©ç”Ÿæˆå™¨å‡½æ•°é‡Œè¾¹çš„ä»£ç çœ‹ä¼¼åœ¨åŒæ­¥æ‰§è¡Œï¼Ÿ

å®šä¹‰ä¸€ä¸ªå…³äºç”Ÿæˆå™¨å‡½æ•°çš„æ‰§è¡Œå™¨ï¼š

![ç”Ÿæˆå™¨å‡½æ•°çš„æ‰§è¡Œå™¨](assets/img/2021-08-25-15-12-08.png)

1. å®šä¹‰ä¸€ä¸ª`handleResult`å‡½æ•° -> æ¥æ”¶ä¸€ä¸ª`result`å‚æ•°ï¼ˆ`next`æ–¹æ³•æ‰€è¿”å›çš„`result`å¯¹è±¡ï¼‰
2. åˆ¤æ–­`result`çš„`done`å±æ€§æ˜¯å¦ä¸º`true` -> ç”Ÿæˆå™¨æ˜¯å¦å·²ç»ç»“æŸäº†ï¼Ÿ
   1. å¦‚æœç»“æŸäº†ï¼Œé‚£`handleResult`å‡½æ•°ä¹Ÿå°±æ²¡æœ‰ç»§ç»­å¾€ä¸‹æ‰§è¡Œäº†ï¼Œç›´æ¥`return`å°±å¥½äº†
   2. åä¹‹ï¼Œæ²¡æœ‰ç»“æŸï¼Œ`result`çš„`value`åº”è¯¥æ˜¯ä¸€ä¸ª`Promise`å¯¹è±¡ -> ä½¿ç”¨è¯¥å¯¹è±¡çš„`then`æ–¹æ³•å¤„ç†è¯·æ±‚ç»“æœ -> åœ¨è¯·æ±‚å›è°ƒå½“ä¸­ï¼Œç»§ç»­ä½¿ç”¨`next`ï¼Œè®©æˆ‘ä»¬çš„ç”Ÿæˆå™¨å‡½æ•°æ¥ç€å¾€ä¸‹æ‰§è¡Œï¼Œå¹¶ä¸”æŠŠå¾—åˆ°çš„æ•°æ®ä¼ é€’ç»™`next` -> `next`æ–¹æ³•æ‰€è¿”å›çš„åˆæ˜¯ä¸‹ä¸€ä¸ª`result`ï¼ŒåŒæ ·ï¼Œå†æ¬¡æŠŠå®ƒäº¤ç»™`handleResult`è¿›è¡Œé€’å½’
3. åœ¨å¤–ç•Œï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨ä¸€ä¸‹`handleResult`ï¼Œä¼ å…¥ç¬¬ä¸€æ¬¡`next`çš„ç»“æœå°±å¯ä»¥äº† -> åœ¨`handleResult`çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œåªè¦ç”Ÿæˆå™¨ä¸ç»“æŸï¼Œé‚£é€’å½’å°±ä¼šä¸€ç›´ä¸‹å»ï¼Œä¼šæŠŠæˆ‘ä»¬ç”Ÿæˆå™¨å‡½æ•°é‡Œè¾¹æ‰€æœ‰çš„å¼‚æ­¥è°ƒç”¨å…¨éƒ¨ä¾æ¬¡æ‰§è¡Œä¸‹å»
4. è¡¥å……ï¼šè¿˜è¦å¤„ç†`Promise`å¤±è´¥è¿‡åçš„å¤„ç†é€»è¾‘ï¼Œä¸ç„¶ï¼Œå°±ä¼šåœ¨æ§åˆ¶å°å‡ºç°æœªæ•è·çš„å¼‚å¸¸äº†
   1. åšæ³•å¾ˆç®€å•ï¼Œç›´æ¥åœ¨`Promise`å¯¹è±¡çš„`then`æ–¹æ³•ä¸­æ·»åŠ ä¸€ä¸ªå¤±è´¥å›è°ƒå°±å¥½äº† -> åœ¨å¤±è´¥å›è°ƒé‡Œè¾¹ï¼Œè°ƒç”¨ç”Ÿæˆå™¨å¯¹è±¡çš„`throw`æ–¹æ³•ï¼Œè®©ç”Ÿæˆå™¨å‡½æ•°ç»§ç»­æ‰§è¡Œæ—¶å¾—åˆ°ä¸€ä¸ªå¼‚å¸¸å°±å¯ä»¥äº† -> è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨`main`å‡½æ•°çš„å†…éƒ¨é€šè¿‡`try...catch`å§¿åŠ¿æ•è·è¿™æ ·ä¸€ä¸ªå¼‚å¸¸äº†ï¼Œæ•è·åå°±`log`å®ƒå‡ºæ¥

ä»¥ä¸Šè¿™ä¹ˆä¸€ä¸ªè¿‡ç¨‹ï¼Œå®é™…ä¸Šæˆ‘ä»¬å°±å®Œæˆäº†**ä¸€ä¸ªç”Ÿæˆå™¨å‡½æ•°çš„ä¸€ä¸ªæ‰§è¡Œå™¨**ï¼Œå¯¹äºç”Ÿæˆå™¨å‡½æ•°çš„è°ƒç”¨é€»è¾‘å®é™…ä¸Šæ˜¯**å®Œå…¨å¯ä»¥å¤ç”¨**çš„

æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒå°è£…æˆä¸€ä¸ªå…¬å…±çš„å‡½æ•°`co`ï¼Œè¯¥å‡½æ•°å†…éƒ¨æ¥æ”¶ä¸€ä¸ªç”Ÿæˆå™¨å‡½æ•°`generator`ï¼Œè¯¥å‡½æ•°å†…éƒ¨çš„æ‰§è¡Œé€»è¾‘å°±æ˜¯ä¸Šè¿°é‚£æ ·å¯¹æ•´ä¸ªç”Ÿæˆå™¨å‡½æ•°è¿›è¡Œæ‰§è¡Œ

![co](assets/img/2021-08-25-15-19-55.png)

ä¸‹ä¸€æ¬¡ä½¿ç”¨ç”Ÿæˆå™¨å‡½æ•°å»å®Œæˆå¼‚æ­¥ç¼–ç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ª`co`å‡½æ•°äº†

åƒè¿™æ ·çš„ç”Ÿæˆå™¨å‡½æ•°æ‰§è¡Œå™¨åœ¨ç¤¾åŒºå½“ä¸­ï¼Œæ—©å°±æœ‰ä¸€ä¸ªæ›´å®Œå–„çš„åº“äº†ï¼Œè¿™ä¸ªåº“å°±å«åš`co` -> ä½ å¯ä»¥è‡ªå·±å»å°è¯•ä½¿ç”¨ä¸€ä¸‹è¿™ä¸ª [åº“](https://github.com/tj/co)

è¿™ç§`co`çš„å¼‚æ­¥æ–¹æ¡ˆï¼Œå®é™…ä¸Šåœ¨ 15 å¹´ä¹‹å‰ï¼Œæ˜¯ç‰¹åˆ«æµè¡Œçš„ï¼Œåæ¥å› ä¸ºè¯­è¨€æœ¬èº«æœ‰äº†`async/await`è¿‡åï¼Œè¿™ç§æ–¹æ¡ˆç›¸å¯¹æ¥è®²å°±æ²¡æœ‰é‚£ä¹ˆæ™®åŠäº†ï¼Œä¸è¿‡ï¼Œä½¿ç”¨ Generator è¿™ç§å§¿åŠ¿æœ€æ˜æ˜¾çš„ä¸€ä¸ªå˜åŒ–å°±æ˜¯ã€Œè®©æˆ‘ä»¬çš„å¼‚æ­¥è°ƒç”¨å†æ¬¡å›å½’åˆ°æ‰å¹³åŒ–ã€ -> è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ JS å¼‚æ­¥ç¼–ç¨‹å‘å±•è¿‡ç¨‹å½“ä¸­å¾ˆé‡è¦çš„ä¸€æ­¥ï¼Œæ‰€ä»¥ä½ ä¸ä»…è¦äº†è§£å®ƒçš„ç”¨æ³•ï¼Œè¿˜åº”è¯¥å»ç†è§£å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„

> Generator å‡½æ•°å°±æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„å®¹å™¨ã€‚å®ƒçš„è‡ªåŠ¨æ‰§è¡Œéœ€è¦ä¸€ç§æœºåˆ¶ï¼Œå½“å¼‚æ­¥æ“ä½œæœ‰äº†ç»“æœï¼Œèƒ½å¤Ÿè‡ªåŠ¨äº¤å›æ‰§è¡Œæƒã€‚

å½“ç„¶ï¼Œæˆ‘ä»¬åœ¨æ—¥åçš„å¼€å‘è¿‡ç¨‹å½“ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½è¿˜æ˜¯ä¼šé€‰æ‹©æœ€æ–°çš„`async`å’Œ`await`çš„æ–¹å¼

## â˜…Async å‡½æ•°

> è¯­è¨€å±‚é¢çš„å¼‚æ­¥ç¼–ç¨‹æ ‡å‡†

![Async/Await](assets/img/2021-08-25-19-03-47.png)

æœ‰äº† Generator è¿‡åï¼ŒJS ä¸­çš„å¼‚æ­¥ç¼–ç¨‹åŸºæœ¬ä¸Šå°±å·²ç»ä¸åŒæ­¥æœ‰ç±»ä¼¼çš„ä½“éªŒäº†ï¼Œä½†æ˜¯ä½¿ç”¨ Generator è¿™ç§å¼‚æ­¥æ–¹æ¡ˆï¼Œæˆ‘ä»¬è¿˜éœ€è¦è‡ªå·±æ‰‹åŠ¨å»ç¼–å†™ä¸€ä¸ªæ‰§è¡Œå™¨å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸Šè¾¹å®šä¹‰çš„é‚£ä¸ª`co`å‡½æ•°ä¸€æ ·ï¼Œæ‰€ä»¥è¿™ä¼šæ¯”è¾ƒéº»çƒ¦å•Šï¼

è€Œåœ¨ ES2017 çš„æ ‡å‡†å½“ä¸­ï¼Œæ–°å¢äº†ä¸€ä¸ªå«åš `Async` çš„å‡½æ•°ï¼Œå®ƒåŒæ ·æä¾›äº†è¿™ç§æ‰å¹³åŒ–çš„å¼‚æ­¥ç¼–ç¨‹ä½“éªŒï¼Œè€Œä¸”å®ƒæ˜¯è¯­è¨€å±‚é¢æ ‡å‡†çš„å¼‚æ­¥ç¼–ç¨‹è¯­æ³•ï¼Œæ‰€ä»¥ä½¿ç”¨èµ·æ¥å°±ä¼šæ›´åŠ çš„æ–¹ä¾¿ä¸€ç‚¹

ä½ å¯ä»¥ç†è§£`Async`å‡½æ•°å°±æ˜¯ç”Ÿæˆå™¨å‡½æ•°ä¸€ç§æ›´æ–¹ä¾¿çš„è¯­æ³•ç³–ï¼Œæ‰€ä»¥åœ¨è¯­æ³•ä¸Š `Async` å‡½æ•°è·Ÿ`Generator`å‡½æ•°æ˜¯éå¸¸ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠç”Ÿæˆå™¨å‡½æ•°ä¿®æ”¹ä¸ºä¸€ä¸ªä½¿ç”¨`async`å…³é”®è¯å»ä¿®é¥°çš„æ™®é€šå‡½æ•°ï¼Œç„¶ååœ¨è¿™å‡½æ•°å†…éƒ¨æŠŠæ‰€æœ‰çš„`yield`å…³é”®è¯ç»™æ›¿æ¢æˆ`await`å°±å¯ä»¥äº†ï¼Œè‡³æ­¤ï¼Œè¿™æ ·ä¸€ä¸ªå‡½æ•°å°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„`Async`å‡½æ•°äº†

![Async å‡½æ•°](assets/img/2021-08-25-20-03-17.png)

>  `await` åªåœ¨å¼‚æ­¥å‡½æ•°é‡Œé¢æ‰èµ·ä½œç”¨ã€‚å®ƒå¯ä»¥æ”¾åœ¨ä»»ä½•å¼‚æ­¥çš„ï¼ŒåŸºäº `promise` çš„å‡½æ•°ä¹‹å‰ã€‚å®ƒä¼šæš‚åœä»£ç åœ¨è¯¥è¡Œä¸Šï¼Œç›´åˆ° `promise` å®Œæˆï¼Œç„¶åè¿”å›ç»“æœå€¼ã€‚åœ¨æš‚åœçš„åŒæ—¶ï¼Œå…¶ä»–æ­£åœ¨ç­‰å¾…æ‰§è¡Œçš„ä»£ç å°±æœ‰æœºä¼šæ‰§è¡Œäº†ã€‚
> 
> ä½ å¯ä»¥åœ¨è°ƒç”¨ä»»ä½•è¿”å›`Promise`çš„å‡½æ•°æ—¶ä½¿ç”¨ `await`ï¼ŒåŒ…æ‹¬ Web API å‡½æ•°ã€‚

å®šä¹‰å¥½è¿™ä¸ª`Async`å‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åœ¨å¤–è¾¹å»è°ƒç”¨è¿™ä¸ªå‡½æ•°äº†ï¼Œæ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œå…¶å†…éƒ¨æ‰§è¡Œè¿‡ç¨‹è·Ÿæˆ‘ä»¬å†™çš„`Generator`å‡½æ•°æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œæ‰€ä»¥å®ƒçš„æ•ˆæœä¹Ÿæ˜¯å®Œå…¨ä¸€è‡´çš„

ç›¸æ¯”äº`Generator`ï¼Œ`Async`å‡½æ•°æœ€å¤§çš„å¥½å¤„å°±æ˜¯å®ƒä¸éœ€è¦å†å»é…åˆä¸€ä¸ªç±»ä¼¼`co`è¿™æ ·çš„æ‰§è¡Œå™¨ï¼Œå› ä¸ºå®ƒæ˜¯**è¯­è¨€å±‚é¢çš„æ ‡å‡†å¼‚æ­¥ç¼–ç¨‹è¯­æ³•**ï¼Œå…¶æ¬¡`Async`å‡½æ•°ï¼Œ**å®ƒå¯ä»¥ç»™æˆ‘ä»¬è¿”å›ä¸€ä¸ª`Promise`å¯¹è±¡**ï¼Œè€Œè¿™æ ·å°±æ›´åŠ åˆ©äºæˆ‘ä»¬å¯¹æ•´ä½“ä»£ç è¿›è¡Œæ§åˆ¶

é™¤æ­¤ä¹‹å¤–ï¼Œå…³äº`Async`å‡½æ•°ï¼Œè¿˜æœ‰ä¸€ä¸ªéœ€è¦æˆ‘ä»¬æ³¨æ„çš„ç‚¹ï¼Œé‚£å°±æ˜¯`Async`å‡½æ•°å½“ä¸­ä½¿ç”¨çš„è¿™ä¸ª`await`å…³é”®è¯ï¼Œå®ƒåªèƒ½å¤Ÿå‡ºç°`Async`å‡½æ•°å†…éƒ¨ï¼Œå®ƒä¸èƒ½ç›´æ¥åœ¨å¤–éƒ¨ï¼Œä¹Ÿå°±æ˜¯æœ€é¡¶å±‚ä½œç”¨åŸŸå»ä½¿ç”¨

ä¸è¿‡ï¼Œå…³äºåœ¨æœ€å¤–å±‚ç›´æ¥å»ä½¿ç”¨`await`çš„åŠŸèƒ½ç°åœ¨å·²ç»åœ¨å¼€å‘äº†ï¼Œä¸ä¹…ä»¥åå°±æœ‰å¯èƒ½ä¼šå‡ºç°åœ¨æ ‡å‡†å½“ä¸­ï¼Œåˆ°æ—¶å€™æˆ‘ä»¬å»ä½¿ç”¨`Async`å‡½æ•°å°±ä¼šæ›´åŠ æ–¹ä¾¿ä¸€äº›äº†

ä»¥ä¸Šï¼Œå°±æ˜¯æˆ‘ä»¬å¯¹`Async`å‡½æ•°çš„ä¸€ä¸ªåŸºæœ¬äº†è§£äº†ï¼Œå¦‚æœä½ äº†è§£äº†ç”Ÿæˆå™¨çš„å¼‚æ­¥æ–¹æ¡ˆï¼Œé‚£`Async`å‡½æ•°åªæ˜¯åœ¨å†™æ³•ä¸Šæœ‰ç•¥å¾®çš„å·®å¼‚ç½¢äº†ï¼Œå…¶ä»–æ‰€æœ‰çš„ä¸œè¥¿éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥`Async`å‡½æ•°ä¹Ÿæ²¡æœ‰ä»€ä¹ˆæˆ‘ä»¬å€¼å¾—å»æ·±ç©¶çš„ä¸œè¥¿â€¦â€¦

ğŸ’¡ï¼š`Async`å‡½æ•°çš„æ‰§è¡Œæµç¨‹ï¼Ÿ

![Async å‡½æ•°](assets/img/2021-08-25-20-17-23.png)

> å…¶å®å’Œä¹‹å‰çš„`handleResult(g.next())`ä¸€æ ·ï¼Œ`Async`å‡½æ•°è°ƒç”¨çš„æ—¶å€™ï¼Œç›¸å½“äºæ‰§è¡Œäº†ç¬¬ä¸€ä¸ª`next`ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ª`await`ä¹‹å‰çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯å‘é€äº†ä¸€æ¬¡`ajax`è¯·æ±‚

å¦‚æœä½ åœ¨`Async`å‡½æ•°é‡Œè¾¹ä¸å†™`try...catch`ï¼Œé‚£ä¹ˆå°±ä¼šäº¤ç»™`promise`çš„å¤±è´¥å›è°ƒå»å¤„ç†

![ä¸è¦ try catch](assets/img/2021-08-25-20-32-27.png)

> å»ºè®®ç”¨`Promise`å¯¹è±¡çš„`catch`æ–¹æ³•æ•è·å¼‚å¸¸

ğŸ’¡ï¼šå…³äº `Async` å‡½æ•°æ€§èƒ½ï¼Ÿ

![Async æ€§èƒ½](assets/img/2021-08-25-20-57-03.png)

æ³¨æ„ï¼Œç”¨`Async`å†™å¼‚æ­¥ä»£ç è¦æ¯”`Promise.then(cb)`é‚£æ ·ä¼ å›è°ƒçš„å§¿åŠ¿æ€§èƒ½è¦å¥½ï¼Œä¸å»ºè®®ç”¨ Babel ç¼–è¯‘`Async`å‡½æ•° -> åŸå› æ˜¯ä½¿å¾— JavaScript å¼•æ“ä»¥æ›´é«˜çš„æ€§èƒ½å’Œæ›´é«˜çš„å†…å­˜æ•ˆç‡å§¿åŠ¿å»å¤„ç†å †æ ˆè·Ÿè¸ªï¼ˆåœ¨æ•è·é”™è¯¯æ—¶ï¼Œ`Promise`å§¿åŠ¿çš„æŠ¥é”™ä½ç½®è·Ÿè¸ªæ˜¯å¾ˆè€—æ€§èƒ½çš„ï¼‰

â¹ï¼š[Asynchronous stack traces: why await beats Promise#then() Â· Mathias Bynens](https://mathiasbynens.be/notes/async-stack-traces)

ğŸ’¡ï¼š`await`æ“ä½œç¬¦ï¼Ÿ

`await` æ“ä½œç¬¦ç”¨äºç­‰å¾… `Promise`ã€‚å®ƒåªèƒ½åœ¨å¸¸è§„ JavaScript ä»£ç ä¸­çš„`Async` å‡½æ•°ä¸­ä½¿ç”¨ï¼›ç„¶è€Œï¼Œå®ƒä¹Ÿå¯ä»¥ä¸ JavaScript æ¨¡å—ä¸€èµ·å•ç‹¬ä½¿ç”¨ã€‚

![await](assets/img/2021-08-25-21-22-31.png)

æ³¨æ„ï¼Œåªè¦æœ‰`await`ç­‰å¾…çš„`Promise`è¿”å›çš„`rejected`æ€ï¼Œé‚£`Async`å‡½æ•°å°±ä¸ä¼šç»§ç»­å¾€ä¸‹èµ°äº†ï¼Œè€Œ`Async`å‡½æ•°çš„`Promise`æ€ä¹Ÿå°±ç¡®å®šä¸º`rejected`æ€äº†

`await`ä¸åœ¨`Async`å‡½æ•°é‡Œè¾¹ä½¿ç”¨ï¼Œåªèƒ½åœ¨ ES6 æ¨¡å—é‡Œè¾¹ä½¿ç”¨ï¼Œä¸èƒ½ç”¨åœ¨ CommonJS æ¨¡å—ã€‚è¿™æ˜¯å› ä¸º CommonJS æ¨¡å—çš„`require()`æ˜¯åŒæ­¥åŠ è½½ï¼Œå¦‚æœæœ‰é¡¶å±‚`await`ï¼Œå°±æ²¡æ³•å¤„ç†åŠ è½½äº†

æµ‹è¯•ä»£ç ï¼š

![await](assets/img/2021-08-25-22-01-37.png)

è¯·æ±‚æƒ…å†µï¼š

![è¯·æ±‚æƒ…å†µ](assets/img/2021-08-25-22-04-27.png)

`index.js`ä¼šå…ˆæ‰§è¡Œ`import`ä»£ç ï¼Œç­‰è¿™ä¸¤ä¸ª`import`è¯·æ±‚å®Œæˆå¹¶ä¸”æ‰§è¡Œå®Œï¼Œä¹Ÿå°±æ˜¯è¿™ä¸¤ä¸ªæ¨¡å—å…ˆ`export`å®Œï¼Œæ‰ä¼šå»æ‰§è¡Œ`index.js`é‡Œè¾¹é`import`çš„ä»£ç 

å»æ‰`await`ï¼š

![å»æ‰ await](assets/img/2021-08-25-22-09-03.png)

ä¸ºå•¥ä¼šè¿™æ ·å‘¢ï¼Ÿ -> å› ä¸ºæˆ‘ä»¬å¿«é€Ÿå¯¼å‡ºäº†ä¸€ä¸ªç­‰å¾…æ€çš„`Promise`å¯¹è±¡å•Šï¼

è¦æ‹¿åˆ°è¿™ä¸ª`posts`ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨`then`å°±å¥½äº†ï¼š

![cb](assets/img/2021-08-25-22-13-08.png)

é¢â€¦â€¦å‡ºç°äº†ç‰¹æ®Šæƒ…å†µï¼š

![cb2](assets/img/2021-08-25-22-19-23.png)

åŸå› ï¼š

![fetch ä½¿ç”¨](assets/img/2021-08-25-22-31-11.png)

> `ajax`æ˜¯æˆ‘ä»¬ä¹‹å‰å°è£…çš„`ajax`æ–¹æ³•

## â˜…äº†è§£æ›´å¤š

â¹ï¼š[async å’Œ await: è®©å¼‚æ­¥ç¼–ç¨‹æ›´ç®€å• - å­¦ä¹  Web å¼€å‘ - MDN](https://developer.mozilla.org/zh-CN/docs/Learn/JavaScript/Asynchronous/Async_await)

â¹ï¼š[co å‡½æ•°åº“çš„å«ä¹‰å’Œç”¨æ³• - é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿—](https://www.ruanyifeng.com/blog/2015/05/co.html)

â¹ï¼š[await - JavaScript - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await)